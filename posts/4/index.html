
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dark Matter in Cyberspace</title>
  <meta name="author" content="Li Chao">

  
  <meta name="description" content="场景：需要向/etc/default/docker文件追加一行文字： DOCKER_OPTS="$DOCKER_OPTS --registry-mirror=http://b53a2938.m.daocloud.io" 其中双引号和$是特殊字符，难度主要提现在如何转意这两个字符上。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leetschau.github.io/posts/4/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Dark Matter in Cyberspace" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dark Matter in Cyberspace</a></h1>
  
    <h2>The technical blog of Li Chao in Beijing</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="leetschau.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/26/001459/">Fabric中向文件写入特殊字符</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-05-26T00:14:59+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:14 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>场景：需要向/etc/default/docker文件追加一行文字：</p>

<pre><code>DOCKER_OPTS="$DOCKER_OPTS --registry-mirror=http://b53a2938.m.daocloud.io"
</code></pre>

<p>其中双引号和$是特殊字符，难度主要提现在如何转意这两个字符上。</p>

<p>普通用户通过Shell达到目标的方法是：</p>

<pre><code>echo "DOCKER_OPTS=\"\$DOCKER_OPTS --registry-mirror=http://b53a2938.m.daocloud.io\"" | sudo tee -a /etc/default/docker
</code></pre>

<p>root用户使用Shell的方法是：</p>

<pre><code>echo "DOCKER_OPTS=\"\$DOCKER_OPTS --registry-mirror=http://b53a2938.m.daocloud.io\"" &gt;&gt; /etc/default/docker
</code></pre>

<p>Fabric的实现方法是：</p>

<pre><code>sudo('echo "DOCKER_OPTS=\\\\"\\\$DOCKER_OPTS '
     '--registry-mirror=http://b53a2938.m.daocloud.io\\\\"" '
     '&gt;&gt; /etc/default/docker')
</code></pre>

<p>或者用raw string:</p>

<pre><code>sudo(r'echo "DOCKER_OPTS=\\"\\$DOCKER_OPTS --registry-mirror='
     r'http://b53a2938.m.daocloud.io\\"" &gt;&gt; /etc/default/docker')
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/24/204911/">使用flake8做Python Linter</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-05-24T20:49:11+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今天写Python脚本时遇到一个问题，重构代码时，修改了一个变量名，
但只改了正常分支中的，忘了改错误处理分支中的，由于没有Linter做未定义变量检查，
bug在本机测试时并没有被发现，直到被push到remote repo，
在Jenkins job里运行几次出错后才被发现。
解决方案是安装flake8以及vim插件。</p>

<p>For Python 2.x: <code>pip install flake8</code>，
vim的syntastic插件不需要配置。</p>

<p>For Python 3.x，首先要安装flake8 for Python 3.x:</p>

<pre><code>sudo apt-get install python3-pip
sudo pip3 install flake8
</code></pre>

<p>命令行中检查文件命令：<code>python3 -m pyflakes syncRecurrences.py</code>.</p>

<p>配置vim语法检查的方法是在.vimrc文件里增加一下配置项：</p>

<pre><code>let g:syntastic_python_python_exec = '/usr/bin/python3'
let g:syntastic_python_flake8_exec = 'python3'
let g:syntastic_python_flake8_args = ['-m', 'flake8']
</code></pre>

<p>配置好后用vim打开python脚本，保存文件后，在未声明的变量行上会出现下面的错误信息：</p>

<pre><code>undefined name 'objId' [F821]
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/11/184550/">Jenkins的版本控制</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-05-11T18:45:50+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:45 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这里使用<a href="http://bit.ly/1NqkLkz">SCM Sync configuration plugin</a>
实现Jenkins各项配置的版本控制。</p>

<p>在gitlab上创建了代码库：git@gitlab.com:leechau/newfairs-jenkins.git</p>

<p>安装这个插件后，在 [Manage Jenkins -> System Information -> System Properties ->
user.name] 里查到Jenins系统的用户名，一般是jenkins，只有创建了这个用户的ssh key，
下面指定Git repo时才能连接成功，登录Jenkins服务器运行：</p>

<pre><code>su - jenkins
ssh-keygen
git config --global user.name 'Li Chao'
git config --global user.email 'leechau@126.com'
</code></pre>

<p>将<code>cat .ssh/id_rsa.pub</code>的输出加入到Gitlab的
[Profile settings -> SSH Keys] 里（在右上角搜索框里直接搜索ssh keys）；</p>

<p>删除$JENKINS_HOME/plugins下面所有git开头的插件，重启Jenkins服务；
安装Jenkins的Git插件。配置Jenkins的远端版本库：
[Manage Jenkins -> Config System -> SCM Sync configuration -> Git ->
Repo URL: git@gitlab.com:leechau/newfairs-jenkins.git]</p>

<p>要从版本库恢复Jenkins配置文件，使用 [Manage Jenkins -> Config System ->
SCM Sync configuration -> Reload config from SCM: Reload]
这个插件在 $JENKINS_HOME/scm-sync-configuration/checkoutConfiguration 中
创建了git repo。</p>

<p>怎样将Jenkins的状态返回到之前的某个commit？</p>

<p>这个插件会在Jenkins Web页面的底部加上 SCM Sync status 提示，
但似乎不太准，比如现在它显示同步失败，但代码库提交历史显示配置能够正常保存并
被push到远端库。</p>

<p>其他：</p>

<p>Ubuntu 16.04居然没有预装Python：</p>

<pre><code>apt install python
apt install python-pip
export LC_ALL=en_US.UTF-8
pip install requests
</code></pre>

<p>下午安装的Git插件时，由于本地还没有配置好git用户名和email，
安装过程中出现空指针异常，整个Jenkins服务整个无法启动，
到服务器上plugins文件夹下删除了<code>git*</code>后，重启服务才正常；</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/29/104211/">基于Flask的Python微服务</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-29T10:42:11+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:42 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>收发JSON报文</h1>

<p>下面基于Flask实现了最简单的JSON报文收发功能，收到请求后打印出内容，
重新组织后返回给客户端。
使用Flask的request.get_json()接收HTTP POST中的JSON报文，
使用json.dumps()发送JSON报文：</p>

<p>创建并启动服务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat &lt;&lt; EOF &gt; server.py
</span><span class='line'>from flask import Flask, request
</span><span class='line'>import json
</span><span class='line'>
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>
</span><span class='line'>@app.route('/api/&lt;user&gt;/&lt;uuid&gt;', methods=['GET', 'POST'])
</span><span class='line'>def add_message(user, uuid):
</span><span class='line'>  content = request.get_json()
</span><span class='line'>  print(content)
</span><span class='line'>  return json.dumps({"user": user, "uuid": uuid})
</span><span class='line'>
</span><span class='line'>if __name__ == '__main__':
</span><span class='line'>  app.run(host= '0.0.0.0', port=3000, debug=True)
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>python server.py</span></code></pre></td></tr></table></div></figure>


<p>用httpie和jq测试：
<code>http POST localhost:3000/api/chad/097aa543 head:='{"a1":"bb","c3":"dd"}' body=theBody | jq '.user'</code></p>

<h1>一个简单的Python微服务实现</h1>

<p>下面这个服务接收HTTP请求发送来的shell脚本，执行之，并根据用户需求返回控制台输出。
为了保证服务器的安全，生产环境中的这类服务需要校验客户端身份，
并为传入的命令设置白名单。</p>

<p>服务器接收的url包括mode和uuid两个字段，mode分exec和poll两种情况，
前者要求服务器开始执行Post body中的指令，后者查看当前运行指令的控制台输出。
uuid可以用于验证客户端合法性，例如客户端以"调用者+时间戳"并加密后生成uuid，
服务器验证调用者和时间戳的有效性。</p>

<p>服务端的配置项包括服务监听的端口以及返回控制台输出的行数。</p>

<p>创建并启动服务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat &lt;&lt; EOF &gt; server.py
</span><span class='line'>from flask import Flask, request
</span><span class='line'>import json
</span><span class='line'>from subprocess import Popen, PIPE
</span><span class='line'>from threading import Thread
</span><span class='line'>from queue import Queue
</span><span class='line'>
</span><span class='line'>PORT = 3000
</span><span class='line'>CMD_LINE_NUM = 3
</span><span class='line'>
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>output_q = Queue(CMD_LINE_NUM)
</span><span class='line'>cmd_q = []
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>def save_newest_output(p, queue, cmds):
</span><span class='line'>    while p.poll() is None:
</span><span class='line'>        line = p.stdout.readline().decode().strip()  # blocking read
</span><span class='line'>        if queue.full():
</span><span class='line'>            queue.get()   # abandon old output silently
</span><span class='line'>        queue.put(line)
</span><span class='line'>    cmds.clear()
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>@app.route('/api/&lt;mode&gt;/&lt;uuid&gt;', methods=['GET', 'POST'])
</span><span class='line'>def run_cmd(mode, uuid):
</span><span class='line'>    if mode == 'exec':
</span><span class='line'>        if len(cmd_q) &gt; 0:
</span><span class='line'>            return json.dumps({"mode": mode, "status": "busy"})
</span><span class='line'>        cmd = request.get_json()['cmd']
</span><span class='line'>        proc = Popen(cmd, shell=True, stdout=PIPE)
</span><span class='line'>        cmd_q.append(proc)
</span><span class='line'>        t = Thread(target=save_newest_output, args=(proc, output_q, cmd_q))
</span><span class='line'>        t.daemon = True
</span><span class='line'>        t.start()
</span><span class='line'>        return json.dumps({"mode": mode, "status": "accepted"})
</span><span class='line'>    if mode == 'poll' and len(cmd_q) &gt; 0:
</span><span class='line'>        lines = []
</span><span class='line'>        while not output_q.empty():
</span><span class='line'>            line = output_q.get_nowait()
</span><span class='line'>            lines.append(line)
</span><span class='line'>        return json.dumps({"mode": mode,
</span><span class='line'>                           "status": "running",
</span><span class='line'>                           "output": '\n'.join(lines)
</span><span class='line'>                           })
</span><span class='line'>    return json.dumps({"mode": mode, "status": "finished"})
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>if __name__ == '__main__':
</span><span class='line'>    app.run(host='0.0.0.0', port=PORT, debug=True)
</span><span class='line'>EOF
</span><span class='line'>python server.py</span></code></pre></td></tr></table></div></figure>


<p>Shell脚本在一个单独的进程中运行，并由一个独立的Thread读取它的输出，
保证HTTP服务不会被阻塞。</p>

<p>测试客户端：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat &lt;&lt; EOF &gt; test.py 
</span><span class='line'>from time import sleep
</span><span class='line'>for i in range(28, 49):
</span><span class='line'>    print(i, flush=True)
</span><span class='line'>    sleep(2)
</span><span class='line'>EOF
</span><span class='line'>http POST localhost:3000/api/exec/097aa543 cmd='python3 test.py'    # accepted
</span><span class='line'>http POST localhost:3000/api/exec/097aa543 cmd='python3 test.py'    # busy
</span><span class='line'>http POST localhost:3000/api/poll/097aa543         # realtime output: 30, 31, 32
</span><span class='line'>sleep 10
</span><span class='line'>http POST localhost:3000/api/poll/097aa543         # realtime output: 37, 38, 39
</span><span class='line'>sleep 40
</span><span class='line'>http POST localhost:3000/api/poll/097aa543         # status: finished
</span><span class='line'>http POST localhost:3000/api/exec/097aa543 cmd='python3 test.py'    # accepted</span></code></pre></td></tr></table></div></figure>


<p>为了保证输出不会被缓存，需要在print函数中增加<code>flush=True</code>，只有Python 3支持，
所以运行测试脚本时需要用<code>python3 test.py</code>.</p>

<p>在Python 3.4.3, Flask 0.10.1上测试通过。</p>

<h1>服务管理</h1>

<p>这里使用<a href="http://supervisord.org/">Supervisor</a>管理Python进程，
相比于Monit, start-stop-daemon等工具，它的优点是不依赖pidfile，配置方便，
提供日志输出，文档写得好。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/28/070323/">部署Python Web应用</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-28T07:03:23+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>7:03 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>部署流程</h1>

<h2>新部署</h2>

<p>部署过程分为以下步骤：</p>

<ol>
<li><p>安装依赖组件：git, pip, virtualenv, uwsgi</p></li>
<li><p>clone代码库(git clone)；</p></li>
<li><p>在源代码文件夹里创建wsgi.py和uwsgi.ini文件作为uwsgi的入口和环境定义文件，
这两个文件不要加入到版本控制系统中；</p></li>
<li><p>创建服务启动脚本/etc/init/myapp.conf，启动服务；</p></li>
<li><p>创建nginx服务实例：绑定监听端口，指向上一步生成的unix socket；</p></li>
<li><p>测试并重启nginx服务。</p></li>
</ol>


<h2>代码更新</h2>

<ol>
<li><p>同步代码：<code>git pull</code>;</p></li>
<li><p>重启服务：<code>sudo restart myapp</code>.</p></li>
</ol>


<h1>部署示例</h1>

<p>以下步骤基于<a href="http://do.co/1StnidM">How To Set Up uWSGI and Nginx to Serve Python Apps on Ubuntu 14.04</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo aptitude install python-dev python-pip nginx
</span><span class='line'>sudo pip install virtualenv
</span><span class='line'>mkdir -p ~/test/myapp
</span><span class='line'>cd ~/test/myapp
</span><span class='line'>virtualenv myappenv
</span><span class='line'>source myappenv/bin/activate
</span><span class='line'>pip install uwsgi
</span><span class='line'>cat &lt;&lt; EOF &gt; wsgi.py
</span><span class='line'>def application(environ, start_response):
</span><span class='line'>    start_response('200 OK', [('Content-Type', 'text/html')])
</span><span class='line'>    return ["&lt;h1 style='color:blue'&gt;Hello There!&lt;/h1&gt;"]
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'># uwsgi --socket 0.0.0.0:8080 --protocol=http -w wsgi
</span><span class='line'>deactivate
</span><span class='line'>cat &lt;&lt; EOF &gt; myapp.ini
</span><span class='line'>[uwsgi]
</span><span class='line'>module = wsgi:application
</span><span class='line'>
</span><span class='line'>master = true
</span><span class='line'>processes = 5
</span><span class='line'>
</span><span class='line'>socket = myapp.sock
</span><span class='line'>chmod-socket = 664
</span><span class='line'>vacuum = true
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>sudo cat &lt;&lt; EOF &gt; /etc/init/myapp.conf
</span><span class='line'>description "uWSGI instance to serve myapp"
</span><span class='line'>
</span><span class='line'>start on runlevel [2345]
</span><span class='line'>stop on runlevel [!2345]
</span><span class='line'>
</span><span class='line'>setuid your-user-name
</span><span class='line'>setgid www-data
</span><span class='line'>
</span><span class='line'>script
</span><span class='line'>cd /home/your-user-name/test/myapp
</span><span class='line'>. myappenv/bin/activate
</span><span class='line'>uwsgi --ini myapp.ini
</span><span class='line'>end script
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>sudo start myapp
</span><span class='line'># ps aux|grep myapp
</span><span class='line'># sudo stop myapp
</span><span class='line'>
</span><span class='line'>sudo cat &lt;&lt; EOF &gt; /etc/nginx/sites-available/myapp
</span><span class='line'>server {
</span><span class='line'>    listen 8080;
</span><span class='line'>    server_name 192.168.100.201;
</span><span class='line'>
</span><span class='line'>    location / {
</span><span class='line'>        include         uwsgi_params;
</span><span class='line'>        uwsgi_pass      unix:/home/your-user-name/test/myapp/myapp.sock;
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>sudo ln -s /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled
</span><span class='line'>sudo nginx -t
</span><span class='line'>sudo nginx -s reload</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/19/120234/">Option类型的实现方法比较</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-19T12:02:34+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Scala的Option类型定义在
<a href="https://github.com/scala/scala">scala/scala</a>的src/library/scala/Option.scala中：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sealed abstract class Option[+A]
</span><span class='line'>final case class Some[+A](x: A) extends Option[A]
</span><span class='line'>case object None extends Option[Nothing]</span></code></pre></td></tr></table></div></figure>


<p>对应的Haskell定义是： <code>data Maybe a = Nothing | Just a</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/15/171843/">几种常用语言处理文本的效率比较</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-15T17:18:43+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>5:18 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>读一个37264行，大小为81MB的文本文件f4.json，计算每行的单词数，然后打印出总单词数，
Python用时0.16秒，Ruby用时1.16秒，Haskell用时13.4秒，分别差一个数量级。
下面是测试脚本和过程：</p>

<p>wordcount.py:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>inp = 'f4.json'
</span><span class='line'>counts = []
</span><span class='line'>with open(inp) as f:
</span><span class='line'>  for line in f:
</span><span class='line'>    counts.append(len(line.split()))
</span><span class='line'>print(sum(counts))</span></code></pre></td></tr></table></div></figure>


<p>wordcount.rb:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>inp = 'f4.json'
</span><span class='line'>words = []
</span><span class='line'>File.open(inp).each do |line|
</span><span class='line'>  words.push(line.split.size)
</span><span class='line'>end
</span><span class='line'>puts words.reduce(0, :+)</span></code></pre></td></tr></table></div></figure>


<p>WordCount.hs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>main :: IO ()
</span><span class='line'>main = do
</span><span class='line'>input &lt;- readFile "f4.json"
</span><span class='line'>print $ sum(countWords input)
</span><span class='line'>
</span><span class='line'>countWords input = map (length.words) (lines input)</span></code></pre></td></tr></table></div></figure>


<p>测试过程：
```
wc -l f4.json
37264 f4.json</p>

<p>time python wordcount.py
1103404
python wordsum.py  0.14s user 0.01s system 99% cpu 0.157 total</p>

<p>time ruby wordsum.rb
1103404
ruby wordsum.rb  1.13s user 0.02s system 99% cpu 1.158 total</p>

<p>time runhaskell Main.hs
1105752
runhaskell wordcount.hs  12.64s user 0.76s system 100% cpu 13.395 total</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/12/094707/">青云的告警监控系统</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-12T09:47:07+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:47 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>首席创建通知列表：</p>

<p>在[控制台 -> 通知列表]中[创建]一个[通知列表]："网站连接超时"</p>

<p>然后创建告警策略：</p>

<p>在[控制台 -> 管理 -> 告警监控]中[创建]一个[告警策略]，
名称：网站不能连接
资源类型：负载均衡监听器-HTTP协议
规则：[响应延迟时间] > 1000毫秒
通知列表："网站连接超时"</p>

<p>监控资源：选择对应的负载均衡器。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/09/204200/">Note About Rest Client</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-09T20:42:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:42 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>httpie + jq</h1>

<p><a href="https://github.com/jkbrzt/httpie">httpie</a> + <a href="https://stedolan.github.io/jq/">jq</a></p>

<p>前者是curl的增强版，后者用来处理httpie返回的json结果。</p>

<pre><code>http -b api.newfairs.com/Fair/_search query:='{ "match": { "nameZHCN": "中国上海国际栅栏护栏展览会暨研讨会" } }' size=5 fields:='["nameZHCN"]'
http -b api.newfairs.com/Fair/_search query:='{ "match": { "nameZHCN": "中国上海国际栅栏护栏展览会暨研讨会" } }' size=5 | jq '.hits.total'
http -b api.newfairs.com/Fair/_search query:='{ "match": { "nameZHCN": "中国上海国际栅栏护栏展览会暨研讨会" } }' size=5 | jq '.hits.hits[]._source.nameZHCN'
http -b api.newfairs.com/Fair/_search query:='{ "query": { "match": { "_id": "Ao3Ati9dvWBerBrn8" } } }' | jq '.hits.hits[]._source.nameZHCN'

http -b POST http://api.newfairs.com/Fair/_search query:='{"query":{"bool":{"must":[{"query_string":{"query":"五金机械"}}]}}}'|jq '.hits.hits[]._source.recurrence[].timeStart'   
</code></pre>

<p>-b 代表只显示response的body，不显示head，以方便后续jq进行下一步处理，
中括号代表array，例如<code>jq '.hits.hits[0]'</code>表示只显示第一个结果，
hits[]代表返回数组里的所有结果。</p>

<p>这二者结合fzf，可以实现Postman/Insomnia这类GUI工具的功能。</p>

<h1>Insomnia</h1>

<p><a href="http://insomnia.rest/">Insomnia</a>: Chrome App.</p>

<h2>Pros</h2>

<ul>
<li><p>Request和Response窗口是左右排列的，且宽度可以调节；</p></li>
<li><p>分级管理Request: Workspace -> Group -> Request，
只能同时打开一个Workspace，比Postman更整洁；</p></li>
<li><p>良好的快捷键支持，request body和环境变量编辑窗口中可以使用vi编辑模式；</p></li>
<li><p>可以为每个Workspace定义环境变量，然后在url中使用这些环境变量，见下面的演示；</p></li>
<li><p>按名称搜索request: 默认快捷键Ctrl-P;</p></li>
</ul>


<h2>Cons</h2>

<ul>
<li>没有云同步，只能本地import/export;</li>
</ul>


<h1>Postman</h1>

<p><a href="https://www.getpostman.com/">Postman</a>: Chrome App.</p>

<h2>Pros</h2>

<ul>
<li><p>分级管理request: Collection -> Folder -> Request，可以方便地搜索；
Collection实际就是高一级的Folder，当request数量多时，request面板会比较凌乱；</p></li>
<li><p>可以同步到云端，在不同机器上方便地同步；</p></li>
</ul>


<h2>Cons</h2>

<p>Request和Response窗口是上下排列的，当调试Post方法时，
打开的Body窗体基本占满了整个屏幕，而且是最小高度，不能再减小，
导致每次看response内容都要使用滚轮，非常不方便。</p>

<h1>Discussion</h1>

<h2>Insomnia的环境变量</h2>

<p>例如定义下面的环境变量：</p>

<pre><code>{
    "api_url": "http://api.newfairs.com",
    "inner_url": "http://192.168.100.24:9200/"
}
</code></pre>

<p>在request的url栏里可以这样定义url: <code>/Fair/_search</code>，
点击request名称后面的三角图标并选择"Export as cURL"，可以看到url被替换成了
<code>http://api.newfairs.com/Fair/_search</code>.</p>

<h2>其他类似工具</h2>

<p>Firefox插件：Poster, RESTED, REST Easy, RESTClient.
前三者都不具备多Request管理功能，无法保存多个Request.
RESTClient可以定义favorite，但没有单独的窗体，查看不方便。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/03/29/183444/">MongoDB Schema Analysis</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-29T18:34:44+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:34 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Use <a href="https://github.com/variety/variety-cli">variety/variety-cli</a> to
analysis mongodb schema.</p>

<h1>Install with npm</h1>

<p><code>npm install variety-cli -g</code>
If the command <code>variety</code> is conflict with
<a href="http://peterlevi.com/variety/">Variety the Wallpaper Changer</a>,
add <code>alias variety='/home/leo/apps/node-v5.4.1-linux-x64/bin/variety'</code>
into ~/.bash_aliases.</p>

<p>The production database is connected with
<code>mongo 192.168.10.89:27017/production -u user -p password</code>.
To analyze it, run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>variety production/Fair --host 192.168.10.89 --port <span class="m">27017</span> --username user --password password
</span></code></pre></td></tr></table></div></figure>


<p>Note you can&rsquo;t use <code>-u</code> instead of <code>--username</code> above.</p>

<h1>Run with mongo</h1>

<p>Download variety.js from it&rsquo;s repo and run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mongo 192.168.10.89:27017/production -u user -p password --eval <span class="s2">&quot;var collection = &#39;Fair&#39;&quot;</span> variety.js
</span><span class='line'>+------------------------------------------------------------------------------------------------------------------------------+
</span><span class='line'><span class="p">|</span> key                                              <span class="p">|</span> types                              <span class="p">|</span> occurrences <span class="p">|</span> percents               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> ------------------------------------------------ <span class="p">|</span> ---------------------------------- <span class="p">|</span> ----------- <span class="p">|</span> ---------------------- <span class="p">|</span>
</span><span class='line'><span class="p">|</span> _id                                              <span class="p">|</span> String                             <span class="p">|</span>        <span class="m">9316</span> <span class="p">|</span> 100.000000000000000000 <span class="p">|</span>
</span><span class='line'><span class="p">|</span> recurrence.XX._id                                <span class="p">|</span> String                             <span class="p">|</span>        <span class="m">9276</span> <span class="p">|</span>  99.570631172176902624 <span class="p">|</span>
</span><span class='line'><span class="p">|</span> recurrence.XX.timeStart                          <span class="p">|</span> String <span class="o">(</span>9180<span class="o">)</span>,Date <span class="o">(</span>116<span class="o">)</span>           <span class="p">|</span>        <span class="m">9275</span> <span class="p">|</span>  99.559896951481320571 <span class="p">|</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify it with mongo shell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mongo 192.168.10.89:27017/production -u dba -p password
</span><span class='line'>&gt; db.Fair.count<span class="o">()</span>
</span><span class='line'>9316
</span><span class='line'>&gt; db.Fair.find<span class="o">({</span><span class="s1">&#39;recurrence._id&#39;</span>: <span class="o">{</span><span class="nv">$exists</span>: <span class="nb">true</span><span class="o">}})</span>.count<span class="o">()</span>
</span><span class='line'>9276
</span><span class='line'>&gt; db.Fair.find<span class="o">({</span><span class="nv">$and</span>: <span class="o">[{</span><span class="s1">&#39;recurrence&#39;</span>: <span class="o">{</span><span class="nv">$exists</span>: <span class="nb">true</span><span class="o">}}</span>, <span class="o">{</span><span class="s1">&#39;recurrence._id&#39;</span>: <span class="o">{</span><span class="nv">$exists</span>: <span class="nb">false</span><span class="o">}}]})</span>.count<span class="o">()</span>
</span><span class='line'><span class="m">40</span>      // <span class="m">9316</span> - 9276
</span><span class='line'>&gt; db.Fair.find<span class="o">({</span><span class="s1">&#39;recurrence.timeStart&#39;</span>: <span class="o">{</span><span class="nv">$exists</span>: <span class="nb">true</span><span class="o">}})</span>.count<span class="o">()</span>
</span><span class='line'><span class="m">9275</span>    //
</span><span class='line'>&gt; db.Fair.find<span class="o">({</span><span class="nv">$and</span>: <span class="o">[{</span><span class="s1">&#39;recurrence._id&#39;</span>: <span class="o">{</span><span class="nv">$exists</span>: <span class="nb">true</span><span class="o">}}</span>, <span class="o">{</span><span class="s1">&#39;recurrence.timeStart&#39;</span>: <span class="o">{</span><span class="nv">$exists</span>: <span class="nb">false</span><span class="o">}}]})</span>.count<span class="o">()</span>
</span><span class='line'><span class="m">1</span>       // <span class="m">9276</span> - 9275
</span><span class='line'>&gt; db.Fair.find<span class="o">({</span><span class="s1">&#39;recurrence.timeStart&#39;</span>: <span class="o">{</span><span class="nv">$type</span>: <span class="m">2</span> <span class="o">}})</span>.count<span class="o">()</span>
</span><span class='line'>9180
</span><span class='line'>&gt; db.Fair.find<span class="o">({</span><span class="s1">&#39;recurrence.timeStart&#39;</span>: <span class="o">{</span><span class="nv">$type</span>: 9<span class="o">}})</span>.count<span class="o">()</span>
</span><span class='line'>116
</span><span class='line'>&gt; db.Fair.find<span class="o">({</span><span class="nv">$and</span>: <span class="o">[{</span><span class="s1">&#39;recurrence.timeStart&#39;</span>: <span class="o">{</span><span class="nv">$exists</span>: <span class="nb">true</span><span class="o">}}</span>, <span class="o">{</span><span class="s1">&#39;recurrence.timeStart&#39;</span>: <span class="o">{</span><span class="nv">$not</span>: <span class="o">{</span><span class="nv">$type</span>: 2<span class="o">}}}</span>, <span class="o">{</span><span class="s1">&#39;recurrence.timeStart&#39;</span>: <span class="o">{</span><span class="nv">$not</span>: <span class="o">{</span><span class="nv">$type</span>: 9<span class="o">}}}]})</span>.count<span class="o">()</span>
</span><span class='line'><span class="m">0</span>      // there<span class="err">&#39;</span>s no other data <span class="nb">type</span>, all you need to <span class="k">do</span> is converting String to Date
</span></code></pre></td></tr></table></div></figure>


<p>For type number, 2 means String, 9 means Date.
See their definitions in <a href="https://docs.mongodb.org/manual/reference/operator/query/type/">$type in MongoDB doc</a>.</p>

<p>Why 9180 + 116 > 9275? Because all the numbers here is the counts of fairs.
While in a single fair there are maybe many recurrences.
So if a fair has 2 recurrences, one&rsquo;s timeStart type is String,
and the other&rsquo;s type is Date,
it will be counted twice, both in 9180 and 116.</p>

<h1>Unify Schema</h1>

<p>We need convert the type of &ldquo;updatedAt&rdquo;, &ldquo;recurrence.$.timeStart&rdquo;
and &ldquo;recurrence.$.timeEnd&rdquo; from String to Date with mongo script below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>db.Fair.find<span class="o">({</span><span class="s1">&#39;recurrence.timeStart&#39;</span>: <span class="o">{</span><span class="nv">$type</span>: 2<span class="o">}})</span>.forEach<span class="o">(</span><span class="k">function</span><span class="o">(</span>fair<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  fair.recurrence.forEach<span class="o">(</span><span class="k">function</span><span class="o">(</span>rec<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span>typeof<span class="o">(</span>rec.timeStart<span class="o">)</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      rec.timeStart <span class="o">=</span> new Date<span class="o">(</span>rec.timeStart<span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">})</span><span class="p">;</span>
</span><span class='line'>  db.Fair.save<span class="o">(</span>fair<span class="o">)</span><span class="p">;</span>
</span><span class='line'><span class="o">})</span><span class="p">;</span>
</span><span class='line'>db.Fair.find<span class="o">({</span><span class="s1">&#39;recurrence.timeEnd&#39;</span>: <span class="o">{</span><span class="nv">$type</span>: 2<span class="o">}})</span>.forEach<span class="o">(</span><span class="k">function</span><span class="o">(</span>fair<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  fair.recurrence.forEach<span class="o">(</span><span class="k">function</span><span class="o">(</span>rec<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span>typeof<span class="o">(</span>rec.timeEnd<span class="o">)</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      rec.timeEnd <span class="o">=</span> new Date<span class="o">(</span>rec.timeEnd<span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">})</span><span class="p">;</span>
</span><span class='line'>  db.Fair.save<span class="o">(</span>fair<span class="o">)</span><span class="p">;</span>
</span><span class='line'><span class="o">})</span><span class="p">;</span>
</span><span class='line'>db.Fair.find<span class="o">({</span><span class="s1">&#39;updatedAt&#39;</span>: <span class="o">{</span><span class="nv">$type</span>: 2<span class="o">}})</span>.forEach<span class="o">(</span><span class="k">function</span><span class="o">(</span>fair<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  fair.updatedAt <span class="o">=</span> new Date<span class="o">(</span>fair.updatedAt<span class="o">)</span><span class="p">;</span>
</span><span class='line'>  db.Fair.save<span class="o">(</span>fair<span class="o">)</span><span class="p">;</span>
</span><span class='line'><span class="o">})</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/5">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/3">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/11/11/114228/">Ubuntu 14.04 Apt Update Failure</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/05/083438/">Use Matplotlib in Python 3 on Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/31/171345/">理解IP地址和CIDR</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/25/110137/">保证Docker的输入参数可执行</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/20/113258/">为vim增加undo功能</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leetschau">@leetschau</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leetschau',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Li Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
