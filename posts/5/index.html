
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dark Matter in Cyberspace</title>
  <meta name="author" content="Li Chao">

  
  <meta name="description" content="Add codes below to ~/.vimrc
and run vim +PluginClean +PluginInstall +qa: " JavaScript code folding
set foldmethod=syntax
set foldlevelstart=3
let &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leetschau.github.io/posts/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Dark Matter in Cyberspace" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dark Matter in Cyberspace</a></h1>
  
    <h2>A notes repository for Meteor.js, data mining, Linux, etc.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="leetschau.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/19/090450/">JavaScript Code Folding</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-19T09:04:50+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:04 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Add codes below to ~/.vimrc
and run <code>vim +PluginClean +PluginInstall +qa</code>:</p>

<pre><code>" JavaScript code folding
set foldmethod=syntax
set foldlevelstart=3
let javaScript_fold=1

Plugin 'pangloss/vim-javascript'
</code></pre>

<p>Frequently used folding shortcuts:</p>

<p>zr/zm: decrease/increase the foldlevel by one;</p>

<p>zR/zM: open/close all folds;</p>

<p>zo/zc: open/close fold at cursor;</p>

<p>zO/zC: open/close all folds;</p>

<p>Ref:</p>

<p><a href="http://stackoverflow.com/questions/4789605/how-do-i-enable-automatic-folds-in-vim">http://stackoverflow.com/questions/4789605/how-do-i-enable-automatic-folds-in-vim</a>
<a href="https://www.linux.com/learn/tutorials/442438-vim-tips-folding-fun">https://www.linux.com/learn/tutorials/442438-vim-tips-folding-fun</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/17/220931/">Vim Snippet Plugins</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-17T22:09:31+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:09 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Add codes below into ~/.vimrc:</p>

<pre><code>let g:UltiSnipsEditSplit='vertical'

Plugin 'mattn/emmet-vim'
Plugin 'SirVer/ultisnips'
Plugin 'honza/vim-snippets'
</code></pre>

<p>Run <code>vim +PluginClean +PluginInstall +qa</code>.
The folder of UltiSnips is about 6.1MB, emmet-vim is about 1.6MB.</p>

<p>Here <a href="https://github.com/mattn/emmet-vim">emmet-vim</a> is a html editing tool.
For example open a new html file with <code>html:5</code>, and press <code>&lt;C-y&gt;,</code>,
you get a full html skeleton, which means emmet installed OK.</p>

<p><a href="https://github.com/sirver/ultisnips">UltiSnips</a> is a vim snippet engine,
while <a href="https://github.com/honza/vim-snippets">vim-snippets</a> is a bunch of
snippets definitions.</p>

<p>Use <code>UltiSnipsEdit</code> to add a new snippet.
Use <code>cl&lt;TAB&gt;</code> in a js file, to make it expand to <code>console.log(...);</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/15/112116/">Search String Pattern in Git History</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-15T11:21:16+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:21 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><code>git log -p --all -G 'pattern'</code>: search a string in git history.</p>

<p>-G search for all editing activity with &ldquo;pattern&rdquo;,
while -S only search for creation and removal of &ldquo;pattern&rdquo;,
the results of -S is the subset of results of -G.</p>

<p>When the &ldquo;pattern&rdquo; is in the current commit,
there will be only 1 result of -S,
where the pattern is added into the texts.</p>

<p>When the &ldquo;pattern&rdquo; is removed in current commit,
there will be 2 results of -S:
the first (which is newer) is where the pattern is removed,
the second is where the pattern is added.</p>

<p>-p denotes &ndash;patch, which will print the editing details.
If you only want to know the commit name which deal with the &ldquo;pattern&rdquo;,
omit this option.</p>

<p>&ndash;all search in all branches.</p>

<p>Ref:</p>

<p><a href="http://stackoverflow.com/questions/4468361/search-all-of-git-history-for-a-string">Search all of Git history for a string?</a></p>

<p><a href="http://stackoverflow.com/questions/2839253/git-history-find-lost-line-by-keyword">Git history - find lost line by keyword</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/14/192323/">Tab and Session Management in Vim</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-14T19:23:23+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:23 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Session management is provided by <a href="https://github.com/tpope/vim-obsession">tpope/vim-obsession</a>.
Tab rename function is provided by <a href="https://github.com/gcmt/taboo.vim">gcmt/taboo.vim</a>.</p>

<p>In ~/.vimrc:</p>

<pre><code>" Customize tabline
hi TabLineFill term=bold cterm=bold ctermbg=0
hi TabLine ctermfg=Yellow

" Taboo
set sessionoptions+=tabpages,globals
cabbrev tr TabooRename

" tab switching shortcuts
noremap &lt;leader&gt;1 1gt
noremap &lt;leader&gt;2 2gt
noremap &lt;leader&gt;3 3gt
noremap &lt;leader&gt;4 4gt
noremap &lt;leader&gt;5 5gt
noremap &lt;leader&gt;6 6gt
noremap &lt;leader&gt;7 7gt
noremap &lt;leader&gt;8 8gt
noremap &lt;leader&gt;9 9gt
noremap &lt;leader&gt;0 :tablast&lt;cr&gt;

" Add these into Vundle section
Plugin 'gcmt/taboo.vim'
Plugin 'tpope/vim-obsession'
</code></pre>

<p>Now open file in a new tab with: <code>Ctrl-P</code>, select a file and <code>Ctrl-O, t</code>.
Open file in a virtical split window with: <code>Ctrl-P</code>, select a file and <code>Ctrl-O, v</code>.
Rename tab with: <code>:tr&lt;Space&gt;new name&lt;Enter&gt;</code>.
Jump to the 3rd window with <code>,3</code>.</p>

<p>Note:</p>

<p>I also tried <a href="https://github.com/xolox/vim-session">xolox/vim-session</a>,
but it can&rsquo;t persist tab name created by Taboo.</p>

<p>For tab easy switch, I&rsquo;ve tried <code>noremap &lt;unique&gt; &lt;C-1&gt; 1gt</code> based on
<a href="http://stackoverflow.com/questions/2005214/switching-to-a-particular-tab-in-vim">Switching to a particular tab in VIM</a>,
where changes M-Num to C-Num, because M-Num is assigned to tmux window switch.
However C-Num can&rsquo;t work,
see <a href="http://stackoverflow.com/questions/15849537/vimrc-mapping-for-control-key-not-working">.vimrc mapping for control key not working</a>
for explanations.
So I adopted <code>noremap &lt;leader&gt;1 1gt</code> style based on
<a href="http://superuser.com/questions/410982/in-vim-how-can-i-quickly-switch-between-tabs">In vim, how can I quickly switch between tabs?</a>.</p>

<p>Mapping long Ex commands with <code>cabbrev</code> is a very useful for convenient.
Use <Space> instead of <Tab> to enable abbreviation in <code>cabbrev</code>.
See <code>:h :ca</code>, <a href="http://stackoverflow.com/questions/117150/can-i-re-map-commands-in-vim">Can I (re-) map commands in vim?</a>
and <a href="http://stackoverflow.com/questions/3878692/aliasing-a-command-in-vim">Aliasing a command in vim</a>
for details.</p>

<p>With <code>cabbrev tr TabooRename</code>, you can use <code>:tr&lt;Space&gt;1:tests</code> to rename current tab into &ldquo;1:tests&rdquo;.
Here you have to add tab index manually to make <code>&lt;leader&gt;&lt;number&gt;</code> style switching more convenient.</p>

<p>To make tabline more readable,
I customized the color of it.
See <a href="http://stackoverflow.com/questions/4726882/how-do-you-change-the-background-color-of-the-empty-tab-space-in-vim">How do you change the background color of the empty tab space in vim?</a>
and <a href="http://stackoverflow.com/questions/7238113/customising-the-colours-of-vims-tab-bar">Customising the colours of vim&rsquo;s tab bar</a>
for details.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/06/122243/">Reaction Notes</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-06T12:22:43+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:22 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Accounts</h1>

<p>reaction-core的用户存在users表和Accounts表，下面是初始化Reaction后得到的Owner用户表结构。
用户与业务有关的信息存在Accounts表中，其余的放在了users表中，
server/methods/accounts.js:Accounts.onCreateUser()可以看到
Accounts中的用户是首先clone Meteor user，然后在上面添加新属性后insert到Accounts表中。
这里users中的用户作用有两个：</p>

<ul>
<li><p>基于Meteor accounts包管理用户的注册、验证、登录等动作；</p></li>
<li><p>基于alanning/meteor-roles定义用户角色；</p></li>
</ul>


<p>下面是从数据库中得到的一组实例：</p>

<pre><code>&gt; db.users.find().pretty()
{
  "_id" : "Jyt46yndz8e5tCWgN",
  "createdAt" : ISODate("2015-10-06T03:43:17.711Z"),
  "services" : {
    "password" : {
      "bcrypt" : "$2a$10$Oj.qa9YmYdQazg3WkvqlbOf2FM2.SI5V0a6Ar8kW8qGEc.dRhzHXe"
    }
  },
  "username" : "Owner",
  "emails" : [
    {
      "address" : "asy6nklv@localhost",
      "verified" : false,
      "provides" : "default"
    }
  ],
  "roles" : {
    "8jbLoDao7BaLhmCog" : [
      "guest",
      "account/profile",
      "owner",
      "admin",
      "dashboard",
      "dashboard/settings/shop",
      "dashboard/orders",
      "createProduct",
      "dashboard/accounts",
      "core",
      "shipping",
      "reaction-shipping",
      "paypal",
      "reaction-paypal",
      "braintree",
      "reaction-braintree",
      "stripe",
      "reaction-stripe",
      "authnet",
      "reaction-auth-net",
      "social",
      "reaction-social",
      "reactionAnalytics",
      "reaction-analytics"
    ],
    "__global_roles__" : [
      "owner",
      "admin",
      "dashboard"
    ]
  }
}

&gt; db.Accounts.find().pretty()
{
  "_id" : "Jyt46yndz8e5tCWgN",
  "createdAt" : ISODate("2015-10-06T03:43:17.733Z"),
  "emails" : [
    {
      "address" : "asy6nklv@localhost",
      "verified" : false,
      "provides" : "default"
    }
  ],
  "userId" : "Jyt46yndz8e5tCWgN",
  "shopId" : "8jbLoDao7BaLhmCog",
  "acceptsMarketing" : false,
  "state" : "new"
}
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/05/131004/">Meteor Development Environment on Windows</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-05T13:10:04+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:10 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you want develop Meteor on Windows machine,
it&rsquo;s inconvenient to install meteor, mongodb, vim, etc. on Windows.
My choice is use VM as develop environment.</p>

<p>First install <a href="https://www.virtualbox.org/">VirtualBox</a>, <a href="https://www.vagrantup.com/">Vagrant</a>,
<a href="http://executor.dk/">Executor</a>.</p>

<p>Add the Meteor Dev vagrant box to system <code>vagrant box add meteorBox mybox.box</code>.
The box is based on Ubuntu 14.04 LTS (Trusty), with provisioned Meteor, MongoDB, git, tmux,
vim and its plugins.</p>

<p>Create the VM: <code>vagrant init meteorBox</code>;</p>

<p>There are different SSH clients:</p>

<h1>MobaXterm</h1>

<p>Download <a href="http://mobaxterm.mobatek.net/">MobaXterm</a> and extract it to app folder,
say d:\Apps\MobaXterm_v7.7.</p>

<p>Create a new session in MobaXterm named &ldquo;localvm&rdquo;, with username &ldquo;vagrant&rdquo; and port 2222;</p>

<p>In Executor, add the following keywords:</p>

<pre><code>keyword: vmStart
Command: vagrant
Parameters: up
Start in: e:\Docs\MeteorBox\sysClone\vm

keyword: vmSuspend
Command: vagrant
Parameters: suspend
Start in: e:\Docs\MeteorBox\sysClone\vm

Keyword: vmLogin
Command: MobaXterm_Personal_7.7.exe
Parameters: -bookmark localvm -exitwhendone
Start in: d:\Apps\MobaXterm_v7.7

Keyword: vmStart&amp;Login
Command: vmStart||vmLogin
</code></pre>

<p>Now you can use [win-z, vmStart&amp;Login] to start VM and login.
Before you shutdown Windows machine, remember use [win-z, vmSuspend] to suspend VM
(which is always impossible).</p>

<p>Below is the procedure of getting a project into the VM:</p>

<pre><code>win-z: vmstart
win-z: vmlogin
# in the VM
ssh-keygen
# copy $(cat .ssh/id_rsa.pub) to http://phab.yourdomain.com/settings/panel/ssh
mkdir docs;cd docs
git clone ssh://git@phab.yourdomain.com/diffusion/YOURREPO/yourRepo.git 
cd yourRepo
git submodule init
git submodule update
</code></pre>

<p>Note: to add or edit keywords in Executor, use shortcut [win-z, Ctrl-k],
see Executor documents for details.</p>

<h1>Kitty</h1>

<p>If you prefer Kitty (portable version of Putty) to MobaXterm,</p>

<p>Add a new Session &ldquo;localvm&rdquo; in Kitty:</p>

<pre><code>Host name: localhost
Port: 2222
Connection -&gt; Data -&gt; Auto-login username &amp; password: vagrant
Window -&gt; Behavior: check "Full screen on Alt-Enter"
</code></pre>

<p>The corresponding &ldquo;vmLogin&rdquo; will be:</p>

<pre><code>Keyword: vmLogin
Command: kitty.exe
Parameters: -load localvm
Start in: d:\Apps\Kitty
</code></pre>

<h1>ConEmu + Kitty</h1>

<p>You can even wrap Kitty into <a href="https://github.com/Maximus5/ConEmu">ConEmu</a>,
which is a good Windows console alternative.</p>

<p>In ConEmu, add a task in Settings -> Startup -> Tasks:</p>

<pre><code>Name: Kitty
Hotkey: Win + Alt + X
Task parameters: blank
Commands: d:\Apps\Kitty\kitty.exe -new_console -load "VagrantLinux"
</code></pre>

<p>And set Kitty as the auto startup task:
Set <code>Settings -&gt; Startup -&gt; Startup options -&gt; Specified named task</code> to &ldquo;Kitty&rdquo;.</p>

<p>Add a new Executor keyword for ConEmu:</p>

<pre><code>Keyword: vmLogin
Command: d:\Apps\ConEmu\ConEmu.exe
</code></pre>

<p>(or use [Win + Alt + X] to login to VM manually in ConEmu).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/05/110947/">Use Git in Vim With Fugitive</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-05T11:09:47+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:09 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Install</h1>

<p>Add <code>Plugin 'tpope/vim-fugitive'</code> into ~/.vimrc
and run <code>vim +PluginClean +PluginInstall +qa</code>.</p>

<h1>Get Help</h1>

<p>:help fugitive</p>

<h1>Frequently Use Commands</h1>

<table>
<thead>
<tr>
<th>Action Name </th>
<th> Meaning                </th>
<th> Close Window with</th>
</tr>
</thead>
<tbody>
<tr>
<td>:Gblame     </td>
<td> show info of each line </td>
<td> q</td>
</tr>
<tr>
<td>:Gdiff      </td>
<td> show diff in vim       </td>
<td> :q</td>
</tr>
<tr>
<td>:Gstatus    </td>
<td> show git status        </td>
<td> q</td>
</tr>
</tbody>
</table>


<p>In &ldquo;:Gstatus&rdquo; window, you can use &ldquo;-&rdquo; to add a file in/out stage area,
use &ldquo;cc&rdquo; to commit, use &ldquo;g?&rdquo; to see all available actions.</p>

<p>To see the file changes history: <code>:Git log --stat</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/03/095227/">A Meteor Package Test Demo</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-03T09:52:27+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>9:52 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Generating Test Data with Meteor Factory and Fake</h1>

<p>The following tests set up with <a href="https://github.com/percolatestudio/meteor-factory/">meteor-factory</a>.</p>

<p>First create Meteor app, install packages, define collections and start server:</p>

<pre><code>meteor create testApp
cd testApp
meteor add dburles:factory
meteor add babrahams:constellation
cat &lt;&lt; EOF &gt; collections.js
Authors = new Meteor.Collection('authors');
Books = new Meteor.Collection('books');
EOF
# Authors and Books must be defined in both servers and client
# or `Factory.create("books");` will fail.
# So they can't be defined in browser console
MONGO_URL="mongodb://localhost:27017/test" meteor
</code></pre>

<p>Then open <a href="http://localhost:3000/">http://localhost:3000/</a> in browser,
Open <a href="https://github.com/JackAdams/constellation">constellation console</a> with Ctrl-C.
Open browser console (with F12), run codes below:</p>

<pre><code>Factory.define('author', Authors, {
  name: 'John Smith'
});
// all authors created through Factory have the same "name"

Factory.define('book', Books, {
  authorId: Factory.get('author'),
  name: 'A book',
  year: function() { return _.random(1900, 2014); }
});
</code></pre>

<p>Now each time you run <code>Factory.create('author');</code>,
a new document is inserted into the collection &ldquo;authors&rdquo;.
You can see it on the constellation console under &ldquo;authors&rdquo; section.</p>

<p>If you want create user with different names,
add a new package <a href="https://github.com/anticoders/meteor-fake/">meteor-fake</a>
with <code>meteor add anti:fake</code>, and modify above definitions as follows:</p>

<pre><code>Factory.define('author', Authors, {
  name: function() { return Fake.user({fields: ['name']}).name; }
});

Factory.define('book', Books, {
  authorId: Factory.get('author'),
  name: function() { return Fake.sentence(4); },
  year: function() { return _.random(1900, 2014); }
});
</code></pre>

<p>When enable the &ldquo;Autopublish&rdquo; tab, you can see all the collections
even after the autopublish package removed from Meteor app.</p>

<h1>Used in Package</h1>

<p>The container app is named &ldquo;mininf&rdquo;, which has a package named &ldquo;nfcore&rdquo;.</p>

<p>There will be 3 roles of user in this scenario, Add, Sub and Multi.
Users with Add role can only ask addition questions,
with Sub can only ask substraction questions,
with Multi can only ask multiplication questions.</p>

<p>A user without a role can&rsquo;t ask any questions.</p>

<p>The users and their roles will be created with <a href="https://github.com/alanning/meteor-roles">alanning/meteor-roles</a>.</p>

<p>There are 2 collections, accounts and questions,
whose schemas are defined with <a href="https://github.com/aldeed/meteor-simple-schema">simple-schema</a>.</p>

<p>Target:</p>

<p>Run the container app, use constellation to watch it&rsquo;s data;
Define data schema with simple-schema;
Use factory to insert user and question to collections;
Run test on container app, see the result.</p>

<p>The implementation steps:</p>

<ol>
<li><p>Create mininf and nfcore;</p></li>
<li><p>Add simple-schema and roles in the package definition of mininf;</p></li>
<li><p>Add jasmine and velocity in the package test definition of mininf;</p></li>
<li><p>Create schemas of users and questions in package;</p></li>
<li><p>Create collections in package and attach schemas on them;</p></li>
<li><p>Create tests;</p>

<p> meteor create mininf
 cd mininf
 meteor create &ndash;package leo:nfcore
 cat &lt;&lt; EOF > packages/nfcore/package.js
 Package.describe({
   name: &lsquo;leo:nfcore&rsquo;,
   version: &lsquo;0.0.1&rsquo;,
   summary: &lsquo;&rsquo;,
   git: &lsquo;&rsquo;,
   documentation: &lsquo;README.md&rsquo;
 });
 Package.onUse(function(api) {
   api.versionsFrom(&lsquo;1.2.0.2&rsquo;);
   api.use(&lsquo;ecmascript&rsquo;);
   // this makes nfcore itself can use variable &ldquo;SimpleSchema&rdquo; in the source code
   api.use(&ldquo;aldeed:<a href="&#109;&#97;&#105;&#108;&#x74;&#x6f;&#x3a;&#x73;&#x69;&#x6d;&#x70;&#108;&#x65;&#x2d;&#x73;&#x63;&#x68;&#x65;&#109;&#x61;&#x40;&#x31;&#x2e;&#51;&#46;&#51;">&#115;&#105;&#x6d;&#x70;&#108;&#x65;&#x2d;&#x73;&#x63;&#104;&#101;&#x6d;&#x61;&#64;&#49;&#46;&#51;&#x2e;&#51;</a>&rdquo;);
   api.use(&ldquo;alanning:roles&rdquo;);
   // this makes any packages using nfcore can use &ldquo;SimpleSchema&rdquo;
   api.imply(&ldquo;aldeed:simple-schema&rdquo;);
   api.imply(&ldquo;alanning:roles&rdquo;);
   api.addFiles(&lsquo;nfcore.js&rsquo;);
   api.export(&ldquo;NFCore&rdquo;);
 });
 Package.onTest(function(api) {
   api.use(&lsquo;ecmascript&rsquo;);
   api.use(&lsquo;sanjo:<a href="&#x6d;&#97;&#x69;&#108;&#x74;&#111;&#x3a;&#106;&#x61;&#115;&#109;&#x69;&#110;&#101;&#x40;&#x30;&#x2e;&#49;&#57;&#46;&#48;">&#x6a;&#97;&#x73;&#109;&#105;&#x6e;&#x65;&#64;&#x30;&#x2e;&#x31;&#x39;&#46;&#48;</a>&rsquo;);
   api.use(&lsquo;anti:fake&rsquo;);
   api.use(&lsquo;underscore&rsquo;);
   api.use(&ldquo;dburles:<a href="&#109;&#97;&#x69;&#108;&#116;&#x6f;&#58;&#x66;&#97;&#x63;&#116;&#x6f;&#114;&#x79;&#64;&#48;&#x2e;&#x33;&#46;&#49;&#x30;">&#x66;&#x61;&#99;&#x74;&#111;&#x72;&#x79;&#64;&#x30;&#x2e;&#51;&#46;&#49;&#x30;</a>&rdquo;);
   api.use(&lsquo;velocity:<a href="&#109;&#97;&#x69;&#x6c;&#116;&#111;&#58;&#x68;&#116;&#x6d;&#x6c;&#45;&#114;&#101;&#x70;&#111;&#114;&#116;&#x65;&#114;&#x40;&#48;&#46;&#57;&#46;&#x30;">&#x68;&#116;&#x6d;&#108;&#x2d;&#x72;&#101;&#x70;&#x6f;&#114;&#x74;&#x65;&#x72;&#64;&#48;&#x2e;&#57;&#46;&#x30;</a>&rsquo;);
   api.use(&lsquo;velocity:<a href="&#x6d;&#97;&#x69;&#x6c;&#x74;&#111;&#x3a;&#x63;&#111;&#x6e;&#x73;&#x6f;&#x6c;&#101;&#x2d;&#x72;&#x65;&#112;&#x6f;&#114;&#x74;&#x65;&#114;&#64;&#48;&#46;&#49;&#x2e;&#51;">&#99;&#x6f;&#110;&#115;&#111;&#x6c;&#101;&#45;&#114;&#x65;&#112;&#111;&#x72;&#116;&#x65;&#x72;&#x40;&#48;&#46;&#x31;&#x2e;&#x33;</a>&rsquo;);
   api.use(&lsquo;leo:nfcore&rsquo;);
   api.addFiles(&lsquo;nfcore-tests.js&rsquo;);
 });
 EOF</p>

<p> mkdir -p {common/{schemas,collections},tests,client,server}
 cat &lt;&lt; EOF > common/globals.js
 NFCore = {};
 NFCore.Schemas = {};
 NFCore.Collections = {};
 EOF</p>

<p> cat &lt;&lt; EOF > common/schemas/accounts.js
 NFCore.Schemas.Accounts = new SimpleSchema({
   name: {
     type: String
   }
 });
 EOF</p>

<p> cat &lt;&lt; EOF > common/schemas/accounts.js
 NFCore.Schemas.Questions = new SimpleSchema({
   owner: {
     type: Meteor.Collection.ObjectID
   },
   content: {
     type: String
   }
 });
 EOF</p>

<p> cat &lt;&lt; EOF > common/collections/collections.js
 NFCore.Collections.Accounts = new Mongo.Collection(&ldquo;accounts&rdquo;);
 NFCore.Collections.Accounts.attachSchema(NFCore.Schemas.Accounts);</p>

<p> NFCore.Collections.Questions = new Mongo.Collection(&ldquo;questions&rdquo;);
 NFCore.Collections.Questions.attachSchema(NFCore.Schemas.Questions);
 EOF</p></li>
</ol>


<h1>Errors, Questions and Solutions</h1>

<p>E: meteor object [object object] has no method &lsquo;attach schema&rsquo;.</p>

<p>S: Add <code>api.use("aldeed:collection2@2.5.0");</code> and <code>api.imply("aldeed:collection2@2.5.0");</code> into Package.onUse() of package.js.</p>

<p>E: insert failed: Access denied. No allow validators set on restricted collection for method &lsquo;insert&rsquo;.</p>

<p>S: Add &ldquo;server&rdquo; as the 2nd parameter in package.js -> Package.onTest -> api.addFiles(<the-test-file-name>):
<code>api.addFiles('tests/accounts.js', 'server');</code>.</p>

<p>Q: In package I use Factory.create() to insert a doc into a collection, but I can&rsquo;t find the collection.</p>

<p>S: Add environment &ldquo;MONGO_URL&rdquo; into the test command:
<code>VELOCITY_TEST_PACKAGES=1 MONGO_URL="mongodb://localhost:27017/test" meteor test-packages --driver-package velocity:html-reporter leo:nfcore</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/01/202107/">Notes of Learn You a Haskell for Great Good</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-01T20:21:07+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>8:21 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Notes for <a href="http://learnyouahaskell.com/">Learn You a Haskell for Great Good</a>.</p>

<h1>Modules</h1>

<p>The following code snippet demonstrate how to import and use Haskell submodule.
Save the following codes into a shell script and run it.</p>

<pre><code>#!/bin/bash
mkdir Geometry
cat &lt;&lt; EOF &gt; Geometry/Sphere.hs
module Geometry.Sphere
( volume
, area
) where

volume :: Float -&gt; Float
volume radius = (4.0 / 3.0) * pi * (radius ^ 3)

area :: Float -&gt; Float
area radius = 4 * pi * (radius ^ 2)
EOF

cat &lt;&lt; EOF &gt; app.hs
import Geometry.Sphere
main = print $ volume 3
EOF

runghc app.hs
</code></pre>

<p>The result should be &ldquo;113.097336&rdquo;.</p>

<h1>Making Our Own Types and Typeclasses</h1>

<p>Value constructor is also called &ldquo;data constructor&rdquo;.</p>

<p>Ref:</p>

<p><a href="https://wiki.haskell.org/Constructor">Constructor</a></p>

<p><a href="http://stackoverflow.com/questions/18204308/haskell-type-vs-data-constructor">Haskell Type vs Data Constructor</a></p>

<h1>Applicative Functors</h1>

<p>下面的代码，转换<code>[1,2,3,4]</code>时，可以用<code>map</code>代替<code>fmap</code>，转换<code>Just 4</code>就不行：</p>

<pre><code>Prelude&gt; fmap (replicate 3) [1,2,3,4]
[[1,1,1],[2,2,2],[3,3,3],[4,4,4]]

Prelude&gt; map (replicate 3) [1,2,3,4]
[[1,1,1],[2,2,2],[3,3,3],[4,4,4]]

Prelude&gt; fmap (replicate 3) (Just 4)
Just [4,4,4]

Prelude&gt; map (replicate 3) (Just 4)
&lt;interactive&gt;:45:20:
    Couldn't match expected type ‘[a]’ with actual type ‘Maybe Integer’
    Relevant bindings include it :: [[a]] (bound at &lt;interactive&gt;:45:1)
    In the second argument of ‘map’, namely ‘(Just 4)’
    In the expression: map (replicate 3) (Just 4)
</code></pre>

<p>map是一个函数，通过一个将a类型变为b类型的函数，
将元素类型为a类型的数组转换为元素类型为b的数组；</p>

<pre><code>Prelude&gt; :t map
map :: (a -&gt; b) -&gt; [a] -&gt; [b]
</code></pre>

<p>fmap是一个函数，通过一个将a类型变为b类型的函数，
将一个类型为"f a"的值，变为一个类型为"f b"的值。</p>

<pre><code>Prelude&gt; :t fmap
fmap :: Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>

<p><code>Maybe</code>是一个实现了(instance)函子(Functor)类型类(class)的类型构造器(type constructor)。
类型构造器类似于Java的泛型，例如“数组” <code>[]</code>就是类型构造器，
“元素为整数的数组” <code>[Int]</code>是一个具体类型，这里的整型 Int就充当了数组类型构造器的参数，
用函数做类比，数组是个“类型函数”，参数是具体类型 Int，返回具体类型 [Int]。</p>

<pre><code>Prelude&gt; :k []
[] :: * -&gt; *
</code></pre>

<p>这里<code>:k</code>表示取数组的kind值，kind可以理解为是类型构造器的类型。
<code>*</code>表示某个具体类型（而不是类型构造器）。</p>

<p><code>Just</code>是一个函数，将a类型值转换为<code>Maybe a</code>类型值，
例如<code>Just 4</code>将Int类型值 (4)，转换为<code>Maybe Int</code>，
或者更准确地表述为：将Num类型值转为<code>Num a =&gt; Maybe a</code>类型。</p>

<pre><code>Prelude&gt; :k Maybe
Maybe :: * -&gt; *
Prelude&gt; :t Just
Just :: a -&gt; Maybe a
Prelude&gt; :t Just 4
Just 4 :: Num a =&gt; Maybe a
</code></pre>

<p>由于<code>Just 4</code>的类型<code>Maybe Integer</code>不符合<code>map</code>第二个参数类型<code>[a]</code>的要求，所以报错。</p>

<pre><code>Prelude&gt; :t replicate 3
replicate 3 :: a -&gt; [a]
Prelude&gt; :t fmap (replicate 3) (Just 4)
fmap (replicate 3) (Just 4) :: Num a =&gt; Maybe [a]
</code></pre>

<p>在上面的计算过程中，<code>(replicate 3)</code>是<code>fmap</code>的第一个参数<code>(a -&gt; b)</code>，
这里由于<code>(replicate 3)</code>类型是<code>(a -&gt; [a])</code>，所以<code>b</code>就是<code>[a]</code>。
<code>(Just 4)</code>是第二个参数<code>f a</code>，代入<code>Just 4</code>的类型<code>Maybe a</code>，
可知<code>Functor f</code>就是<code>Maybe</code>.
所以最终<code>f b</code>就是<code>Maybe [a]</code>。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/29/121847/">Meteor Test With Velocity and Jasmine</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-29T12:18:47+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:18 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Create jasmine tests and run them as the following codes:</p>

<pre><code>$ meteor create jasmineEx
$ cd jasmineEx
$ meteor create --package newfairscommerce:add-number
$ rm packages/add-number/add-number-tests.js
$ mkdir -p packages/add-number/tests/{server,client}
$ cat &lt;&lt; EOF &gt; packages/add-number/tests/example-spec.js
describe('sanjo:jasmine on client and server', function() {
  it('works', function() {
    expect(it).toBeDefined();
  })
})
EOF
$ cat &lt;&lt; EOF &gt; packages/add-number/tests/client/example-spec.js
describe('sanjo:jasmine on client', function() {
  it('works', function() {
    expect(it).toBeDefined();
  })
})
EOF
$ cat &lt;&lt; EOF &gt; packages/add-number/tests/server/example-spec.js
describe('sanjo:jasmine on server', function() {
  it('works', function() {
    expect(it).toBeDefined();
  })
})
EOF
</code></pre>

<p>And replace <code>Package.onTest</code> in packages/add-number/package.js with the following codes:</p>

<pre><code>Package.onTest(function(api) {
  api.use('sanjo:jasmine@0.18.0');
  api.use('velocity:html-reporter@0.9.0');
  api.use('velocity:console-reporter@0.1.3');

  api.addFiles('tests/server/example-spec.js', 'server');
  api.addFiles('tests/client/example-spec.js', 'client');
  api.addFiles('tests/example-spec.js', ['server', 'client']);
});
</code></pre>

<p>Now run <code>VELOCITY_TEST_PACKAGES=1 meteor test-packages --driver-package velocity:html-reporter newfairscommerce:add-number</code>
under the root directory of jasmineEx project,
you can get the following output:</p>

<pre><code>...
=&gt; App running at: http://localhost:3000/
I20151003-18:23:56.465(8)? jasmine-server-integration: 2 tests passed (11ms)
I20151003-18:24:07.849(8)? jasmine-client-integration: 2 tests passed (3ms)
</code></pre>

<p>And you can get the test results in browser with url &ldquo;<a href="http://localhost:3000">http://localhost:3000</a>&rdquo;.</p>

<p>Questions:</p>

<p>When running the following codes, it runs into a interactive shell:</p>

<pre><code>npm install -g velocity-cli
velocity test-package newfairscommerce:add-number
</code></pre>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/6">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/4">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/02/21/110422/">3月6日演讲提纲</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/20/010838/">Merge Multiple PDF Files in Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/16/212514/">Debug Python Script</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/09/120142/">Golang Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/07/103930/">Cabal Notes</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leetschau">@leetschau</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leetschau',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Li Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
