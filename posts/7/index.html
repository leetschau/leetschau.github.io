
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dark Matter in Cyberspace</title>
  <meta name="author" content="Li Chao">

  
  <meta name="description" content="Say you want to update data in updated.csv into &ldquo;fairs&rdquo; collection of &ldquo;meteor&rdquo; database in MongoDB. Convert data to be &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leetschau.github.io/posts/7/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Dark Matter in Cyberspace" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dark Matter in Cyberspace</a></h1>
  
    <h2>A notes repository for Meteor.js, data mining, Linux, etc.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="leetschau.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/06/180118/">Update Data in MongoDB</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-06T18:01:18+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:01 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Say you want to update data in updated.csv into &ldquo;fairs&rdquo; collection of &ldquo;meteor&rdquo; database in MongoDB.</p>

<ol>
<li><p>Convert data to be updated in csv file to json file: <code>csvjson updated.csv rawdata.json</code>;</p></li>
<li><p>Load this file in a js script &ldquo;my-script&rdquo; with <code>var data = require('./rawdata.json');</code>;</p></li>
<li><p>Check and convert data content in my-script, and write the reulst into another json file &ldquo;result.json&rdquo;:</p>

<pre><code> var fs = require('fs');
 fs.writeFile('result.json', JSON.stringify(result));
</code></pre></li>
<li><p>Run my-script with <code>node my-script</code>;</p></li>
<li><p>Import result.json into a new collection &ldquo;tmp&rdquo; of MongoDB database with
<code>mongoimport -d $TargetDB -c $TargetCol --type json --file result.json --jsonArray</code>;</p></li>
<li><p>Update collection fairs while traversing collection tmp;</p>

<pre><code> db = connect("localhost:27017/meteor");
 cursor = db.tmp.find();
 while ( cursor.hasNext() ) {
   db.fairs.save(cursor.next());
 }
</code></pre></li>
<li><p>Save above script into update.js;</p></li>
<li><p>Update data with <code>mongo update.js</code>;</p></li>
</ol>


<p>Ref:</p>

<p><a href="http://docs.mongodb.org/manual/tutorial/write-scripts-for-the-mongo-shell/">Write Scripts for the mongo Shell</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/06/101802/">Website Server Provsion</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-06T10:18:02+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:18 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Work flow</h1>

<ol>
<li><p>Install packages: tree, curl, git;</p></li>
<li><p>Create user chad, add it to sudoers;</p></li>
<li><p>Install Meteor: <code>curl https://install.meteor.com | /bin/sh</code>;</p></li>
<li><p>download mongoDB package (mongodb-linux-x86_64-rhel62-3.0.0.tgz for now) from <a href="https://www.mongodb.org/">mongoDB</a>;</p></li>
<li><p>Extract mongoDB package to $HOME/apps, add $MONGO_HOME/bin to $PATH
 (in file ~/.bash_profile);</p></li>
<li><p>Config mongoDB: save the following codes into $HOME/docs/mongoRepo/mongo.conf:</p>

<pre><code> net:
   bindIp: 127.0.0.1
   port: 27017
 storage:
   dbPath: dbHome
 systemLog:
   destination: file
   path: "mongodb.log"
   logAppend: true
</code></pre></li>
<li><p>Start mongod: <code>mongod --config mongo.conf</code>, or in background: <code>nohup mongod --config mongo.conf &amp;</code>;</p></li>
</ol>


<h1>Ansible</h1>

<h2>Managing Node</h2>

<p>Install <a href="http://www.ansible.com/">ansible</a> with <code>sudo pip install ansible</code>.</p>

<h2>Provision of remote host</h2>

<p>On remote host, create user with <code>sudo useradd -m chad</code>
and set password: <code>sudo passwd chad</code>.
On manging node, add ssh automatic login of chad and root on remote host with <code>ssh-copy-id</code>.</p>

<p>For a vagrant host, run the following commands in project&rsquo;s root directory:</p>

<pre><code>vagrant ssh
sudo passwd
// set password for root ...
sudo useradd -m chad
sudo passwd chad
// set password for chad ...
exit
ssh-copy-id chad@localhost -p 2222
ssh-copy-id root@localhost -p 2222
</code></pre>

<p>// Install Node.js, MongoDB,</p>

<p>Install mms with installing its rpm package,
you can remove it later with:</p>

<pre><code># service --status-all
# rpm -qa|grep mongo
mongodb-mms-automation-agent-manager-1.6.2.960-1.x86_64
# rpm -e mongodb-mms-automation-agent-manager-1.6.2.960-1.x86_64
# service --status-all
</code></pre>

<p>Change host name:</p>

<p>Add &ldquo;newfairs.biz&rdquo; after &ldquo;127.0.0.1  &rdquo;, before &ldquo;localhost&rdquo; in /etc/hosts.
Restart mms agent: <code>service mongodb-mms-automation-agent restart</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/06/090609/">Setup MongoDB Server on Aliyun</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-06T09:06:09+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:06 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For version 3.0.</p>

<h1>Install</h1>

<p>On VPS (ip: 123.56.18.18), download MongoDB binary package for Ubuntu 14.04 and extract:</p>

<pre><code>wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1404-3.0.3.tgz
cd /opt
tar zxf ~/mongodb-linux-x86_64-ubuntu1404-3.0.3.tgz
mkdir -p /data/db
</code></pre>

<h1>Authentication Management</h1>

<p>Start mongod without auth on VPS (ip: 123.56.18.18): <code>mongod</code>;</p>

<p>Connect to server with <code>mongo 123.56.18.18</code>;
Create system user administrator:</p>

<pre><code>use admin
db.createUser(
    {
      user: "superuser",
      pwd: "12345678",
      roles: [ "root" ]
    }
)
</code></pre>

<p>Create user in current database:</p>

<pre><code>use products
db.createUser({user: "niufair", pwd: "nfsecret", roles: ["readWrite"]})
show users
</code></pre>

<p>Create a production config file mongo.conf:</p>

<pre><code>net:
  #bindIp: 10.251.212.248
  port: 15515
systemLog:
  destination: file
  path: "mongo.log"
  logAppend: true
security:
  authorization: enabled
</code></pre>

<p>Stop and restart mongod with <code>nohup mongod --config mongo.conf &amp;</code>;</p>

<p>Connect to server as a database user: <code>mongo 123.56.18.18:15515/products -u niufair -p nfsecret</code>.
You can <code>show collections</code>, <code>db.doc.insert()</code>, etc.</p>

<p>Start Meteor app with <code>MONGO_URL="mongodb://niufair:nfsecret@123.56.18.18:15515/products" meteor</code>.</p>

<p>Connect to server as administrator: <code>mongo 123.56.18.18:15515/admin -u leo -p leoisadmin</code>.</p>

<p>Use <code>db.removeUser("username")</code> to remove user.</p>

<h2>Create a new database under authentication</h2>

<p>Say we want to create a new database named &ldquo;bakdb&rdquo;:</p>

<pre><code>mongo 123.56.18.18:15515/admin -u leo -p leoisadmin
use bakdb
db.createUser({user: "niufair", pwd: "nfsecret", roles: ["readWrite"]})
</code></pre>

<p>Verify: <code>mongo -u niufair -p nfsecret 123.56.18.18:15515/bakdb</code>;</p>

<p>Ref:</p>

<p><a href="http://docs.mongodb.org/manual/tutorial/enable-authentication-without-bypass/">Enable Authentication after Creating the User Administrator</a></p>

<p><a href="http://docs.mongodb.org/manual/tutorial/add-user-to-database/">Add a User to a Database</a></p>

<p><a href="http://docs.mongodb.org/manual/tutorial/add-admin-user/">Create an Administrative User with Unrestricted Access</a></p>

<p><a href="http://docs.mongodb.org/manual/tutorial/enable-authentication/">Enable Client Access Control</a></p>

<p><a href="http://docs.mongodb.org/manual/reference/built-in-roles/">Built-In Roles</a></p>

<p><a href="http://stackoverflow.com/questions/4881208/how-to-put-username-password-in-mongodb">http://stackoverflow.com/questions/4881208/how-to-put-username-password-in-mongodb</a></p>

<h1>MMS</h1>

<p>Connect mongodb server without authentication: <code>mongo &lt;ip&gt;:&lt;port&gt;</code>;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/05/095056/">Manage Website Remotely</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-05T09:50:56+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:50 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Prerequisite</h1>

<h2>Managing Node</h2>

<p>// Install Fabric with <code>sudo pip install fabric</code>.</p>

<p>Install ansible with <code>sudo pip install ansible</code>.</p>

<h2>Provision of remote host</h2>

<p>Create user with <code>sudo useradd -m chad</code>,
then add ssh-auto-login with <code>ssh-copy-id ...</code>.</p>

<p>// Install Node.js, MongoDB,</p>

<h1>Backup MongoDB</h1>

<h1>Import new data</h1>

<h1>Update website codes</h1>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/28/152115/">Website Monitor for Meteor Application</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-28T15:21:15+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:21 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Google Analytics</h1>

<p>Add tracking code (<script>&hellip;</script>) into the &ldquo;<head>&hellip;</head>&rdquo; (commonly in head.html) of your meteor app.</p>

<p>You can find your tracking codes at Admin -> User Management -> Tracking Info -> Tracking Code.</p>

<p>Get real-time data (such as on-site user number) at Reporting -> Real-Time -> Overview.</p>

<h1>Kadira</h1>

<pre><code>meteor add meteorhacks:kadira
</code></pre>

<p>Add the following codes into server/kadira.js:</p>

<pre><code>Kadira.connect('&lt;App ID&gt;', '&lt;App Secret&gt;');
</code></pre>

<p>get your AppID and App secret at <a href="https://kadira.io/">Kadira</a> -> [Your App] -> Settings.</p>

<p>Then see read-time statistics on its dashboard.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/28/114611/">System Monitor Tools for Linux Server</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-28T11:46:11+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:46 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>sar</h1>

<p>On CentOS 6.5, install sysstat with <code>yum install sysstat</code>.
And the cron jobs will be created in /etc/cron.d/sysstat.
The default routines defined in this file is running system activity accounting every 10 minutes,
and generating a daily summary of process accounting at 23:53 each day.</p>

<p>Now you can see system memory usage hisory with <code>sar -r 2 5</code>,
which means display memory usage every 2 seconds, 5 times totally.</p>

<p>To see the memory history: <code>sar -r -f /var/log/sa/sa28</code>,
the total free memory is the sum of 3 items: kbmemfree, kbbuffers, kbcached.</p>

<p>Refs:</p>

<ul>
<li><p><a href="https://www.thomas-krenn.com/en/wiki/Collect_and_report_Linux_System_Activity_Information_with_sar">https://www.thomas-krenn.com/en/wiki/Collect_and_report_Linux_System_Activity_Information_with_sar</a></p></li>
<li><p><a href="http://serverfault.com/questions/85470/meaning-of-the-buffers-cache-line-in-the-output-of-free.">http://serverfault.com/questions/85470/meaning-of-the-buffers-cache-line-in-the-output-of-free.</a></p></li>
</ul>


<h1>dstat</h1>

<p>On CentOS 6.5, install dstat with <code>yum install dstat</code>.</p>

<p>Log the memory usage with <code>dstat --output memlog.csv -t -m 600 500</code>,
which will log totally 500 times, with a 10-minute interval.</p>

<h1>Glances</h1>

<p>Install it with <code>curl -L http://bit.ly/glances | /bin/bash</code>.
This only works on Linode node.
It failed on my loptop with message &ldquo;connection reset by peer&rdquo;.
On the Linode node, the installation failed with &ldquo;yum&rdquo; and &ldquo;pip&rdquo;.
It seems the reason is the dependencies are not met.</p>

<p>Use it with <code>glances</code> with root, or <code>glances -w</code> as a web server.
Then you can see the status of your server with url &ldquo;<a href="http://104.237.135.143:61208">http://104.237.135.143:61208</a>&rdquo;.</p>

<p>For keep a system log, use <code>glances -t 600 --export-csv /tmp/glances.csv</code>,
which means write a csv-format log every 10 minutes (3 seconds by default) to /tmp/glances.csv.</p>

<p>P.S.: There&rsquo;s also a <a href="http://munin-monitoring.org/">Munin</a>.
It seems the installation is complex, so I gave up.</p>

<h1>collectl</h1>

<p>Install with <code>yum install collectl</code>.</p>

<p>Print memeory usage with <code>collectl -i 2 -c 5 -sm</code>.</p>

<p>Print all subsystems with <code>collectl --showsubsys</code>.</p>

<p>Log output information with &ldquo;-f&rdquo; options: <code>collectl -sm -i 2 -c 5 -f mylog</code>.
It creates a gz file, which you have to extract with <code>gzip -d mylog...</code>.</p>

<p>Ref: <a href="http://lintut.com/best-command-line-tools-for-linux-performance-monitring/">http://lintut.com/best-command-line-tools-for-linux-performance-monitring/</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/25/141712/">The Algorithm of Related Fairs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-25T14:17:12+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:17 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For a given fair A, it&rsquo;s <em>major category</em> are a set of its cat.major subdocuments.</p>

<p>For example, for the fair:</p>

<pre><code>{ cat: [ { major: "abc", minor: [ 1,23,3] }, { major: "xyz", minor: [ 3, 23, 583]} ] }
</code></pre>

<p>its major categories are set [&ldquo;abc, "xyz&rdquo;].
Here we say the major categories of fair X is <code>majorCat(X)</code>.</p>

<p>If the intersection of set <code>majorCat(X)</code> and <code>majorCat(Y)</code> are not empty,
we say fair X and Y are <em>related</em>.</p>

<p>So for a given fair X, how to find all its related fairs in a collection?</p>

<p>Here is the demonstration:</p>

<p>In mongodb, create a test collection with the following codes:</p>

<pre><code>db.cats.insert( { cat: [ { major: "abc", minor: [ 1,23,3] }, { major: "xyz", minor: [ 3, 23, 583]} ] } );
db.cats.insert( { cat: [ { major: "abcd", minor: [ 1,23,3] }, { major: "xyzu", minor: [ 87, 987, 343]} ] } );
db.cats.insert( { cat: [ { major: "bcd", minor: [ 1,23,3] }, { major: "abc", minor: [ 3, 23, 876]} ] } );
db.cats.insert( { cat: [ { major: "xyz", minor: [ 8,83,5] }, { major: "axc", minor: [ 34, 3, 76]} ] } );
</code></pre>

<p>Create a new Meteor app with <code>meteor create relatedFairs</code>, and its files:</p>

<p>relatedFairs.html</p>

<pre><code>&lt;head&gt;
  &lt;title&gt;relatedFairs&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;h1&gt;Find related fairs&lt;/h1&gt;

&lt;/body&gt;

&lt;template name="hello"&gt;
  &lt;ul&gt;

      &lt;li&gt; 
        &lt;b&gt;:&lt;/b&gt;

          ,

      &lt;/li&gt;

  &lt;/ul&gt;

    &lt;p&gt;Related fairs of the first fair &lt;/p&gt;
    &lt;ul&gt;

        &lt;li&gt;
          &lt;b&gt;:&lt;/b&gt;

            ,

        &lt;/li&gt;

    &lt;/ul&gt;

&lt;/template&gt;
</code></pre>

<p>relatedFairs.js:</p>

<pre><code>Fairs = new Mongo.Collection("cats");

if (Meteor.isClient) {
  Template.hello.helpers({
    allFairs: function () {
      return Fairs.find();
    },
    related: function () {
      var theXrd = 0,
          theFair = Fairs.findOne( {}, {skip: theXrd } );
      if (! theFair) {
        return null;
      }
      var majors = _.map(theFair.cat, function(i) { return i.major; } );
      var rels = Fairs.find( { cat: { $elemMatch: { major: { $in: majors } } },
                               _id: { $ne: theFair._id } } );
      return {firstID: theFair._id._str, relatedFairs: rels };
    }
  });
}
</code></pre>

<p>Here we use <a href="http://underscorejs.org/">Underscore.js</a>,
so install this package with <code>meteor add underscore</code> to run our demo app
(with <code>MONGO_URL="mongodb://localhost:27017/test" meteor</code> in project root folder).</p>

<p>Modify the value of &ldquo;theXrd&rdquo; above, you can see the related fairs of each fair.</p>

<p>To make a demo in a production collection,
in fair &ldquo;A&rdquo; we find a major category called &ldquo;垃圾车与运输车"，
then choose a fair B, whose id is "54e71a5642fb549b1389ae6f&rdquo;.</p>

<p>Let&rsquo;s add the major cateory to fair B:</p>

<pre><code>db.fairs.update( { _id: ObjectId("54e71a5642fb549b1389ae6f") }, { $push: {category: {major: "垃圾车与运输车"}} } );
</code></pre>

<p>Now fair A and B is related. Test them on your web site.
If the test is past, remove the test data from fair B:</p>

<pre><code>db.fairs.update( { _id: ObjectId("54e71a6642fb549b1389ae6f") }, { $pop: { category: 1 } } );
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/20/224401/">Test Underscore Functions of Meteor App</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-20T22:44:01+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:44 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When you add some underscore functions to your meteor app, you can&rsquo;t test it in browser console.
So we need test it somewhere else.</p>

<ol>
<li><p>Create a new folder as the test project root;</p></li>
<li><p>Install underscore package locally, which means the package is specific for this project;</p></li>
<li><p>Create a node script to test the underscore functions.</p></li>
</ol>


<p>The whole work flow is like this:</p>

<pre><code>$ mkdir myapp
$ cd myapp
$ npm install underscore
$ cat &lt;&lt; EOF &gt; myfunc.js
var _ = require('underscore');
var res = _.map([1, 2, 3], function(num){ return num * 3; });
console.log(res);
EOF
$ node myfunc
[ 3, 6, 9 ]
</code></pre>

<p>You can&rsquo;t use <code>var _ = require('underscore');</code> in node REPL shell, for node shell use &ldquo;_&rdquo; to hold the last result.</p>

<p>Note:</p>

<ol>
<li><p>See <a href="https://docs.npmjs.com/misc/faq#why-cant-npm-just-put-everything-in-one-place-like-other-package-managers">Why can&rsquo;t npm just put everything in one place, like other package managers? on npm&rsquo;s FAQ</a>
for the reason why npm not install pakcage globally like pip.</p></li>
<li><p>For node, how to determine install a package locally or globally?
According to <a href="http://blog.nodejs.org/2011/03/23/npm-1-0-global-vs-local-installation/">npm 1.0: Global vs Local installation</a></p>

<ol type="a">
<li><p> If you’re installing something that you want to use in your program, using require(&lsquo;whatever&rsquo;), then install it locally, at the root of your project.</p></li>
<li><p> If you’re installing something that you want to use in your shell, on the command line or something, install it globally, so that its binaries end up in your PATH environment variable. For example, install <a href="http://bower.io/">bower</a> with <code>npm install bower -g</code>.</p></li>
</ol>
</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/20/194901/">Import Data for Newfairs.com</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-20T19:49:01+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Prerequisites</h1>

<p>First install MongoDB, node.js and csvkit.</p>

<p>For node.js, download node binary package (node-v0.10.33-linux-x64.tar.gz in my case) from its website,
extract and add binary folder into $PATH. For example, add the following line into ~/.zshenv:</p>

<pre><code>PATH=$HOME/apps/node-v0.10.33-linux-x64/bin:$PATH
</code></pre>

<p>For MongoDB, download its binary package (mongodb-linux-x86_64-2.6.5.tgz in my case) from its website,
extract and add binary folder into $PATH:</p>

<pre><code>PATH=$HOME/apps/mongodb-linux-x86_64-2.6.5/bin:$PATH
</code></pre>

<p>Install csvkit with <code>sudo pip install csvkit</code>.</p>

<h1>Preparation</h1>

<ol>
<li><p>Convert Excel (xls/xlsx) file to csv file: <code>in2csv data.xls &gt; data.csv</code>;</p></li>
<li><p>(Optional) Convert file encoding: <code>iconv -f gbk -t utf8 data20150218.csv &gt; input.csv</code>;</p></li>
<li><p>Examine data: <code>head input.csv | csvjson -i 4</code>;</p></li>
<li><p>Start MongoDB server for importing data: <code>mongod</code>;</p></li>
</ol>


<h1>Import Data</h1>

<p>In case you want to overwrite old data, you need backup old collection:
start a mongodb client, make a copy of the old collection (the original collection is &ldquo;fairs&rdquo;):</p>

<pre><code>$ mongo
&gt; db.fairs.renameCollection('fairsBak')
</code></pre>

<p>P.S. You can make a copy of a collection with <code>db.fairs.copyTo('fairsBak')</code>.</p>

<p>Now import new data to collection &ldquo;fairs&rdquo;:</p>

<pre><code>./importdata
</code></pre>

<h1>Under the hood</h1>

<p>importdata:</p>

<pre><code>#!/bin/bash

# convert the csv file encoding with:
# iconv -f gbk -t utf8 xxx.csv &gt; input.csv
INP='input.csv'
TargetDB='test'
TargetCol='fairs'

RAW='rawdata.json'
RES='result.json'
if [[ ! -f $INP ]]; then
  echo File input.csv not exists!
  exit 1
fi
rm -rf $RAW $RES
csvjson $INP &gt; $RAW
node checkTransform
mongoimport -d $TargetDB -c $TargetCol --type json --file $RES --jsonArray
rm -rf $RAW $RES
</code></pre>

<p>checkTransform.js:</p>

<pre><code>var data = require('./rawdata.json');
var fs = require('fs');
var result = []

data.forEach(function(elem) {
  var aFair = JSON.parse( JSON.stringify(elem) );
  aFair.indexStr = {};
  aFair.indexStr['name'] = (elem.chnName + ' ' + elem.engName).trim();
  aFair.indexStr['sponsor'] = elem.sponsor;
  aFair.indexStr['undertaker'] = elem.undertaker;
  aFair.indexStr['category'] = elem.category;
  aFair.indexStr['simpleSearch'] = elem.chnName + ' ' + elem.engName + ' ' + elem.position + ' ' + elem.time + ' ' + elem.category;

  if (elem.sponsor) {
    aFair['sponsor'] = [];
    elem.sponsor.split('|').forEach(function(spr) {
      var aSponsor = {};
      var sps = spr.split('$');
      aSponsor['name'] = sps[0];
      aSponsor['tel'] = sps[1];
      aSponsor['fax'] = sps[2];
      aSponsor['email'] = sps[3];
      aSponsor['website'] = sps[4];
      aFair.sponsor.push(aSponsor);
    });
  }

  if (elem.undertaker) {
    aFair['undertaker'] = [];
    elem.undertaker.split('|').forEach(function(udt) {
      var aUndertaker = {};
      var uds = udt.split('$');
      aUndertaker['name'] = uds[0];
      aUndertaker['tel'] = uds[1];
      aUndertaker['fax'] = uds[2];
      aUndertaker['email'] = uds[3];
      aUndertaker['website'] = uds[4];
      aFair.undertaker.push(aUndertaker);
    });
  }

  if (elem.category) {
    aFair['category'] = [];
    elem.category.split('|').forEach(function(catStr) {
      var aCat = {};
      var cats = catStr.split('$');
      aCat['major'] = cats[0] === '?' ? '' : cats[0];
      aCat['minor'] = cats.slice(1);
      aFair.category.push(aCat);
    });
  }

  result.push(aFair);
});

fs.writeFile('result.json', JSON.stringify(result));
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/18/105314/">超链接中data-toggle属性使用新的Session</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-18T10:53:14+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:53 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>如果在超链接中将"data-toggle"属性设为"modal"，如下所示，则超链接所指向的窗体将使用新的Seesion。</p>

<pre><code>&lt;a href="/register" data-toggle="modal"&gt;注册新帐号&lt;/a&gt;
</code></pre>

<p>比如我们想在每次跳转后将当前url记录在Session变量"currentUrl"中，
但是在url以"login"和"register"结尾时不更新"currentUrl"：</p>

<pre><code>Router.onAfterAction(function(){
  if (! (Router.current() &amp;&amp; Router.current().url) ) {
    return;
  }
  var currentUrl = Router.current().url;
  if ( (currentUrl.indexOf('login') &lt; 0 ) &amp;&amp;
        currentUrl.indexOf("register") &lt; 0 ) {
    Session.set("currentUrl", currentUrl);
  }
});
</code></pre>

<p>然后在登录或者注册成功后取出这个缓存的变量，利用callback函数跳转回之前的页面：</p>

<pre><code>Accounts.createUser({
  email: t.find("#userEmail").value,
  password: t.find("#userPwd").value,
  profile: {
    nickname: t.find("#userNickname").value,
    role: userRole.value,
    gender: gender.value,
    desc: userDesc
  }
}, function(error) {
  if (error) {
    alert("something wrong, registration failed.");
  } else {
    alert("注册并登录成功！");
    var currentUrl = Session.get("currentUrl");
    var tmp = document.createElement('a');
    tmp.href = currentUrl;
    var currentPath = tmp.pathname + tmp.search;
    Router.go(currentPath);
  }
});
</code></pre>

<p>那么当点击上面的超链接时，所有Session对象都被清空，"currentUrl"值变为"undefined"，
如果用<code>Session.setDefault("currentUrl", "aabb");</code>设置默认值，
则点击上面的超链接后"currentUrl"值变为"aabb"，
然后再执行Router.onAfterAction中的callback函数。</p>

<p>这样前面利用缓存变量跳转回原来页面的设计就失效了，页面跳转到"/undefined"页面，
解决办法很简单：去掉超链接中的data-toggle属性，变为一个普通超链接：</p>

<pre><code>&lt;a href="/register"&gt;注册新帐号&lt;/a&gt;
</code></pre>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/8">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/6">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/09/20/212102/">Generate Random Date After a Specified Date</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/16/101529/">A JavaScript Closure Demo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/15/122519/">JSDoc Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/12/233609/">Push to Github Repository With SSH Keys</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/12/093754/">Change SSH Port on Linux</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leetschau">@leetschau</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leetschau',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Li Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
