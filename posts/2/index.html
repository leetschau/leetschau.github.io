
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dark Matter in Cyberspace</title>
  <meta name="author" content="Li Chao">

  
  <meta name="description" content="If you use some virtual host with the same IP,
you will always see messages below: $ ssh ansible@console.newfairs-inc.com
Warning: the ECDSA host key &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leetschau.github.io/posts/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Dark Matter in Cyberspace" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dark Matter in Cyberspace</a></h1>
  
    <h2>A notes repository for Meteor.js, data mining, Linux, etc.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="leetschau.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/19/231213/">Remove Key From Known_hosts</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-19T23:12:13+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>11:12 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you use some virtual host with the same IP,
you will always see messages below:</p>

<pre><code>$ ssh ansible@console.newfairs-inc.com
Warning: the ECDSA host key for 'console.newfairs-inc.com' differs
from the key for the IP address '192.168.100.201'
Offending key for IP in /home/user/.ssh/known_hosts:48
Matching host key in /home/user/.ssh/known_hosts:39
Are you sure you want to continue connecting (yes/no)? 
</code></pre>

<p>Or something like this:</p>

<pre><code>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@       WARNING: POSSIBLE DNS SPOOFING DETECTED!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
The RSA host key for foo-bar.net has changed,
and the key for the corresponding IP address 127.0.0.1
is unchanged. This could either mean that
DNS SPOOFING is happening or the IP address for the host
and its host key have changed at the same time.
Offending key for IP in /home/user/.ssh/known_hosts:6
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
</code></pre>

<p>Notice the line &ldquo;Offending key for IP in /home/user/.ssh/known_hosts:48&rdquo;
in the first example, and &ldquo;&hellip;/known_hosts:6&rdquo; in the second,
it shows the 48th (or 6th) line should be removed from $HOME/.ssh/known_hosts:</p>

<pre><code>sed -i '48d' ~/.ssh/known_hosts
</code></pre>

<p>Ref:
<a href="http://superuser.com/questions/30087/remove-key-from-known-hosts">Remove key from known_hosts</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/13/174140/">Pretty-print JSON in Command Line</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-13T17:41:40+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>5:41 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Option 1:</p>

<pre><code>npm install -g json
echo '{"foo": "lorem", "bar": "ipsum"}' | json
</code></pre>

<p>Option 2:</p>

<pre><code>echo '{"foo": "lorem", "bar": "ipsum"}' | python -m json.tool
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/11/104458/">Add Executable Into Windows 7's PATH</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-11T10:44:58+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:44 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To add stand-alone app <a href="http://www.flos-freeware.ch/notepad2.html">notepad2</a>
and <a href="http://ditto-cp.sourceforge.net/">ditto</a>
into the Windows system path, write below into file &ldquo;modifyPath.bat&rdquo;,
and run it &ldquo;as administrator&rdquo;:</p>

<pre><code>setx /M PATH "%PATH%;d:\apps\Ditto;d:\apps\notepad2_4.2"
</code></pre>

<p>Now you can press &ldquo;Win&rdquo; key, input &ldquo;ditto&rdquo; (or notepad),
you can see &ldquo;Ditto&rdquo; (or notepad2) program.
Open a console, run <code>echo %PATH%</code>,
you can see Ditto and notepad2&rsquo;s folder has been added into PATH.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/09/195735/">Mongo-connector Dump Error and Solutions</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-09T19:57:35+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>7:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When I synchronize data from a mongodb to a elasticsearch server with
<code>mongo-connector -m 192.168.100.3:27017 -t http://192.168.100.24:9200
 -d elastic_doc_manager --admin-username root --password xxx</code>,
the mongo-connector process quit with the following logs in
&ldquo;mongo-connector.log&rdquo; (all texts behind &ldquo;BulkIndexError&rdquo; are in the same line,
I rearrange the line for easy to understand):</p>

<pre><code>2016-01-09 19:05:52,457 [CRITICAL] mongo_connector.oplog_manager:543 - Exception during collection dump
Traceback (most recent call last):
  File "/usr/local/lib/python2.7/dist-packages/mongo_connector/oplog_manager.py", line 495, in do_dump upsert_all(dm)
  ...
BulkIndexError: (u'10 document(s) failed to index.',
  [
    {
      u'index': {
        u'status': 400,
        u'_type': u'Fair',
        u'_id': u'4zWhZTJnqPCd2RK93',
        u'error': {
          u'caused_by': {
            u'reason': u'unknown property [latitude]',
            u'type': u'illegal_argument_exception'},
            u'reason': u'failed to parse [recurrence.location]',
            u'type': u'mapper_parsing_exception'},
            u'_index': u'staging'
      }
    },
    ...
  ]
</code></pre>

<p>When mongo-connector parse a document with <code>_id: 4zWhZTJnqPCd2RK93</code>
in Collection &ldquo;Fair&rdquo;, it &ldquo;failed to parse [recurrence.location]&rdquo;.
From <code>_index: staging</code>, we know collection Fair is in mongodb database &ldquo;staging&rdquo;.</p>

<p>List all &ldquo;recurrence.location&rdquo; of each document in staging database:</p>

<pre><code>$ mongo 192.168.100.3:27017/staging -u xxx -p xxx
foba:PRIMARY&gt; db.Fair.find({}, {"recurrence.location": 1})
{ "_id" : "h7Lo3hGLrFGEb6BK7", "recurrence" : [ { "location" : { "latitude" : 22.53, "longitude" : 114.06 } } ] }
{ "_id" : "Kd2e9w58P7vAScLDL", "recurrence" : [ { "location" : "" } ] }
{ "_id" : "4zWhZTJnqPCd2RK93", "recurrence" : [ { "location" : { "latitude" : 22.53, "longitude" : 114.06 } } ] }
</code></pre>

<p>It&rsquo;s now clear that the exception in synchronization is caused by
different structure of &ldquo;recurrence.location&rdquo;.</p>

<p>To guarantee mongo-connector synchronizing successfully,
you must keep all document in a collection share the same schema.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/08/162914/">Remove Duplicate Zsh History</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-08T16:29:14+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>4:29 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To remove duplicate items in <a href="https://github.com/junegunn/fzf">fzf</a> prompt,
add the following lines into ~/.zshrc:</p>

<pre><code>setopt EXTENDED_HISTORY
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_FIND_NO_DUPS
setopt HIST_SAVE_NO_DUPS
setopt HIST_BEEP
</code></pre>

<p>Ref:</p>

<p><a href="https://wiki.archlinux.org/index.php/zsh#Preventing_duplicate_lines_in_the_history">Preventing duplicate lines in the history</a></p>

<p><a href="https://github.com/mattjj/my-oh-my-zsh/blob/master/history.zsh">https://github.com/mattjj/my-oh-my-zsh/blob/master/history.zsh</a></p>

<p><a href="http://zsh.sourceforge.net/Doc/Release/Options.html">zsh options</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/08/125827/">Ansible Notes</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-08T12:58:27+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:58 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>使用源代码版本的ansible</h1>

<p>按照<a href="http://docs.ansible.com/ansible/intro_installation.html#running-from-source">Running From Source</a>,
首先安装依赖包 (<code>sudo pip install paramiko PyYAML Jinja2 httplib2 six</code>),
clone ansible的github repo, 然后配置环境变量，就可以使用ansible的各个版本了。</p>

<pre><code>git clone git://github.com/ansible/ansible.git --recursive $HOME/apps
</code></pre>

<p>需要使用ansible时，运行：</p>

<pre><code>source $HOME/apps/ansible/hacking/env-setup
</code></pre>

<p>默认是devel分支，如果要切换到稳定版分支，首先列出所有分支：<code>git branch -ra</code>，
然后切换到此分支上：</p>

<pre><code>cd $HOME/apps/ansible
git checkout origin/stable-2.0.1
source $HOME/apps/ansible/hacking/env-setup
</code></pre>

<p>更新代码库：</p>

<pre><code>cd $HOME/apps/ansible
git pull --rebase
git submodule update --init --recursive
</code></pre>

<h1>lookup ini plugin</h1>

<p>通过pip安装的ansible是1.9.4版本，这一版没有lookup ini plugin.
在<a href="http://docs.ansible.com/ansible/playbooks_lookups.html#the-ini-file-lookup">The INI File Lookup</a>
下可以看到 &ldquo;New in version 2.0.&rdquo;.</p>

<p>运行下面的task时，</p>

<pre><code>- debug: msg="User in integration is "
</code></pre>

<p>会报错：</p>

<blockquote><p>lookup plugin (ini) not found</p></blockquote>

<p>用pip安装后，所有的lookup plugin的安装目录是
/usr/local/lib/python2.7/dist-packages/ansible/runner/lookup_plugins
下面没有ini.py.</p>

<p>解决方法见上节使用源代码版本的ansible.</p>

<p>有了ini lookup plugin, 可以在ansible的roles/<role-name>/tasks/main.yml中
引用ansible变量和外部ini文件：</p>

<pre><code>- name: download codes to laptop
  local_action: &gt;
    command
</code></pre>

<p>相关的文件：</p>

<pre><code>cat $ANSIBLE_PRJ_HOME/roles/deploy/vars/main.yml 
repo_base: "~/temp"
timestamp: ""
repo_name: "-"
local_repo: "/"
target_branch: "develop"
ext_path: "/"
nodejs_bin_path: ":/opt/node-v0.10.40-linux-x64/bin"
app_settings: "~/docs/website/v3/settings.json"
env_settings: "~/docs/website/v3/serverEnv.ini"

cat ~/docs/website/v3/serverEnv.ini
[common]
PORT=3000

[p21.newfairs-inc.com]
MONGO_URL=mongodb://dba:dba@192.168.100.3:27017/production
ROOT_URL=http://www.newfairs.net
GIT_REPO=git clone ssh://git@git.newfairs-inc.com/diffusion/NEWFAIRS/newfairs.git

[p22.newfairs-inc.com]
MONGO_URL=mongodb://dba:dba@192.168.100.3:27017/production
ROOT_URL=http://www.newfairs.net
GIT_REPO=git clone ssh://git@git.newfairs-inc.com/diffusion/NEWFAIRS/newfairs.git

[beta-app.newfairs-inc.com]
MONGO_URL=mongodb://dba:dba@192.168.100.3:27017/production
ROOT_URL=http://beta.newfairs.com
GIT_REPO=git clone ssh://git@git.newfairs-inc.com/diffusion/NEWFAIRS/newfairs.git

[console.newfairs-inc.com]
MONGO_URL=mongodb://dba:dba@192.168.100.3:27017/console
ROOT_URL=http://console.newfairs-inc.com
GIT_REPO=git clone ssh://git@git.newfairs-inc.com/diffusion/CONSOLE/newfairs-console.git
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/30/162805/">Wordpress中文文章详情页无法打开问题</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-30T16:28:05+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:28 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Wordpress Dashboard -> Settings -> Permalinks -> Common Settings:
Plain（或者Numeric）。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/29/134651/">青云的负载均衡器</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-29T13:46:51+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:46 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>青云把负载均衡器抽象成了三个概念：一是负载均衡器本身；二是监听器，三是后端主机。
监听器代表负载均衡器对外提供的协议类型和端口；
后端主机页面上的"端口"指的是后端主机上服务进程监听的端口。</p>

<p>只要用户创建负载均衡器、监听器、主机，就可以在界面里头完成负载均衡器的所有操作。</p>

<p>一条转发策略，代表一条从域名到主机和端口的关联规则，所以如果是同一个服务有多个域名，
可以配置在同一个转发策略里。
如果是两个不同的服务，即使是同一IP不同端口，也要配置在不同的转发策略里。</p>

<h1>示例</h1>

<h2>添加第一个服务</h2>

<p>需要将内网中的一台服务器作为beta服务器，
外部用户可以通过域名 beta.nufair.com 从公网访问，实现方法：</p>

<ol>
<li><p>在青云控制台 [计算与网络 -> 公网IP]中购买IP地址 nufairIP: 123.234.34.5</p></li>
<li><p>在域名 (nufair.com) DNS配置中增加一条A记录：beta -> 123.234.34.5</p></li>
<li><p>新建 [路由器] nufairRouter, 绑定nufairIP;</p></li>
<li><p>新建 [私有网络] nufairNet, 绑定nufairRouter;</p></li>
<li><p>新建 [主机] beta-app.nufair.com, IP: 192.168.100.121, 加入 nufairNet;</p></li>
<li><p>在 beta-app.nufair.com 中部署应用，服务监听端口 3000;</p></li>
<li><p>新建 [负载均衡器] nufairLB, IP：192.168.100.4, 绑定nufairNet;</p></li>
<li><p>[nufairRouter -> 端口转发]中添加规则 http-route: tcp 80 -> 192.168.100.4 80</p></li>
<li><p>[nufairRouter -> 基本属性]中点击[防火墙]，在其中增加规则：允许80端口下行；</p></li>
<li><p>[nufairLB -> 转发策略] 中新建转发策略:</p>

<blockquote><p>名称：app-beta
匹配方式：匹配任意规则</p></blockquote>

及其规则：

<blockquote><p>规则类型: 按域名转发
规则内容: beta.nufair.com</p></blockquote></li>
<li><p>nufairLB 中新建一个[监听器] http-listener, 为其[添加后端]，</p>

<blockquote><p>名称：beta
网络：受管私有网络
主机：192.168.100.121
端口：3000</p></blockquote>

<p>创建完成后，在[转发策略]一栏中点击[绑定]，选择[app-beta].</p></li>
</ol>


<h2>添加第二个服务</h2>

<p>需要将内网中另一台服务器作为生产服务器，通过域名nufair.com和www.nufair.com访问。</p>

<ol>
<li><p>青云控制台中购买一台主机，IP: 192.168.100.21, 在上面部署生产应用，服务监听端口3000;</p></li>
<li><p>在域名 (nufair.com) DNS配置中增加两条A记录：
@ -> 123.234.34.5
www -> 123.234.34.5</p></li>
<li><p>[nufairLB -> 转发策略] 中新建转发策略:</p>

<blockquote><p>名称：app-production
匹配方式：匹配任意规则</p></blockquote>

及其规则：

<blockquote><p>规则类型: 按域名转发
规则内容: nufair.com www.nufair.com</p></blockquote></li>
<li><p><a href="">nufairLB -> http-listener -> 添加后端</a>:</p>

<blockquote><p>名称：prod
网络：受管私有网络
主机：192.168.100.21
端口：3000</p></blockquote>

<p>创建完成后，在[转发策略]一栏中点击[绑定]，选择[app-production].</p></li>
</ol>


<p>说明：</p>

<p>转发策略的规则里，如果是按域名转发，注意一级域名，如nufair.com，
它实际上是<code>*.nufair.com</code>，当监听器的某个后端绑定了这样的规则后，
它后面的后端再绑定这个一级域名下的二级域名将无效，
例如将test.nufair.com指向100.21服务器的4500端口，</p>

<p>[nufairLB -> 转发策略] 中新建转发策略:</p>

<blockquote><p>名称：app-test
匹配方式：匹配任意规则</p></blockquote>

<p>  及其规则：</p>

<blockquote><p>规则类型: 按域名转发
规则内容: test.nufair.com</p>

<p>名称：test
网络：受管私有网络
主机：192.168.100.21
端口：4500</p></blockquote>

<p>  创建完成后，在[转发策略]一栏中点击[绑定]，选择[app-test].</p>

<p>应用修改后，test.nufair.com仍然指向3000端口上的服务，
原因是它作为nufair.com的二级域名，被app-production中的一级域名覆盖了，
解决方法是，从app-production中去掉"nufair.com".</p>

<p>修改负载均衡器IP地址后需要注意：
要相应修改路由器中端口转发中目标（也就是负载均衡器）的IP地址。</p>

<p>参考：</p>

<p><a href="http://network.51cto.com/art/201504/472491.htm">青云QingCloud：云上最强负载均衡服务</a></p>

<p><a href="https://docs.qingcloud.com/guide/loadbalancer.html">负载均衡器指南</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/27/185843/">Move Some Commit From One Repo to Another</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-27T18:58:43+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:58 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We need move all commit between origin/develop to develop in an old repo
to a new repo.</p>

<p>Export all commits in old repo:</p>

<pre><code>cd /path/to/old-repo
git format-patch origin/develop..develop
</code></pre>

<p>Now you have many .patch files in old repo.
Each patch file represents a commit between origin/develop and develop.</p>

<p>Apply these patches in new repo:</p>

<pre><code>cd /path/to/new-repo
git checkout develop
git am /path/to/old-repo/*.patch
</code></pre>

<p>Ref:</p>

<p><a href="http://stackoverflow.com/questions/5062389/getting-started-with-git-am">Getting started with git-am</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/25/102101/">WebSocket Error 400 in Meteor App</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-25T10:21:01+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:21 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I deploy a Meteor app, and proxy it with nginx.
When connect to the app server, there&rsquo;s a websocket error:</p>

<p>WebSocket connection to &lsquo;ws://prod-app-192-168-100-21.newfairs-inc.com/sockjs/311/ud_4e5xf/websocket&rsquo; failed:
Error during WebSocket handshake: Unexpected response code: 400</p>

<p>Solution:</p>

<pre><code>cat /etc/nginx/sites-enabled/newfairs
server {
  server_name prod-app-192-168-100-21.newfairs-inc.com;
  location / {
    proxy_pass http://localhost:3000/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}
</code></pre>

<p>Ref:</p>

<p><a href="http://stackoverflow.com/questions/17014969/meteor-websocket-handshake-error-400-with-nginx">Meteor WebSocket handshake error 400 with nginx</a></p>

<p><a href="http://nginx.org/en/docs/http/websocket.html">WebSocket proxying</a></p>

<p><a href="http://stackoverflow.com/questions/30171179/meteor-websocket-connection-to-ws-websocket-failed-error-during-websock">http://stackoverflow.com/questions/30171179/meteor-websocket-connection-to-ws-websocket-failed-error-during-websock</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/3">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/index.html">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/02/21/110422/">3月6日演讲提纲</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/20/010838/">Merge Multiple PDF Files in Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/16/212514/">Debug Python Script</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/09/120142/">Golang Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/07/103930/">Cabal Notes</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leetschau">@leetschau</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leetschau',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Li Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
