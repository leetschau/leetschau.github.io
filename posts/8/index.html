
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dark Matter in Cyberspace</title>
  <meta name="author" content="Li Chao">

  
  <meta name="description" content="sar On CentOS 6.5, install sysstat with yum install sysstat.
And the cron jobs will be created in /etc/cron.d/sysstat.
The default routines defined &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leetschau.github.io/posts/8/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Dark Matter in Cyberspace" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dark Matter in Cyberspace</a></h1>
  
    <h2>A notes repository for Meteor.js, data mining, Linux, etc.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="leetschau.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/28/114611/">System Monitor Tools for Linux Server</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-28T11:46:11+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:46 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>sar</h1>

<p>On CentOS 6.5, install sysstat with <code>yum install sysstat</code>.
And the cron jobs will be created in /etc/cron.d/sysstat.
The default routines defined in this file is running system activity accounting every 10 minutes,
and generating a daily summary of process accounting at 23:53 each day.</p>

<p>Now you can see system memory usage hisory with <code>sar -r 2 5</code>,
which means display memory usage every 2 seconds, 5 times totally.</p>

<p>To see the memory history: <code>sar -r -f /var/log/sa/sa28</code>,
the total free memory is the sum of 3 items: kbmemfree, kbbuffers, kbcached.</p>

<p>Refs:</p>

<ul>
<li><p><a href="https://www.thomas-krenn.com/en/wiki/Collect_and_report_Linux_System_Activity_Information_with_sar">https://www.thomas-krenn.com/en/wiki/Collect_and_report_Linux_System_Activity_Information_with_sar</a></p></li>
<li><p><a href="http://serverfault.com/questions/85470/meaning-of-the-buffers-cache-line-in-the-output-of-free.">http://serverfault.com/questions/85470/meaning-of-the-buffers-cache-line-in-the-output-of-free.</a></p></li>
</ul>


<h1>dstat</h1>

<p>On CentOS 6.5, install dstat with <code>yum install dstat</code>.</p>

<p>Log the memory usage with <code>dstat --output memlog.csv -t -m 600 500</code>,
which will log totally 500 times, with a 10-minute interval.</p>

<h1>Glances</h1>

<p>Install it with <code>curl -L http://bit.ly/glances | /bin/bash</code>.
This only works on Linode node.
It failed on my loptop with message &ldquo;connection reset by peer&rdquo;.
On the Linode node, the installation failed with &ldquo;yum&rdquo; and &ldquo;pip&rdquo;.
It seems the reason is the dependencies are not met.</p>

<p>Use it with <code>glances</code> with root, or <code>glances -w</code> as a web server.
Then you can see the status of your server with url &ldquo;<a href="http://104.237.135.143:61208">http://104.237.135.143:61208</a>&rdquo;.</p>

<p>For keep a system log, use <code>glances -t 600 --export-csv /tmp/glances.csv</code>,
which means write a csv-format log every 10 minutes (3 seconds by default) to /tmp/glances.csv.</p>

<p>P.S.: There&rsquo;s also a <a href="http://munin-monitoring.org/">Munin</a>.
It seems the installation is complex, so I gave up.</p>

<h1>collectl</h1>

<p>Install with <code>yum install collectl</code>.</p>

<p>Print memeory usage with <code>collectl -i 2 -c 5 -sm</code>.</p>

<p>Print all subsystems with <code>collectl --showsubsys</code>.</p>

<p>Log output information with &ldquo;-f&rdquo; options: <code>collectl -sm -i 2 -c 5 -f mylog</code>.
It creates a gz file, which you have to extract with <code>gzip -d mylog...</code>.</p>

<p>Ref: <a href="http://lintut.com/best-command-line-tools-for-linux-performance-monitring/">http://lintut.com/best-command-line-tools-for-linux-performance-monitring/</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/25/141712/">The Algorithm of Related Fairs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-25T14:17:12+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:17 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For a given fair A, it&rsquo;s <em>major category</em> are a set of its cat.major subdocuments.</p>

<p>For example, for the fair:</p>

<pre><code>{ cat: [ { major: "abc", minor: [ 1,23,3] }, { major: "xyz", minor: [ 3, 23, 583]} ] }
</code></pre>

<p>its major categories are set [&ldquo;abc, "xyz&rdquo;].
Here we say the major categories of fair X is <code>majorCat(X)</code>.</p>

<p>If the intersection of set <code>majorCat(X)</code> and <code>majorCat(Y)</code> are not empty,
we say fair X and Y are <em>related</em>.</p>

<p>So for a given fair X, how to find all its related fairs in a collection?</p>

<p>Here is the demonstration:</p>

<p>In mongodb, create a test collection with the following codes:</p>

<pre><code>db.cats.insert( { cat: [ { major: "abc", minor: [ 1,23,3] }, { major: "xyz", minor: [ 3, 23, 583]} ] } );
db.cats.insert( { cat: [ { major: "abcd", minor: [ 1,23,3] }, { major: "xyzu", minor: [ 87, 987, 343]} ] } );
db.cats.insert( { cat: [ { major: "bcd", minor: [ 1,23,3] }, { major: "abc", minor: [ 3, 23, 876]} ] } );
db.cats.insert( { cat: [ { major: "xyz", minor: [ 8,83,5] }, { major: "axc", minor: [ 34, 3, 76]} ] } );
</code></pre>

<p>Create a new Meteor app with <code>meteor create relatedFairs</code>, and its files:</p>

<p>relatedFairs.html</p>

<pre><code>&lt;head&gt;
  &lt;title&gt;relatedFairs&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;h1&gt;Find related fairs&lt;/h1&gt;

&lt;/body&gt;

&lt;template name="hello"&gt;
  &lt;ul&gt;

      &lt;li&gt; 
        &lt;b&gt;:&lt;/b&gt;

          ,

      &lt;/li&gt;

  &lt;/ul&gt;

    &lt;p&gt;Related fairs of the first fair &lt;/p&gt;
    &lt;ul&gt;

        &lt;li&gt;
          &lt;b&gt;:&lt;/b&gt;

            ,

        &lt;/li&gt;

    &lt;/ul&gt;

&lt;/template&gt;
</code></pre>

<p>relatedFairs.js:</p>

<pre><code>Fairs = new Mongo.Collection("cats");

if (Meteor.isClient) {
  Template.hello.helpers({
    allFairs: function () {
      return Fairs.find();
    },
    related: function () {
      var theXrd = 0,
          theFair = Fairs.findOne( {}, {skip: theXrd } );
      if (! theFair) {
        return null;
      }
      var majors = _.map(theFair.cat, function(i) { return i.major; } );
      var rels = Fairs.find( { cat: { $elemMatch: { major: { $in: majors } } },
                               _id: { $ne: theFair._id } } );
      return {firstID: theFair._id._str, relatedFairs: rels };
    }
  });
}
</code></pre>

<p>Here we use <a href="http://underscorejs.org/">Underscore.js</a>,
so install this package with <code>meteor add underscore</code> to run our demo app
(with <code>MONGO_URL="mongodb://localhost:27017/test" meteor</code> in project root folder).</p>

<p>Modify the value of &ldquo;theXrd&rdquo; above, you can see the related fairs of each fair.</p>

<p>To make a demo in a production collection,
in fair &ldquo;A&rdquo; we find a major category called &ldquo;垃圾车与运输车"，
then choose a fair B, whose id is "54e71a5642fb549b1389ae6f&rdquo;.</p>

<p>Let&rsquo;s add the major cateory to fair B:</p>

<pre><code>db.fairs.update( { _id: ObjectId("54e71a5642fb549b1389ae6f") }, { $push: {category: {major: "垃圾车与运输车"}} } );
</code></pre>

<p>Now fair A and B is related. Test them on your web site.
If the test is past, remove the test data from fair B:</p>

<pre><code>db.fairs.update( { _id: ObjectId("54e71a6642fb549b1389ae6f") }, { $pop: { category: 1 } } );
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/20/224401/">Test Underscore Functions of Meteor App</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-20T22:44:01+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:44 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When you add some underscore functions to your meteor app, you can&rsquo;t test it in browser console.
So we need test it somewhere else.</p>

<ol>
<li><p>Create a new folder as the test project root;</p></li>
<li><p>Install underscore package locally, which means the package is specific for this project;</p></li>
<li><p>Create a node script to test the underscore functions.</p></li>
</ol>


<p>The whole work flow is like this:</p>

<pre><code>$ mkdir myapp
$ cd myapp
$ npm install underscore
$ cat &lt;&lt; EOF &gt; myfunc.js
var _ = require('underscore');
var res = _.map([1, 2, 3], function(num){ return num * 3; });
console.log(res);
EOF
$ node myfunc
[ 3, 6, 9 ]
</code></pre>

<p>You can&rsquo;t use <code>var _ = require('underscore');</code> in node REPL shell, for node shell use &ldquo;_&rdquo; to hold the last result.</p>

<p>Note:</p>

<ol>
<li><p>See <a href="https://docs.npmjs.com/misc/faq#why-cant-npm-just-put-everything-in-one-place-like-other-package-managers">Why can&rsquo;t npm just put everything in one place, like other package managers? on npm&rsquo;s FAQ</a>
for the reason why npm not install pakcage globally like pip.</p></li>
<li><p>For node, how to determine install a package locally or globally?
According to <a href="http://blog.nodejs.org/2011/03/23/npm-1-0-global-vs-local-installation/">npm 1.0: Global vs Local installation</a></p>

<ol type="a">
<li><p> If you’re installing something that you want to use in your program, using require(&lsquo;whatever&rsquo;), then install it locally, at the root of your project.</p></li>
<li><p> If you’re installing something that you want to use in your shell, on the command line or something, install it globally, so that its binaries end up in your PATH environment variable. For example, install <a href="http://bower.io/">bower</a> with <code>npm install bower -g</code>.</p></li>
</ol>
</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/20/194901/">Import Data for Newfairs.com</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-20T19:49:01+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Prerequisites</h1>

<p>First install MongoDB, node.js and csvkit.</p>

<p>For node.js, download node binary package (node-v0.10.33-linux-x64.tar.gz in my case) from its website,
extract and add binary folder into $PATH. For example, add the following line into ~/.zshenv:</p>

<pre><code>PATH=$HOME/apps/node-v0.10.33-linux-x64/bin:$PATH
</code></pre>

<p>For MongoDB, download its binary package (mongodb-linux-x86_64-2.6.5.tgz in my case) from its website,
extract and add binary folder into $PATH:</p>

<pre><code>PATH=$HOME/apps/mongodb-linux-x86_64-2.6.5/bin:$PATH
</code></pre>

<p>Install csvkit with <code>sudo pip install csvkit</code>.</p>

<h1>Preparation</h1>

<ol>
<li><p>Convert Excel (xls/xlsx) file to csv file: <code>in2csv data.xls &gt; data.csv</code>;</p></li>
<li><p>(Optional) Convert file encoding: <code>iconv -f gbk -t utf8 data20150218.csv &gt; input.csv</code>;</p></li>
<li><p>Examine data: <code>head input.csv | csvjson -i 4</code>;</p></li>
<li><p>Start MongoDB server for importing data: <code>mongod</code>;</p></li>
</ol>


<h1>Import Data</h1>

<p>In case you want to overwrite old data, you need backup old collection:
start a mongodb client, make a copy of the old collection (the original collection is &ldquo;fairs&rdquo;):</p>

<pre><code>$ mongo
&gt; db.fairs.renameCollection('fairsBak')
</code></pre>

<p>P.S. You can make a copy of a collection with <code>db.fairs.copyTo('fairsBak')</code>.</p>

<p>Now import new data to collection &ldquo;fairs&rdquo;:</p>

<pre><code>./importdata
</code></pre>

<h1>Under the hood</h1>

<p>importdata:</p>

<pre><code>#!/bin/bash

# convert the csv file encoding with:
# iconv -f gbk -t utf8 xxx.csv &gt; input.csv
INP='input.csv'
TargetDB='test'
TargetCol='fairs'

RAW='rawdata.json'
RES='result.json'
if [[ ! -f $INP ]]; then
  echo File input.csv not exists!
  exit 1
fi
rm -rf $RAW $RES
csvjson $INP &gt; $RAW
node checkTransform
mongoimport -d $TargetDB -c $TargetCol --type json --file $RES --jsonArray
rm -rf $RAW $RES
</code></pre>

<p>checkTransform.js:</p>

<pre><code>var data = require('./rawdata.json');
var fs = require('fs');
var result = []

data.forEach(function(elem) {
  var aFair = JSON.parse( JSON.stringify(elem) );
  aFair.indexStr = {};
  aFair.indexStr['name'] = (elem.chnName + ' ' + elem.engName).trim();
  aFair.indexStr['sponsor'] = elem.sponsor;
  aFair.indexStr['undertaker'] = elem.undertaker;
  aFair.indexStr['category'] = elem.category;
  aFair.indexStr['simpleSearch'] = elem.chnName + ' ' + elem.engName + ' ' + elem.position + ' ' + elem.time + ' ' + elem.category;

  if (elem.sponsor) {
    aFair['sponsor'] = [];
    elem.sponsor.split('|').forEach(function(spr) {
      var aSponsor = {};
      var sps = spr.split('$');
      aSponsor['name'] = sps[0];
      aSponsor['tel'] = sps[1];
      aSponsor['fax'] = sps[2];
      aSponsor['email'] = sps[3];
      aSponsor['website'] = sps[4];
      aFair.sponsor.push(aSponsor);
    });
  }

  if (elem.undertaker) {
    aFair['undertaker'] = [];
    elem.undertaker.split('|').forEach(function(udt) {
      var aUndertaker = {};
      var uds = udt.split('$');
      aUndertaker['name'] = uds[0];
      aUndertaker['tel'] = uds[1];
      aUndertaker['fax'] = uds[2];
      aUndertaker['email'] = uds[3];
      aUndertaker['website'] = uds[4];
      aFair.undertaker.push(aUndertaker);
    });
  }

  if (elem.category) {
    aFair['category'] = [];
    elem.category.split('|').forEach(function(catStr) {
      var aCat = {};
      var cats = catStr.split('$');
      aCat['major'] = cats[0] === '?' ? '' : cats[0];
      aCat['minor'] = cats.slice(1);
      aFair.category.push(aCat);
    });
  }

  result.push(aFair);
});

fs.writeFile('result.json', JSON.stringify(result));
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/18/105314/">超链接中data-toggle属性使用新的Session</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-18T10:53:14+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:53 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>如果在超链接中将"data-toggle"属性设为"modal"，如下所示，则超链接所指向的窗体将使用新的Seesion。</p>

<pre><code>&lt;a href="/register" data-toggle="modal"&gt;注册新帐号&lt;/a&gt;
</code></pre>

<p>比如我们想在每次跳转后将当前url记录在Session变量"currentUrl"中，
但是在url以"login"和"register"结尾时不更新"currentUrl"：</p>

<pre><code>Router.onAfterAction(function(){
  if (! (Router.current() &amp;&amp; Router.current().url) ) {
    return;
  }
  var currentUrl = Router.current().url;
  if ( (currentUrl.indexOf('login') &lt; 0 ) &amp;&amp;
        currentUrl.indexOf("register") &lt; 0 ) {
    Session.set("currentUrl", currentUrl);
  }
});
</code></pre>

<p>然后在登录或者注册成功后取出这个缓存的变量，利用callback函数跳转回之前的页面：</p>

<pre><code>Accounts.createUser({
  email: t.find("#userEmail").value,
  password: t.find("#userPwd").value,
  profile: {
    nickname: t.find("#userNickname").value,
    role: userRole.value,
    gender: gender.value,
    desc: userDesc
  }
}, function(error) {
  if (error) {
    alert("something wrong, registration failed.");
  } else {
    alert("注册并登录成功！");
    var currentUrl = Session.get("currentUrl");
    var tmp = document.createElement('a');
    tmp.href = currentUrl;
    var currentPath = tmp.pathname + tmp.search;
    Router.go(currentPath);
  }
});
</code></pre>

<p>那么当点击上面的超链接时，所有Session对象都被清空，"currentUrl"值变为"undefined"，
如果用<code>Session.setDefault("currentUrl", "aabb");</code>设置默认值，
则点击上面的超链接后"currentUrl"值变为"aabb"，
然后再执行Router.onAfterAction中的callback函数。</p>

<p>这样前面利用缓存变量跳转回原来页面的设计就失效了，页面跳转到"/undefined"页面，
解决办法很简单：去掉超链接中的data-toggle属性，变为一个普通超链接：</p>

<pre><code>&lt;a href="/register"&gt;注册新帐号&lt;/a&gt;
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/13/153724/">使用星星图标获取用户评分</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-13T15:37:24+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>使用一个数组，评分为3对应着：</p>

<p>html:</p>

<pre><code>  &lt;span class="glyphicon  text-danger"&gt;&lt;/span&gt;
</code></pre>

<p>js:</p>

<pre><code>Template.UserEvaluations.helpers({
  rankicons: function() {
    return ['glyphicon-star', 'glyphicon-star', 'glyphicon-star', 'glyphicon-star-empty', 'glyphicon-star-empty'];
  }
});
</code></pre>

<p>Ref:</p>

<p><a href="http://stackoverflow.com/questions/14189672/meteor-iterate-list-in-template">http://stackoverflow.com/questions/14189672/meteor-iterate-list-in-template</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/08/163932/">在Meteor应用中计算用户评分平均值</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-08T16:39:32+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>以下方法使用的客户端展现代码(html)是一样的：
<code>&lt;h2&gt;展会评分：&lt;span class="label label-success"&gt;&lt;/span&gt;&lt;/h2&gt;</code>.</p>

<h1>使用MapReduce</h1>

<p>MapReduce一次性将所有展会的用户评分平均值计算出来，优点是每次用户请求页面时不需要计算，直接从计算结果中取值。
缺点是实时性差，由于MapReduce计算比较耗时，且计算结果存储在一个单独的collection中，
新的计算结果会覆盖旧的，所以不能一次只计算一个展会的平均值（因为计算结果collection会覆盖掉有来包含所有结果的collection），
只能在服务清闲的时间（比如凌晨）进行一次批量计算。</p>

<p>在MongoDB中运行mapReduce：</p>

<pre><code>db.userComments.mapReduce(
    function(){ emit(this.fairId, this.rank); },
    function(key, values) { return Array.avg(values); },
    { out: "rank_avg" }
);
</code></pre>

<p>客户端控制器(js):</p>

<pre><code>UserAvgRank = new Mongo.Collection("rank_avg");

Template.UserComments.helpers({
  rankAverage: function() {
    var rec = UserAvgRank.findOne({ _id: Router.current().params._id });
    return Math.round(rec.value * 10) / 10;
  }
});
</code></pre>

<h1>aggregate计算平均值</h1>

<p>使用MongoDB collection的aggregate方法在用户请求时实时计算平均值，优缺点与MapReduce方法正好相反。</p>

<p>在Meteor 1.0.3版本中，不支持collection的aggregate方法，
可以通过安装meteorhacks:aggregate包的方法解决这个问题，但这个方法也只能运行在服务端。</p>

<pre><code>Template.UserComments.helpers({
  rankAverage: function() {
    var rec = Comments.aggregate( [ {$match: {fairId: Router.current().params._id} }, { $group: {_id: "$fairId", avgRank: {$avg: "$rank"}} } ]);
    return Math.round(rec.avgRank * 10) / 10;
  }
});
</code></pre>

<h1>JavaScript手工计算</h1>

<p>也是一种实时计算方法，代码量最大，但版本依赖性小。</p>

<pre><code>Template.UserComments.helpers({
  rankAverage: function() {
    var rateNum = Comments.find().count();
    if (rateNum === 0) return false;
    var total = 0;
    Comments.find( {} ).forEach(function(elem) {
      total = total + elem.rank;
    });
    var avg = total / rateNum;
    return Math.round(avg * 10) / 10;
  }
});
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/04/152524/">A Meteor Modal Window</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-04T15:25:24+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:25 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>modal login</h1>

<p><template name="LoginModal">
  <button type="button" class="btn btn-link" data-toggle="modal" data-target="#loginForm">登录</button>
  <div class="modal fade" id="loginForm" tabindex="-1" role="dialog" aria-labelledby="mymodallabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="mymodallabel">登录</h4>
        </div>
        <div class="modal-body">
          <form id="userLogin" class="form-horizontal">
            <div class="form-group">
              <label for="inputEmail" class="col-sm-2 control-label">Email</label>
              <div class="col-sm-10">
                <input type="email" class="form-control" id="inputEmail" placeholder="Email">
              </div>
            </div>
            <div class="form-group">
              <label for="inputPassword" class="col-sm-2 control-label">密码</label>
              <div class="col-sm-10">
                <input type="password" class="form-control" id="inputPassword" placeholder="Password">
              </div>
            </div>
            <div class="form-group">
              <div class="col-sm-offset-2 col-sm-10">
                <div class="checkbox">
                  <label> <input type="checkbox">记住我</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="col-sm-offset-2 col-sm-10">
                还没有帐号？<a href="/register" data-toggle="modal">注册新帐号</a>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary">登录</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        </div>
      </div>
    </div>
  </div>
</template></p>

<h1>user login control</h1>

<p>if (Meteor.isServer) {
  Meteor.startup(function () {
    Accounts.onLogin(function(userObj) {
      Router.go(&ldquo;/&rdquo;);
    });</p>

<pre><code>Accounts.onLoginFailure(function(userObj) {
  console.log("wrong pwd for " + userObj.user.profile.nickname);
});
</code></pre>

<p>  });
}</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/03/174123/">几款开源文本编辑器比较</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-03T17:41:23+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>5:41 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Brackets</h1>

<p><a href="http://brackets.io/">Brackets</a>是一款面向Web开发的文本编辑器；</p>

<p>通过插件管理器实现vim模式支持，效果好；</p>

<p>修改字号方便：ctrl + =/-;</p>

<p>不修改项根目录；</p>

<p>不能像atom那样在命令行中将工作目录作为参数传入，比如在启动后设置；</p>

<p>打开文件夹快捷键：ctrl-alt-o;
打开文件快捷键：ctrl-shift-o, 在当前目录中模糊匹配；</p>

<p>分割窗口只有“不分割”，“横向分割”，“纵向分割”3种方式，且只能用鼠标操作，不方便；</p>

<p>在html中实时修改css文件：ctrl-e;</p>

<p>推荐插件：</p>

<ul>
<li><p>Brackets Vim: vim模式插件，可以使用ex命令（冒号开头的命令，如:w,:q等），需要与外界粘贴/拷贝文本，需要先在[File -> Enable Vim]中关闭vim模式，再用鼠标选择文本，再ctrl-c/v;</p></li>
<li><p>Command line shortcuts: 可以将命令行定义成快捷键；</p></li>
<li><p>Brackets Key Remapper: 目录[Debug -> Open Preferences File]，打开配置文件，修改默认快捷键，"view.hideSidebar"改为ctrl-alt-m；</p></li>
<li><p>Theme: 增加暗色方案；</p></li>
<li><p>Display Shortcuts: 显示可用的所有快捷键，可以搜索，很方便, ctrl-alt-/;</p></li>
</ul>


<h1>Atom</h1>

<p><a href="https://atom.io/">Atom</a>由Github出品，未来可能不完全开源;</p>

<p>启动速度慢；</p>

<p>对窗口分割、窗口尺寸切换的支持不太好；</p>

<p>全局搜索快捷键：Ctrl-Shift-P;
打开文件快捷键：Ctrl-P;</p>

<p>vi模式不能使用ex命令，操作不流畅；</p>

<h1>Zed</h1>

<p>体积比atom小一半，解压后直接运行，但其暗色主题都是灰色的，对比度不够；</p>

<p>会在项目根目录下创建一个.zeddata文件，如果使用git做项目管理的话，需要把这个文件加入到ignore列表中；</p>

<p>没有tab，可以水平分割为1～3个窗口，可以方便地在窗口间转移，这一点比atom强很多；</p>

<p>自动保存功能使得:w不再需要，但最Meteor这样自动更新的环境，自动保持会使应用频繁更新；</p>

<p>自带Vim模式，可以方便地使用vi快捷键；</p>

<h1>LightTable</h1>

<p>LightTable是一个Clojure开发环境，但也能作为一款通用文本编辑器；</p>

<p>打开命令自动搜索：ctrl-space;</p>

<p>安装vim插件：ctrl-space -> show plugin manager -> 输入vim，安装之，ex命令可用；与外部copy/paste需要在插入模式中用鼠标完成；</p>

<p>打开文件：ctrl-o;</p>

<p>总体而言无法替代vim；</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/01/134829/">Full Text Search for Meteor App</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-01T13:48:29+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>1:48 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For Meteor 1.0.3, the built-in database is mongodb 2.4, which is not support full text search by default.
So we need install a stand-alone MongoDB 2.6, create a &ldquo;meteor&rdquo; database, and let Meteor to use it as backend database:</p>

<p>First start MongoDB server: <code>mongod --dbpath ~/docs/mongodb-repo</code>;</p>

<p>Then create a new database &ldquo;meteor&rdquo; for Meteor app backend:</p>

<pre><code>$ mongo
&gt; show dbs
&gt; use meteor
</code></pre>

<p>Next start Meteor server and connect it with the Mongodb server:</p>

<pre><code>$ MONGO_URL="mongodb://localhost:27017/meteor" meteor
&gt; db.zips.getIndexes()
&gt; db.zips.dropIndex("forsearch_text")
&gt; db.zips.ensureIndex( {city: "text", state: "text"} )
&gt; db.zips.find( {$text: {$search: "lee ma"}} ).count()
488
</code></pre>

<p>Here <code>use meteor</code> create a new database in MongoDB (if it doesn&rsquo;t exists yet)
and use it as the current database.
Use <code>db</code> to get the current database name.</p>

<p>Ref:</p>

<p><a href="http://docs.mongodb.org/manual/tutorial/getting-started/">Getting Started with MongoDB</a></p>

<p><a href="http://docs.mongodb.org/manual/administration/indexes-text/">Text Search Tutorials of MongoDB 2.6.7</a>;</p>

<p><a href="http://docs.mongodb.org/manual/reference/operator/query/text/">$text query operator of MongoDB 2.6.7</a></p>

<p><a href="http://stackoverflow.com/questions/10610131/checking-if-a-field-contains-a-string">Checking if a field contains a string</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/9">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/7">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/09/24/185036/">Add a Local Meteor Package</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/23/123748/">Stack Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/22/104351/">Using Webstorm as Meteor IDE</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/22/092543/">Autosave in Webstorm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/21/092600/">Convert a Folder Into Meteor App in Webstorm</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leetschau">@leetschau</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leetschau',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Li Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
