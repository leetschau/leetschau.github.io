
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dark Matter in Cyberspace</title>
  <meta name="author" content="Li Chao">

  
  <meta name="description" content="使用一个数组，评分为3对应着： html: &lt;span class="glyphicon text-danger"&gt;&lt;/span&gt; js: Template.UserEvaluations.helpers({ rankicons: function() { return &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leetschau.github.io/posts/11/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Dark Matter in Cyberspace" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dark Matter in Cyberspace</a></h1>
  
    <h2>A notes repository for Meteor.js, data mining, Linux, etc.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="leetschau.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/13/153724/">使用星星图标获取用户评分</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-13T15:37:24+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>使用一个数组，评分为3对应着：</p>

<p>html:</p>

<pre><code>  &lt;span class="glyphicon  text-danger"&gt;&lt;/span&gt;
</code></pre>

<p>js:</p>

<pre><code>Template.UserEvaluations.helpers({
  rankicons: function() {
    return ['glyphicon-star', 'glyphicon-star', 'glyphicon-star', 'glyphicon-star-empty', 'glyphicon-star-empty'];
  }
});
</code></pre>

<p>Ref:</p>

<p><a href="http://stackoverflow.com/questions/14189672/meteor-iterate-list-in-template">http://stackoverflow.com/questions/14189672/meteor-iterate-list-in-template</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/08/163932/">在Meteor应用中计算用户评分平均值</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-08T16:39:32+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>以下方法使用的客户端展现代码(html)是一样的：
<code>&lt;h2&gt;展会评分：&lt;span class="label label-success"&gt;&lt;/span&gt;&lt;/h2&gt;</code>.</p>

<h1>使用MapReduce</h1>

<p>MapReduce一次性将所有展会的用户评分平均值计算出来，优点是每次用户请求页面时不需要计算，直接从计算结果中取值。
缺点是实时性差，由于MapReduce计算比较耗时，且计算结果存储在一个单独的collection中，
新的计算结果会覆盖旧的，所以不能一次只计算一个展会的平均值（因为计算结果collection会覆盖掉有来包含所有结果的collection），
只能在服务清闲的时间（比如凌晨）进行一次批量计算。</p>

<p>在MongoDB中运行mapReduce：</p>

<pre><code>db.userComments.mapReduce(
    function(){ emit(this.fairId, this.rank); },
    function(key, values) { return Array.avg(values); },
    { out: "rank_avg" }
);
</code></pre>

<p>客户端控制器(js):</p>

<pre><code>UserAvgRank = new Mongo.Collection("rank_avg");

Template.UserComments.helpers({
  rankAverage: function() {
    var rec = UserAvgRank.findOne({ _id: Router.current().params._id });
    return Math.round(rec.value * 10) / 10;
  }
});
</code></pre>

<h1>aggregate计算平均值</h1>

<p>使用MongoDB collection的aggregate方法在用户请求时实时计算平均值，优缺点与MapReduce方法正好相反。</p>

<p>在Meteor 1.0.3版本中，不支持collection的aggregate方法，
可以通过安装meteorhacks:aggregate包的方法解决这个问题，但这个方法也只能运行在服务端。</p>

<pre><code>Template.UserComments.helpers({
  rankAverage: function() {
    var rec = Comments.aggregate( [ {$match: {fairId: Router.current().params._id} }, { $group: {_id: "$fairId", avgRank: {$avg: "$rank"}} } ]);
    return Math.round(rec.avgRank * 10) / 10;
  }
});
</code></pre>

<h1>JavaScript手工计算</h1>

<p>也是一种实时计算方法，代码量最大，但版本依赖性小。</p>

<pre><code>Template.UserComments.helpers({
  rankAverage: function() {
    var rateNum = Comments.find().count();
    if (rateNum === 0) return false;
    var total = 0;
    Comments.find( {} ).forEach(function(elem) {
      total = total + elem.rank;
    });
    var avg = total / rateNum;
    return Math.round(avg * 10) / 10;
  }
});
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/04/152524/">A Meteor Modal Window</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-04T15:25:24+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:25 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>modal login</h1>

<p><template name="LoginModal">
  <button type="button" class="btn btn-link" data-toggle="modal" data-target="#loginForm">登录</button>
  <div class="modal fade" id="loginForm" tabindex="-1" role="dialog" aria-labelledby="mymodallabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="mymodallabel">登录</h4>
        </div>
        <div class="modal-body">
          <form id="userLogin" class="form-horizontal">
            <div class="form-group">
              <label for="inputEmail" class="col-sm-2 control-label">Email</label>
              <div class="col-sm-10">
                <input type="email" class="form-control" id="inputEmail" placeholder="Email">
              </div>
            </div>
            <div class="form-group">
              <label for="inputPassword" class="col-sm-2 control-label">密码</label>
              <div class="col-sm-10">
                <input type="password" class="form-control" id="inputPassword" placeholder="Password">
              </div>
            </div>
            <div class="form-group">
              <div class="col-sm-offset-2 col-sm-10">
                <div class="checkbox">
                  <label> <input type="checkbox">记住我</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="col-sm-offset-2 col-sm-10">
                还没有帐号？<a href="/register" data-toggle="modal">注册新帐号</a>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary">登录</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        </div>
      </div>
    </div>
  </div>
</template></p>

<h1>user login control</h1>

<p>if (Meteor.isServer) {
  Meteor.startup(function () {
    Accounts.onLogin(function(userObj) {
      Router.go(&ldquo;/&rdquo;);
    });</p>

<pre><code>Accounts.onLoginFailure(function(userObj) {
  console.log("wrong pwd for " + userObj.user.profile.nickname);
});
</code></pre>

<p>  });
}</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/03/174123/">几款开源文本编辑器比较</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-03T17:41:23+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>5:41 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Brackets</h1>

<p><a href="http://brackets.io/">Brackets</a>是一款面向Web开发的文本编辑器；</p>

<p>通过插件管理器实现vim模式支持，效果好；</p>

<p>修改字号方便：ctrl + =/-;</p>

<p>不修改项根目录；</p>

<p>不能像atom那样在命令行中将工作目录作为参数传入，比如在启动后设置；</p>

<p>打开文件夹快捷键：ctrl-alt-o;
打开文件快捷键：ctrl-shift-o, 在当前目录中模糊匹配；</p>

<p>分割窗口只有“不分割”，“横向分割”，“纵向分割”3种方式，且只能用鼠标操作，不方便；</p>

<p>在html中实时修改css文件：ctrl-e;</p>

<p>推荐插件：</p>

<ul>
<li><p>Brackets Vim: vim模式插件，可以使用ex命令（冒号开头的命令，如:w,:q等），需要与外界粘贴/拷贝文本，需要先在[File -> Enable Vim]中关闭vim模式，再用鼠标选择文本，再ctrl-c/v;</p></li>
<li><p>Command line shortcuts: 可以将命令行定义成快捷键；</p></li>
<li><p>Brackets Key Remapper: 目录[Debug -> Open Preferences File]，打开配置文件，修改默认快捷键，"view.hideSidebar"改为ctrl-alt-m；</p></li>
<li><p>Theme: 增加暗色方案；</p></li>
<li><p>Display Shortcuts: 显示可用的所有快捷键，可以搜索，很方便, ctrl-alt-/;</p></li>
</ul>


<h1>Atom</h1>

<p><a href="https://atom.io/">Atom</a>由Github出品，未来可能不完全开源;</p>

<p>启动速度慢；</p>

<p>对窗口分割、窗口尺寸切换的支持不太好；</p>

<p>全局搜索快捷键：Ctrl-Shift-P;
打开文件快捷键：Ctrl-P;</p>

<p>vi模式不能使用ex命令，操作不流畅；</p>

<h1>Zed</h1>

<p>体积比atom小一半，解压后直接运行，但其暗色主题都是灰色的，对比度不够；</p>

<p>会在项目根目录下创建一个.zeddata文件，如果使用git做项目管理的话，需要把这个文件加入到ignore列表中；</p>

<p>没有tab，可以水平分割为1～3个窗口，可以方便地在窗口间转移，这一点比atom强很多；</p>

<p>自动保存功能使得:w不再需要，但最Meteor这样自动更新的环境，自动保持会使应用频繁更新；</p>

<p>自带Vim模式，可以方便地使用vi快捷键；</p>

<h1>LightTable</h1>

<p>LightTable是一个Clojure开发环境，但也能作为一款通用文本编辑器；</p>

<p>打开命令自动搜索：ctrl-space;</p>

<p>安装vim插件：ctrl-space -> show plugin manager -> 输入vim，安装之，ex命令可用；与外部copy/paste需要在插入模式中用鼠标完成；</p>

<p>打开文件：ctrl-o;</p>

<p>总体而言无法替代vim；</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/01/134829/">Full Text Search for Meteor App</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-01T13:48:29+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>1:48 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For Meteor 1.0.3, the built-in database is mongodb 2.4, which is not support full text search by default.
So we need install a stand-alone MongoDB 2.6, create a &ldquo;meteor&rdquo; database, and let Meteor to use it as backend database:</p>

<p>First start MongoDB server: <code>mongod --dbpath ~/docs/mongodb-repo</code>;</p>

<p>Then create a new database &ldquo;meteor&rdquo; for Meteor app backend:</p>

<pre><code>$ mongo
&gt; show dbs
&gt; use meteor
</code></pre>

<p>Next start Meteor server and connect it with the Mongodb server:</p>

<pre><code>$ MONGO_URL="mongodb://localhost:27017/meteor" meteor
&gt; db.zips.getIndexes()
&gt; db.zips.dropIndex("forsearch_text")
&gt; db.zips.ensureIndex( {city: "text", state: "text"} )
&gt; db.zips.find( {$text: {$search: "lee ma"}} ).count()
488
</code></pre>

<p>Here <code>use meteor</code> create a new database in MongoDB (if it doesn&rsquo;t exists yet)
and use it as the current database.
Use <code>db</code> to get the current database name.</p>

<p>Ref:</p>

<p><a href="http://docs.mongodb.org/manual/tutorial/getting-started/">Getting Started with MongoDB</a></p>

<p><a href="http://docs.mongodb.org/manual/administration/indexes-text/">Text Search Tutorials of MongoDB 2.6.7</a>;</p>

<p><a href="http://docs.mongodb.org/manual/reference/operator/query/text/">$text query operator of MongoDB 2.6.7</a></p>

<p><a href="http://stackoverflow.com/questions/10610131/checking-if-a-field-contains-a-string">Checking if a field contains a string</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/30/183509/">Meteor应用中简单查询的实现方法</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-30T18:35:09+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:35 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>简单搜索要求多个检索词能够以任意顺序出现在多个字段中，目前的解决方法有两种思路：</p>

<p>一是创建一个额外的检索项，把所有要检索的字段用字符串方式组合起来放在检索项中，然后用正则表达式匹配；
这种方式实际上有信息冗余，所以原始数据变化后一定要及时更新检索项；</p>

<p>二是用第三方包实现这种功能。</p>

<h1>自定义搜索：检索词放在单独Collection中</h1>

<p>优点是检索词单独存放，需要去掉或者更新检索词时，只要简单地drop掉检索词Collection即可，
适于存储大量记录；</p>

<p>缺点有两个：
首先显示查询结果比较麻烦，需要先在检索项集合中搜出命中目标的_id，然后再查询原始数据表显示完整信息；
其次这种数据结构对组合查询支持不好，比如要查询"名称"字段中含有"abc"，并且"类别"字段中含有"xyz"的展会，
由于"类别"字段是一个复杂对象，需要事先组合成一个字符串，这一项如果放在单独的collection中，
需要查询两个不同的集合，然后取它们的并集。</p>

<p>首先在MongoDB中，创建用于简单搜索的新collection &ldquo;simpleSearch&rdquo;:</p>

<pre><code>db.fairs.find().forEach(function(elem) {
    var searchStr = elem.chnName + elem.engName + elem.position;
    db.simpleSearch.save({ _id: elem._id, searchBody: searchStr });
})
</code></pre>

<p>然后定义路由处理函数：</p>

<pre><code>Fairs = new Mongo.Collection("fairs");
SimpleSearch = new Mongo.Collection("simpleSearch");

Router.route('/results/:inp', function() {
  // basic search url: /results/abc?type=basic
  // complex search url: /results/?type=complex?name=xxx?time=xxx?position=xxx?category=xxx
  var fullStr = this.params.inp;
  var searchType = this.params.query.type;
  if (searchType === "basic") {
    var parts = fullStr.trim().split(" ");
    for (i=0; i&lt;parts.length; ++i) {
      parts[i] = "(?=.*" + parts[i] + ")";
    }
    var queryPtn = new RegExp("(" + parts.join("") + ")", "i");
    var ids = [];
    SimpleSearch.find( { searchBody: queryPtn }, { fields: { searchBody:0 }} ).forEach(
      function(elem) {
        ids.push(elem._id);
      });
    this.render('SearchResults', {
      data: function() {
        return Fairs.find( { _id: { $in: ids } } );
      }
    });
  } else if (searchType === "complex") {
    ...
  }
});
</code></pre>

<p>这里首先查询SimpleSearch集合，然后将查询得到的展会<em>id存入临时容器ids数组中，然后在Fairs集合中通过"$in"操作符取得所有ids数组中</em>id对应的展会对象。</p>

<h1>自定义搜索：检索词放在原始信息文档中</h1>

<p>这个方法把原始信息和检索项放在同一个集合中，几个检索项放在集合的一个key下面，
集合会比较臃肿，但查询和显示都方便，适用于尺寸不大的数据库。</p>

<p>控制器定义：</p>

<pre><code>Fairs = new Mongo.Collection("fairs");
Router.route('/results/:inp', function() {
  // basic search url: /results/abc?type=basic
  // complex search url: /results/?type=complex?name=xxx?time=xxx?position=xxx?category=xxx
  var fullStr = this.params.inp;
  var searchType = this.params.query.type;
  if (searchType === "basic") {
    var parts = fullStr.trim().split(" ");
    for (i=0; i&lt;parts.length; ++i) {
      parts[i] = "(?=.*" + parts[i] + ")";
    }
    var queryPtn = new RegExp("(" + parts.join("") + ")", "i");
    this.render('SearchResults', {
      data: function() {
        return Fairs.find( { "indexStr.simpleSearch": queryPtn } );
      }
    });
  } else if (searchType === "complex") {
    ...
  }
});
</code></pre>

<h1>基于Search Source的实现方法</h1>

<p>这个搜索基于<a href="https://github.com/meteorhacks/search-source/">search-source</a>.
通过<code>meteor add meteorhacks:search-source</code>添加到meteor中，
代码参照了<a href="https://github.com/meteorhacks-samples/meteor-instant-search-demo">meteor-instant-search-demo</a>.</p>

<h2>准备数据源</h2>

<h3>导入数据</h3>

<ol>
<li><p>下载<a href="http://media.mongodb.org/zips.json">zips.json</a>；
参考<a href="http://stackoverflow.com/questions/5723896/is-there-a-sample-mongodb-database-along-the-lines-of-world-for-mysql">Is there a sample MongoDB Database along the lines of world for MySql?</a>.</p></li>
<li><p>导入Meteor数据库中：启动meteor服务，然后在另一个shell里运行：
<code>~/apps/mongodb-linux-x86_64-2.6.5/bin/mongoimport -h localhost:3001 --db meteor --collection zips --type json --file zips.json</code>;</p></li>
<li><p>增加搜索字段：由于简单搜索要求输入可能匹配任意字段，
能达到这个要求的唯一方法就是将被查询的字段连接成一个完整的“搜索”字符串，
输入的各项可以以任何顺序出现在这个搜索字符串（这里这一项名为"forsearch"）中，下面增加这一项：</p>

<pre><code> db.zips.find().forEach(function(elem) {
     db.zips.update(
       {_id: elem._id},
       { $set: {forsearch: elem.city + ' ' + elem.state}}
     );
 });

 db.fairs.find().forEach(function(elem) {
     var cat_minor = _.reduce(elem.category.minor
     db.fairs.update(
       {_id: elem._id},
       { $set: {forsearch: elem.chnName + ' ' + elem.engName + ' ' + elem.time + ' ' + elem.position + catStr}}
     );
 });
</code></pre>

<p> 参考<a href="http://stackoverflow.com/questions/3974985/update-mongodb-field-using-value-of-another-field">Update MongoDB field using value of another field</a>.</p></li>
</ol>


<h2>搜索逻辑</h2>

<p>下面"/&ldquo;都指项目根目录。</p>

<h3>数据集定义</h3>

<p>在/collections.js中定义数据集和索引：</p>

<pre><code>Zips = new Mongo.Collection('zips');
if(Meteor.isServer) {
  Zips._ensureIndex({city: 1, state: 1});
}
</code></pre>

<h3>服务端</h3>

<p>在/server/server.js中定义：</p>

<pre><code>SearchSource.defineSource('zips', function(searchText, options) {
  var options = {sort: {isoScore: -1}, limit: 20};

  if(searchText) {
    var regExp = buildRegExp(searchText);
    var selector =  {forsearch: regExp};
    return Zips.find(selector, options).fetch();
  } else {
    return Zips.find({}, options).fetch();
  }
});

function buildRegExp(searchText) {
  var parts = searchText.trim().split(/[ \-\:]+/);
  for (i=0; i&lt;parts.length; ++i) {
    parts[i] = "(?=.*" + parts[i] + ")";
  }
  var res = new RegExp("(" + parts.join("") + ")", "i");
  return res;
}
</code></pre>

<p>buildRegExp函数中的正则表达式<code>(?=.*A)(?=.*B)</code>可以实现对A和B任意顺序的匹配，
即既能匹配A.<em>B，又能匹配B.</em>A，
参考<a href="http://stackoverflow.com/questions/19896324/match-string-in-any-word-order-regex">match string in any word order regex</a>.</p>

<h3>客户端：搜索输入框框即时响应</h3>

<p>搜索框是通用控件，所以定义在了/client/comTemp.js中，定义了对框中keyup事件的响应：</p>

<pre><code>Template.Header.events({
  "keyup #search-input": _.throttle(function(e) {
    var text = $(e.target).val().trim();
    ZipSearch.search(text);
  }, 200)
});
</code></pre>

<h3>客户端：搜索结果展示页面</h3>

<p>定义在/client/results.html中。</p>

<pre><code>&lt;template name="SearchResults"&gt;
  &lt;div id="search-result" class="container content"&gt;
    &lt;div id="search-meta"&gt;

        searching ...

    &lt;/div&gt;


      &lt;div class="package"&gt;
        &lt;h4 class="name"&gt;
          }
        &lt;/h4&gt;
        &lt;div class="description"&gt;
          }, }
        &lt;/div&gt;
      &lt;/div&gt;

  &lt;/div&gt;
&lt;/template&gt;
</code></pre>

<h3>客户端：搜索结果的数据控制</h3>

<p>定义在/client/results.js中。</p>

<pre><code>var options = {
  keepHistory: 1000 * 60 * 5,
  localSearch: true
};
var fields = ['forsearch'];     // 这里定义要搜索的字段

ZipSearch = new SearchSource('zips', fields, options);
// 这里的zips要与服务端SearchSource.defineSource中定义的名字一致

Template.SearchResults.helpers({
  getZips: function() {
    return ZipSearch.getData({
      transform: function(matchText, regExp) {
        console.log("matchText: " + matchText);
        console.log("regExp: " + regExp);
        var res = matchText.replace(regExp, "&lt;b&gt;$&amp;&lt;/b&gt;");
        console.log("res is: " + res);
        return res;
      },
      sort: {isoScore: -1}
    });
  },

  isLoading: function() {
    return ZipSearch.getStatus().loading;
  }
});

Template.SearchResults.rendered = function() {
  ZipSearch.search('');
};
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/29/141348/">Git-flow Notes</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-29T14:13:48+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:13 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>git is a powerful version control tool, while its large amount of commands and options make it hard to use.</p>

<p>So <a href="https://github.com/nvie/gitflow">git-flow</a> was created to make git mush convenient. It&rsquo;s a high level branching tools for git.</p>

<p>Fist install it with <code>apt-get install git-flow</code> on Debian-family distros.</p>

<h1>Usage</h1>

<h2>Workflow on a single feature</h2>

<p>The following paragraphs is from [Why aren&rsquo;t you using git-flow?}(<a href="http://jeffkreeftmeijer.com/2010/why-arent-you-using-git-flow/">http://jeffkreeftmeijer.com/2010/why-arent-you-using-git-flow/</a>).</p>

<p>Branch &ldquo;master&rdquo; is always &ldquo;production ready&rdquo; code. Commits are never made directly to master. Rather, code on master only gets there after a production release branch is created and &ldquo;finished&rdquo; (more on that in a sec). Thus the code on master is always able to be released to production. Also, master is always in a predictable state, so you never need to worry if master (and thus production) has changes one of your other branches doesn&rsquo;t.</p>

<p>&ldquo;develop&rdquo; is the branch you&rsquo;ll be doing most of your work off of; it&rsquo;s also the branch that represents the code to be deployed in the next release. feature branches represent non-trivial features and fixes that have not yet been deployed (a completed feature branch is merged back into develop). Updating master is done through the creation of a release.</p>

<p>Most of your work is done on the develop branch. This branch contains all of the completed features and bug fixes yet to be released; nightly builds or continuous integration servers should target develop, as it represents the code that will be included in the next release. For one-off commits, feel free to commit to develop directly.</p>

<p>Use <code>git flow help</code> or <code>git flow feature help</code> to list all available commands.</p>

<pre><code>$ git flow init  // Convert an existing git repo to git-flow style:

$ git flow feature start &lt;feature-name&gt;

$ git commit -m "now finish this feature"

// if you want cancel this feature:
$ git flow feature  // list the current feature name, here is "searchSource"
$ git flow feature delete searchSource
// or do it manually
$ git checkout develop  // switch to "develop" branch
$ git branch  // list current branches
$ git branch -d feature/&lt;feature-name&gt;   // "feature/" is the default prefix of all feature branches
$ git branch  // verify the feature is deleted

// push feature to remote repository
$ git flow feature publish

// get feature commit from remote repository
$ git flow feature pull

// after the feature is finished and tested
$ git flow feature finish &lt;feature-name&gt;
</code></pre>

<p>Note that do not add &ldquo;feature/&rdquo; prefix before feature name.
This command merge feature branch back into develop branch, so the feature branch disappear from now on.
If you don&rsquo;t want save your feature branch into remote repo, push to remote AFTER you finish your feature with this &ldquo;finish&rdquo; command.
There is a corresponding &ldquo;release&rdquo; command:</p>

<pre><code>$ git flow release start v0.1.0
$ git flow release finish v0.1.0
</code></pre>

<p>See <a href="http://danielkummer.github.io/git-flow-cheatsheet/">git-flow cheatsheet</a> for details of git-flow.</p>

<h2>Switching between multiple features</h2>

<p>Say you now have finished version 1.0 and tag it with &ldquo;1.0&rdquo;.
Next you will add function A to the product.
You have two methods to achieve function A, &ldquo;search source&rdquo; and &ldquo;full text&rdquo;.
You want to experiment them one by one, so create the first test branch with <code>git flow feature start searchSource</code>,
After some commits, now you want to evaluate the second.</p>

<p>You can&rsquo;t <code>git flow feature finish searchSource</code> for two reasons:</p>

<p>First you may switching back to this feature in the future.
If you finish this feature, this branch disappeared.</p>

<p>Second you need experiment &ldquo;full text&rdquo; based on version 1.0.
But if you &ldquo;finish&rdquo; feature &ldquo;search source&rdquo;, the modifications will be added to branch develop.
If you <code>git flow feature start fullText</code>, the codes won&rsquo;t be that in version 1.0.</p>

<p>So what you want is working on multiple branches simultaneously:</p>

<pre><code>$ git flow feature start searchSource
... // some developments on branch searchSource
$ git commit -m "finish a milestone by method search source"
$ git flow feature start fullText
... // some developments on branch fullText
$ git commit -m "finish a milestone by method full text"
$ git flow feature list
$ git flow feature checkout searchSource
... // some developments on branch searchSource
$ git commit -m "finish the 2nd milestone by method search source"
$ git flow feature checkout fullText
... // some developments on branch fullText
$ git commit -m "finish the 2nd milestone by method full text"
</code></pre>

<p>If you have some casual modifications which you don&rsquo;t want to commit, use <code>git stash</code> instead of <code>git commit</code>.
Use <code>git stash list</code> to list all stashed changes, and <code>git stash pop</code> to take the stashed codes out.
Or <code>git stash apply</code> to take codes out without removing saved stash record.</p>

<p>Finally you choose &ldquo;full text&rdquo; to achieve function A.
So add it to your develop code base: <code>git flow feature finish fullText</code>.
And leave the branch &ldquo;search source&rdquo; alone.</p>

<p>If you are sure &ldquo;search source&rdquo; are useless any more,
print all existing features with <code>git flow feature list</code>,
then remove it with <code>git flow feature delete searchSource</code>.</p>

<p>There is a GUI tool called <code>gitk</code>, which can be installed with <code>apt-get install gitk</code>.
See commits on current branch with <code>gitk</code>, or see all branches with <code>gitk --all</code>.</p>

<p>There is also a <a href="https://github.com/bobthecow/git-flow-completion">git-flow-completion</a> tool for zsh.
Install it if you like.</p>

<ol>
<li><p>Download <a href="http://sourceforge.net/p/zsh/code/ci/master/tree/Completion/Unix/Command/_git?format=raw">_git</a> and replace /usr/share/zsh/functions/Completion/Unix/_git;</p></li>
<li><p>Download <a href="https://raw2.github.com/bobthecow/git-flow-completion/master/git-flow-completion.zsh">git-flow-completion.zsh</a>, save it as ~/.git-flow-completion.zsh;</p></li>
<li><p>Add &ldquo;source ~/.git-flow-completion.zsh&rdquo; into ~/.zshrc;</p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/26/174649/">Meteor Development Styles</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-26T17:46:49+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:46 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Naming Styles</h1>

<ul>
<li><p>Template, class, enum name use BigCamelCase;</p></li>
<li><p>File, identifier, function name use smallCamelCase;</p></li>
<li><p>CSS class name: css-class-name;</p></li>
<li><p>Constant value name: CONSTANT_VALUES_LIKE_THIS;</p></li>
</ul>


<p>Ref:</p>

<p><a href="https://github.com/meteor/meteor/wiki/Meteor-Style-Guide">Meteor Style Guide</a></p>

<p><a href="https://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml#Naming">Googe JavaScript Naming rules</a>:
use functionNamesLikeThis, variableNamesLikeThis, ClassNamesLikeThis, EnumNamesLikeThis, methodNamesLikeThis, CONSTANT_VALUES_LIKE_THIS, foo.namespaceNamesLikeThis.bar, and filenameslikethis.js.</p>

<p><a href="https://github.com/airbnb/javascript">Airbnb JavaScript Style Guide</a></p>

<h1>Small Project Structure with Iron Router</h1>

<p>The following is the file structure of small meteor app,
which put all files into root folder, to simplify file editing and browsing.</p>

<ul>
<li><p>head.html: contains &ldquo;<head> &hellip; </head>&rdquo;;</p></li>
<li><p>layout.html: defines layouts of the app, each in a &ldquo;<template>&rdquo;, you can put multiple layouts in this file;</p></li>
<li><p>router.js: defines all routes and layouts. Put all javascript codes starting with &ldquo;Router.&rdquo; (such as Router.route, Router.configure) into this file;</p></li>
<li><p>collections.js: define persistent collections, or models of application;</p></li>
<li><p>style.css: defines global css styles here;</p></li>
<li><p>comTemp.html: defines global common templates here;</p></li>
<li><p>page triad: consists of a view (html), a controller (js) and a formatter (css).
  So the home page triad consists of home.html, home.js and home.css;</p></li>
</ul>


<h1>Large Project Structures</h1>

<p><a href="https://github.com/DiscoverMeteor/Microscope">Microscope</a> of <a href="https://www.discovermeteor.com/">Discover Meteor</a> is a good example:</p>

<p>$ git clone <a href="https://github.com/DiscoverMeteor/Microscope.git">https://github.com/DiscoverMeteor/Microscope.git</a>
$ cd Microscope
$ tree -L 3
.
├── client
│   ├── helpers
│   │   ├── config.js
│   │   ├── errors.js
│   │   └── handlebars.js
│   ├── main.html
│   ├── main.js
│   ├── stylesheets
│   │   └── style.css
│   └── templates
│       ├── application
│       ├── comments
│       ├── includes
│       ├── notifications
│       └── posts
├── lib
│   ├── collections
│   │   ├── comments.js
│   │   ├── notifications.js
│   │   └── posts.js
│   ├── permissions.js
│   └── router.js
├── LICENSE.txt
├── README.markdown
├── README.nitrous.md
└── server
    ├── fixtures.js
    └── publications.js</p>

<p>Ref:</p>

<p><a href="http://docs.meteor.com/#/full/structuringyourapp">Structuring your application in Meteor Docs</a></p>

<p><a href="https://github.com/EventedMind/iron-router/blob/devel/Guide.md">iron-router official guide</a></p>

<p>google &ldquo;iron router layout&rdquo;;</p>

<p><a href="http://www.manuel-schoebel.com/blog/iron-router-tutorial">Iron-Router Tutorial</a></p>

<p><a href="http://stackoverflow.com/questions/21824045/meteor-iron-router-layout-template">Meteor Iron Router layout template</a></p>

<p><a href="http://stackoverflow.com/questions/19909945/meteor-iron-router-layout-rendering">Meteor Iron-Router Layout Rendering</a></p>

<p><a href="http://robertdickert.com/blog/2014/05/09/set-up-navigation-with-iron-router-and-bootstrap/">Set Up Navigation With Iron Router and Bootstrap</a></p>

<p><a href="http://meteortips.com/tutorial/iron-router-part-1/">A Beginner’s Guide to Iron Router, Part 1</a> on <a href="http://meteortips.com/">Meteor Tips</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/26/173952/">离线保存网页</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-26T17:39:52+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>首先试用了Firefox的"Save as PDF"这个插件，发现对于内容复杂的网页，保存总出错。</p>

<p>又试了"Screengrab!&ldquo;这个插件，把整个网页保存成一改png文件，效果不错，
即使网页超出了一屏，也可以保存为一个完整的图片。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/20/090427/">Encrypt and Remove Encryption in Vim</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-20T09:04:27+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:04 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To encrypt a file with vim, use <code>:X</code> when saving the file.</p>

<p>To remove the encryption, run <code>:set key=</code> in vim,
make some modifications in text,
then save file with <code>:x</code>.</p>

<p>Note that if you didn&rsquo;t make any modifications in text,
The encryption will not be removed.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/12">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/10">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/11/20/104508/">Clear Chrome DNS Cache</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/19/103131/">Linux的图形化Git客户端</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/02/093547/">Move Window Between Multiple Screens via Tmux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/31/011200/">Synchronize Data From MongoDB to Elasticsearch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/30/131706/">Elasticsearch River for MongoDB</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leetschau">@leetschau</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leetschau',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Li Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
