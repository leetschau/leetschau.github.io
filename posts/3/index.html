
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dark Matter in Cyberspace</title>
  <meta name="author" content="Li Chao">

  
  <meta name="description" content="工作流程 业务同事在发现网站或者管理控制台有bug时，请按照如下流程报开发解决： 打开Phabricator的相关项目页面；
在Todo列下新建一个Task，把问题的复现过程写在里面。
所谓复现过程，就是我现在打开哪个页面，改的哪条展会的哪一项，
点了哪个按钮，出现了什么问题， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leetschau.github.io/posts/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Dark Matter in Cyberspace" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dark Matter in Cyberspace</a></h1>
  
    <h2>The technical blog of Li Chao in Beijing</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="leetschau.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/06/162749/">怎样报bug</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-06T16:27:49+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>4:27 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>工作流程</h1>

<p>业务同事在发现网站或者管理控制台有bug时，请按照如下流程报开发解决：</p>

<ol>
<li><p>打开Phabricator的相关项目页面；</p></li>
<li><p>在Todo列下新建一个Task，把问题的复现过程写在里面。
所谓复现过程，就是我现在打开哪个页面，改的哪条展会的哪一项，
点了哪个按钮，出现了什么问题，让开发看着你的描述能再现一次问题；</p></li>
<li>把这个task的链接发到微信工作群里或者身边的开发同事；</li>
<li>在他/她复现问题的过程中，遇到不清楚的地方进行解释，完善第2步中创建的复现流程；</li>
<li>确定开发同事已经能够复现问题，你的任务就完成了，等待他的反馈。</li>
</ol>


<h1>Q &amp; A</h1>

<p>Q: 复现过程要详细到什么程度？</p>

<p>A: 详细到一个完全不懂公司业务、也没有技术背景的人，可以按照你的描述复现问题。</p>

<p>Q: 为什么要搞这么复杂，我截个图发微信上不行吗？</p>

<p>A: 如果是简单的问题，速战速决当然可以，但对于复杂的问题，使用这个流程很有用：
   首先，写下来的解决方法才能变成组织财富的一部分，
   而不是随着时间的推移和人员的流动，一次一次解决相同或者类似的问题；
   其次，写下来的解决方法可以帮助开发新手快速成长，降低公司培养新人的成本，
   提高组织整体的效率；
   最后，写下来的过程是整理思路的过程，对写文档的人也是一种技能提升。</p>

<p>Q: 我提交的bug总不解决怎么办？</p>

<p>A: 提高任务的重要程度（在priority里设置），如果提高后还是一直未解决，
   跟任务的接收人聊一聊，延期的原因是什么，大家一起讨论一下解决方法。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/02/024310/">在vim中执行shell命令的插件</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-02T02:43:10+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>2:43 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>需要做一个vim工具，基本功能是通过一个快捷键，把选中的内容（或者当前行）发送到指定的tmux pane中，并执行。</p>

<h1>实现过程</h1>

<p>目录结构：当前工作目录下有 sendcmd.vim 和 test.md 两个文件，
前者包含实现功能的 vim 函数，后者是包含要执行命令行的数据文件。</p>

<p>开发环境：tmux window 1 做sendcmd.vim开发，window 2 上下拆分为两个pane
，上面 (ptop) 是命令行，下面的 pane (pbottom) 中用 vim 打开数据文件test.md.</p>

<p>每次修改并保存sendcmd.vim后，在test.md中执行<code>:so sendcmd.vim</code>，
然后把光标移动到要执行的命令所在的行上按<code>F3</code>键就可以看到命令被发送到ptop里的
执行效果了。</p>

<h2>格式探测</h2>

<p>这一步要解决的问题是：怎样的字符串，才能被<code>tmux send-keys</code>正确地传送出去，
并能正确的执行。</p>

<p>首先要保证运行<code>tmux send-keys</code>不报错，如果报错，
将第5行的输出拷贝到一个单独的命令行中运行，解决错误。</p>

<p>这一步通过后，如果命令被传送到<code>ptop</code>后报错，根据错误日志解决之。</p>

<p>sendcmd.vim：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>function! SendCmd()
</span><span class='line'>  let curline = getline(".")
</span><span class='line'>  echom curline
</span><span class='line'>  let cmd = "tmux send-keys -t top '" . curline . "' Enter"
</span><span class='line'>  echom cmd
</span><span class='line'>  echom system(cmd)
</span><span class='line'>endfunction
</span><span class='line'>
</span><span class='line'>nnoremap &lt;F3&gt; :call SendCmd()&lt;CR&gt;</span></code></pre></td></tr></table></div></figure>


<p>说明：</p>

<ul>
<li>为什么第4行中<code>curline</code>要用单引号（而不是双引号）包裹？</li>
</ul>


<p>因为要执行的命令中可能包含变量（如es, idx等），双引号包裹的变量会被求值，
而我们的要求是这些变量不能被求值，要等到被发送到ptop后再被求值。由于这个原因，
第4行包裹外层<code>tmux send-keys</code>的命令就只能用双引号包裹。</p>

<ul>
<li>vimscript如何连接字符串？</li>
</ul>


<p>同样参考第4行，用点（ . ）连接。</p>

<ul>
<li><code>tmux send-keys -t top</code> 可以将keys从下面的pane发给上面，
也可以从左侧发到右侧，但如果是在右侧pane里执行这个语句，则会被发给自己。</li>
</ul>


<p>test.md：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>es=http://192.168.100.231:9200
</span><span class='line'>api=http://192.168.100.231:8000
</span><span class='line'>idx=production
</span><span class='line'>type=Fair
</span><span class='line'>
</span><span class='line'># get elasticsearch version
</span><span class='line'>http $es | jq '.version.number'
</span><span class='line'>
</span><span class='line'># list all indices
</span><span class='line'>http -b GET $es'/_cat/indices?v'
</span><span class='line'>http -b GET $es'"'"'/_cat/indices?v'"'"'
</span><span class='line'>
</span><span class='line'># list all types of a index
</span><span class='line'>http -b GET $es/$idx/_mapping|jq ".$idx.mappings|keys"
</span><span class='line'>
</span><span class='line'># list all properties of a type
</span><span class='line'>http -b GET $es/$idx/_mapping|jq ".$idx.mappings.$type.properties|keys"
</span><span class='line'>
</span><span class='line'># get objects count in a type
</span><span class='line'>http -b GET $es/$idx/$type/_count|jq '.count'
</span><span class='line'>http -b GET $es/$idx/$type/_count|jq '"'"'.count'"'"'
</span><span class='line'>
</span><span class='line'># query result count
</span><span class='line'>http -b POST $es/$idx/$type/_search query:='{"bool":{"must":[{"query_string":{"query":"五金机械"}}]}}' | jq '.hits.total'
</span><span class='line'>http -b POST $es/$idx/$type/_search query:=''{"bool":{"must":[{"query_string":{"query":"五金机械"}}]}}''
</span><span class='line'>http -b POST $es/$idx/$type/_search query:='"'"'{"bool":{"must":[{"query_string":{"query":"五金机械"}}]}}'"'"'
</span><span class='line'>http -b POST $es/$idx/$type/_search query:='"'"'{"bool":{"must":[{"query_string":{"query":"五金机械"}}]}}'"'"' | jq '"'"'.hits.total'"'"'</span></code></pre></td></tr></table></div></figure>


<p>通过不断尝试后，发现用<code>'"'"'</code>代替<code>'</code>就能正确的发送并执行，
见第10,11行，20,21行，24~27行。</p>

<p>下面以第10行为例分析其结构：</p>

<ol>
<li><p>第一个单引号与外层的单引号结合，包裹它们中间的内容<code>http -b GET $es</code>，
保证里面的特殊字符（<code>$</code>）不会被求值；</p></li>
<li><p>中间的<code>"'"</code>是一组，实现被<code>tmux</code>发送后，最终执行的命令行里仍有一个单引号
（<code>$es</code>后面的单引号）；</p></li>
<li><p>最后的单引号，与后面的<code>'"'"'</code>中最左边的单引号组合，
包裹中间的内容<code>/_cat/indices?v</code>，如果没有这一组单引号，
里面的问好就会被求值，导致命令无法执行。</p></li>
</ol>


<p>这一步实现了在第11、21、27行上按<code>F3</code>键可以正确执行。</p>

<h2>整合进vim function</h2>

<p>这一步将前面的测试结果放进vim函数中，实现在第10、20、24行上能够正确执行。</p>

<p>sendcmd.vim：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function! SendCmd()
</span><span class='line'>  let curline = getline(".")
</span><span class='line'>  echom curline
</span><span class='line'>  let escstr = substitute(curline, "'", "'\"'\"'", 'g')
</span><span class='line'>  let cmd = "tmux send-keys -t top '" . escstr . "' Enter"
</span><span class='line'>  echom cmd
</span><span class='line'>  echom system(cmd)
</span><span class='line'>endfunction
</span><span class='line'>nnoremap &lt;F3&gt; :call SendCmd()&lt;CR&gt;</span></code></pre></td></tr></table></div></figure>


<h2>制作成插件</h2>

<p>当功能基本定型后，可以把脚本变成插件，避免每次使用时加载。</p>

<p>最简单的vim插件，只要在一个目录（tmuxcmd）里创建一个<code>plugin</code>目录，
把.vim脚本放进去，然后把目录做成git库就行了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p tmuxcmd/plugin
</span><span class='line'>mv test.vim tmuxcmd/plugin/tmuxcmd.vim
</span><span class='line'>cd tmuxcmd
</span><span class='line'>git init
</span><span class='line'>git add ...; git commit -m "..."</span></code></pre></td></tr></table></div></figure>


<p>在.vimrc里加入这个插件：增加一行代码：<code>Plugin 'file:///home/leo/temp/tmuxcmd'</code></p>

<p>安装：<code>vim +PluginInstall</code></p>

<p>安装过程实际是把代码库clone到~/.vim/bundle下，
修改~/.vim/bundle/tmuxcmd/plugin/tmuxcmd.vim文件在新的vim编辑器中不会生效。</p>

<p>本地插件需要保存一个本地目录，更简单的方法是发布到github上，再用vundle安装：</p>

<ol>
<li><p>把代码库push到github上：
<a href="https://github.com/leetschau/tmuxcmd">leetschau/tmuxcmd</a></p></li>
<li><p>在.vimrc中，把原来的<code>Plugin 'file:///home/leo/temp/tmuxcmd'</code>换成
<code>Plugin 'leetschau/tmuxcmd'</code></p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/02/020329/">Loop Over Visual Selection in Vim Script</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-02T02:03:29+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>2:03 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Create file testPos.vim:</p>

<pre><code>function! GetSelection()
  echo "in func"
  let start = line("v")
  echo "start: " . start
  let end = line(".")
  echo "end: " . end
  let firstLine = line("'&lt;")
  echo "start2: " . firstLine
  let lastLine = line("'&gt;")
  echo "end2: " . lastLine
endfunction

noremap &lt;silent&gt; &lt;F4&gt; :call GetSelection()&lt;CR&gt;
</code></pre>

<p>In the same folder, open a file with vim, run <code>:so testPos.vim</code>.
Move the cursor to line 3, press <F4>, get the following output:</p>

<pre><code>in func
start: 3
end: 3
start2: 7
end2: 11
</code></pre>

<p>In visual mode, select line 11 to 13, press <F4>, the output:</p>

<pre><code>in func
start: 11
end: 11
start2: 11
end2: 13
in func
start: 12
end: 12
start2: 11
end2: 13
in func
start: 13
end: 13
start2: 11
end2: 13
</code></pre>

<p>The output shows in visual mode,
the function will be run several times for each line.</p>

<p>So a function need only deal with the current line,
with content <code>getline('.')</code>, or line number <code>line('.')</code>.
No matter in visual mode or not, the function will work fine.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/24/094511/">保存Tmux屏幕输出到文件中</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-24T09:45:11+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:45 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>保存Tmux的屏幕输出分为两步：
首先用<code>capture-pane</code>将屏幕输出保存在buffer里，
然后用<code>save-buffer</code>将buffer内容保存到文件里。</p>

<p>在<code>capture-pane</code>中可以用<code>-S</code>和<code>-E</code>指定要保存的屏幕输出的范围，
当前屏幕的最上一行为坐标原点，标记为0，下面一行坐标是1,依次类推；
原点的上一行坐标是-1，再上一行坐标是-2，依次类推。</p>

<p>用<code>Alt-c</code>进入copy-mode后，屏幕右上角显示当前屏幕在整个pane中的坐标[X/Y]，
其中X代表当前屏幕最高行的坐标，Y代表最早一行屏幕输出的坐标，
根据坐标确定要保存文本的起止坐标就可以保存了。</p>

<p>例如要保存第3个pane中的一段近5000行的输出，
进入copy-mode后按<code>g</code>键，到最早的屏幕输出，右上角显示<code>[5676/5676]</code>,
用<code>Ctrl-f</code>或者<code>J</code>键向下滚动屏幕，
当想要保存的第一行处于屏幕最上一行时，坐标显示为<code>[5557/5676]</code>，
将想要保存的最后一行滚动到屏幕最上一行，坐标显示为<code>[642/5676]</code>，
切换到另一个pane里执行：</p>

<pre><code>tmux capture-pane -S -5557 -E -642 -t 3
tmux save-buffer output.log
</code></pre>

<p>这样这段输出就保存到文件output.log里了，其中<code>-t 3</code>指定了要保存的pane的序号。</p>

<p>如果要保存所有历史输出，可以简写为<code>tmux capture-pane -S -</code>.</p>

<p>除了新开一个pane执行tmux命令，也可以在当前pane用快捷键<code>Alt-a</code>进入tmux命令行状态
即command-prompt，然后执行<code>capture-pane -S -5557 -E -642</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/15/190457/">Build Data Analysis Toolkit With Anaconda</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-15T19:04:57+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>7:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Setup</h1>

<p>Download Anaconda installer (Anaconda3-4.0.0-Linux-x86_64.sh) and install it
to folder ~/apps/anaconda3 (to uninstall, just remove this folder).</p>

<p>Add the following line into ~/.zshenv:</p>

<pre><code>ANACONDA_HOME=$HOME/apps/anaconda3
</code></pre>

<p>Enable Anaconda working environment with
<code>source ~/apps/anaconda3/bin/activate $ANACONDA_HOME</code>.
Leave this environment with <code>source deactivate</code>.</p>

<p>List all environments with <code>conda env list</code>.
If there is a &lsquo;root&rsquo; in the output, you can activate Anaconda as a common
conda env with <code>source activate root</code>.</p>

<p>Create a new Python 2.7 virtual environment with
<code>conda create -n py27 python=2.7</code>, make it the current environment with
<code>source activate py27</code>. You can use this command to switching between any
conda-managed environment without worrying about nested-virtualenv.</p>

<p>If you met an &ldquo;no such file or directory: activate&rdquo; error
when running <code>source activate ...</code>, use the full path
<code>~/apps/anaconda3/bin/activate</code> instead of <code>activate</code>.</p>

<p>Anaconda contains many important Python dev tools, including pip, ipython,
conda (which can be used as a replacement for pip and virtualenv).
If you want use it as the primary Python environment, add <code>$ANACONDA_HOME</code>
before the existing <code>$PATH</code>.</p>

<p>But Anaconda has no Python 2.x, so at least on Ubuntu 14.04
this is not the recommended way.
On Ubuntu 16.04, there is no Python 2.x by default, so use Python 3.5 and pip
in Anaconda3 is practical.</p>

<p>Do not add <code>$ANACONDA_HOME</code> after the <code>$PATH</code>, which will expose some binary
like <code>conda, jupyter</code>, while the other (like python and pip) will be covered
by system equivalent. This will lead inconsistent behavior and failure of
<code>conda</code> and <code>jupyter</code>.</p>

<p>Ref:</p>

<p><a href="http://www.ericmajinglong.com/2014/09/23/5-great-things-about-the-anaconda-distribution/">http://www.ericmajinglong.com/2014/09/23/5-great-things-about-the-anaconda-distribution/</a></p>

<h1>Notebook</h1>

<p>Start jupyter notebook server with <code>jupyter notebook</code>.
It creates a new window in existing browser session with url
&ldquo;<a href="http://localhost:8888/tree">http://localhost:8888/tree</a>&rdquo;.</p>

<p>Click [New -> Python3] at the right side of the page to create a new notebook
session. In the new page, use [File -> Rename] to give it a name.</p>

<p>When you click any of the notebook file <code>*.ipynb</code> (here is chap01ex.ipynb)
in browser, it will be opened in a new tab with url
&ldquo;<a href="http://localhost:8888/notebooks/chap01ex.ipynb">http://localhost:8888/notebooks/chap01ex.ipynb</a>&rdquo;.</p>

<p>Jupyter notebook support all vi-style key shortcuts, which conflicts with
Chrome plugin Vimium. So click the Vimium icon at the right side of the address
bar, and add a rule:</p>

<pre><code>Patterns: https?://localhost:8888/notebooks/*
</code></pre>

<p>Leave the &ldquo;Keys&rdquo; textbox blank, which means disable all keys of Vimium
under this pattern.</p>

<p>For Firefox, in [Tools -> Add-ons -> Extensions -> VimFx -> Blacklist], add
<code>http://localhost:8888/*</code> to disable VimFx key shortcuts on Jupyter web page.</p>

<p>Now you can use jupyter key shortcuts freely.
Use <code>h</code> key list all available shortcuts.
Note that shortcuts listed there are all capital letter,
while actually you should use the corresponding small letter.</p>

<p>Use <code>j</code>/<code>k</code> to select active cell, <Enter> to edit it, <code>c</code> to copy,
<code>v</code> to paste, <code>x</code> to delete it.</p>

<p>Use <code>m</code> to make text in a cell as markdown text, <code>y</code> to code.</p>

<p>For markdown cell, use <Enter> to edit it, use Ctrl-Enter to run it
(turn text from edit mode to markdown preview mode).</p>

<p>Use Alt-Enter to evaluate the current cell and insert a blank cell below.</p>

<p>Use <code>s</code> to save current notebook and setup a &ldquo;checkpoint&rdquo;,
use [File -> Revert to Checkpoint] to discard all changes after that checkpoint.</p>

<p>Use <code>o</code> to toggle output of the current cell,
<code>Shift-o</code> to toggle output scrolling.</p>

<p>Use [File -> Download as -> Python(.py)] to create a runnable Python script
from the current jupyter notebook.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/09/002707/">Backup Hosts on QingCloud Regularly</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-09T00:27:07+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:27 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In QingCloud [Console -> Management -> Schedulers] create a new &ldquo;Scheduler&rdquo;
&ldquo;rollingBackup&rdquo;.
Create a new &ldquo;Task&rdquo; in this scheduler:</p>

<p>Name: backupJenkins
Type: Create Snapshots
Resources: click &ldquo;Select Instances&rdquo; and choose the Jenkins host &ldquo;devops&rdquo;</p>

<p>Question:</p>

<ul>
<li><p>How to specify the interval of the backup?</p></li>
<li><p>How to specify the running time of the backup?</p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/08/191617/">Format Python Code With Autopep8</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-08T19:16:17+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>7:16 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Install: <code>pip install --user autopep8</code></p>

<p>Preview: <code>autopep8 -d &lt;target_file&gt;.py</code></p>

<p>Modify: <code>autopep8 -i &lt;target_file&gt;.py</code></p>

<p>More help: <code>autopep8 -h</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/08/092636/">用aggregate方法处理MongoDB数据</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-08T09:26:36+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:26 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>下面的aggregate方法对Fair0606 collection做如下处理：</p>

<p>用<code>$match</code>（类似于filter）筛选出recurrence长度不小于2的document (fair).</p>

<p><a href="http://bit.ly/1X9uhLY">$unwind</a>类似于flatmap,
将每一个recurrence数组中的元素变成一个document;</p>

<p><a href="http://bit.ly/1UE0BTQ">$project</a>类似于map,去掉原document的<code>_id</code>,
保留nameZHCN, website，
创建新字段time，值为recurrence.timeStart,
以及address，值为recurrence.address
（路径的写法是路径名前面加$，详见Field Path and System Variables in
<a href="http://bit.ly/1YdER3X">Aggregation Pipeline Quick Reference</a>）.</p>

<p>如果希望保留recurrence.timeStart的结构，写成<code>"recurrence.timeStart": 1,</code>.</p>

<p><code>$limit</code>要求只转换20个document, <code>$out</code>指定输出collection.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>db.Fair0606.aggregate([
</span><span class='line'>  {$match: {'recurrence.1': {$exists: true}}},
</span><span class='line'>  {$unwind: "$recurrence"},
</span><span class='line'>  {$project: {
</span><span class='line'>    _id: 0,
</span><span class='line'>    nameZHCN: 1,
</span><span class='line'>    website: 1,
</span><span class='line'>    time: "$recurrence.timeStart",
</span><span class='line'>    address: "$recurrence.address"}},
</span><span class='line'>  {$limit: 20},
</span><span class='line'>  {$out: "out1"}])</span></code></pre></td></tr></table></div></figure>


<p>通过unwind和project，可以实现对MongoDB schema的转换，下一步可以导出为csv
进行更复杂的数据分析，例如使用<a href="http://incanter.org/">Incanter</a>.</p>

<pre><code>mongoexport --type=csv -d test -c out1 \
--fields nameZHCN,website,time,address -o fairs.csv
</code></pre>

<p>参考：</p>

<p><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/">https://docs.mongodb.com/manual/reference/operator/aggregation/</a></p>

<p><a href="https://github.com/clojuredatascience">Clojure for Data Science</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/05/081046/">增强版Python REPL</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-05T08:10:46+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:10 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>bpython</h1>

<ul>
<li><p>语法高亮；</p></li>
<li><p>参数列表提示；</p></li>
<li><p>方便地查看和修改配置文件；</p></li>
<li><p>同时支持Python 2.x和3.x；</p></li>
<li><p>方便地在editor和repl间切换；</p></li>
<li><p>rewind功能方便地在repl里编写多行代码：
在代码块里用快捷键Ctrl-R取消本行，以及之前输入的行</p></li>
<li><p>方便地保存repl中脚本到文件中；</p></li>
<li><p>F1列出所有快捷键</p></li>
</ul>


<h2>Ubuntu 14.04 Unity上的配置</h2>

<p>bpython保存文件的默认快捷键是Ctrl-S，为了解决Ubuntu 14.04 Unity, Tmux环境中，
执行Ctrl-S时出现挂死问题，启动bpython后，F3进入配置文件编辑窗口，将<code>save</code>的值改为F4:</p>

<pre><code>save = F4
</code></pre>

<p>为了解决默认F1启动Gnome terminal帮助，而不是bpython帮助问题，在Terminal菜单
[Edit -> Keyboard Shortcuts -> Contents -> Help]的快捷键用退格键变为"Disabled".
如果还不行，在Unity系统的
[System Settings -> Keyboard -> Shortcuts Launchers -> Launch help browser]的
快捷键也Disable掉。</p>

<h2>For Python3</h2>

<p>Install with <code>sudo pip3 install bpython</code>, start with <code>python3 -m bpython.cli</code>.</p>

<p>另外<a href="https://github.com/jonathanslenders/ptpython">ptpython</a>，功能与bpython类似，
但没有函数的参数列表提示。</p>

<p>IPython notebook也能实现类似的功能，但似乎比较重。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/28/121437/">Clojure Linter in Vim</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-05-28T12:14:37+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:14 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Clojure Style Guide:
<a href="https://github.com/bbatsov/clojure-style-guide#source-code-layout--organization">bbatsov/clojure-style-guide</a></p>

<p>Linter:</p>

<p><a href="https://github.com/venantius/vim-cljfmt">venantius/vim-cljfmt</a>
and <a href="https://github.com/venantius/vim-eastwood">venantius/vim-eastwood</a>.</p>

<pre><code>{:user {:plugins [[lein-try "0.4.3"]
                  [cider/cider-nrepl "0.12.0"]
                  [jonase/eastwood "0.2.3"]
                  [cljfmt "0.5.1"]]}}
</code></pre>

<p>Add <code>:plugins [[lein-cljfmt "0.5.3"]]</code> into your leiningen project, run:</p>

<pre><code>lein eastwood
lein cljfmt check
</code></pre>

<p>Install their vim plugins:</p>

<p>Add <code>Plugin 'venantius/vim-cljfmt'</code> in .vimrc and install it
with <code>vim +PluginClean +PluginInstall</code>.</p>

<p><code>project.clj</code> file:</p>

<pre><code>(defproject sync-with-recur-order "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :dependencies [[org.clojure/clojure "1.8.0"]
                 [org.clojure/data.json "0.2.6"]
                 [lein-cljfmt "0.5.3"]]
  :plugins [[lein-cljfmt "0.5.3"]])
</code></pre>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/11/11/114228/">Ubuntu 14.04 Apt Update Failure</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/05/083438/">Use Matplotlib in Python 3 on Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/31/171345/">理解IP地址和CIDR</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/25/110137/">保证Docker的输入参数可执行</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/20/113258/">为vim增加undo功能</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leetschau">@leetschau</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leetschau',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Li Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
