
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>青云的负载均衡器 - Dark Matter in Cyberspace</title>
  <meta name="author" content="Li Chao">

  
  <meta name="description" content="青云把负载均衡器抽象成了三个概念：一是负载均衡器本身；二是监听器，三是后端主机。 负载均衡器分为公网和私有网络两种类型，
前者可以同时关联多个公网IP，但它绑定的后端只能是公网服务器/私有网络路由器/公网IP，
后者直接与某个私有网络关联，后端是这个私有网络中某台服务器的某端口。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leetschau.github.io/blog/2015/12/29/134651/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Dark Matter in Cyberspace" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dark Matter in Cyberspace</a></h1>
  
    <h2>The technical blog of Li Chao in Beijing</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="leetschau.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">青云的负载均衡器</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-29T13:46:51+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:46 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>青云把负载均衡器抽象成了三个概念：一是负载均衡器本身；二是监听器，三是后端主机。</p>

<p>负载均衡器分为<em>公网</em>和<em>私有网络</em>两种类型，
前者可以同时关联多个公网IP，但它绑定的后端只能是公网服务器/私有网络路由器/公网IP，
后者直接与某个私有网络关联，后端是这个私有网络中某台服务器的某端口。
<em>公网</em>类型的负载均衡器可以通过路由器的端口映射实现与私有网络某主机端口连接。</p>

<p>监听器代表负载均衡器对外提供的协议类型和端口；
后端主机页面上的"端口"指的是后端主机上服务进程监听的端口。</p>

<p>只要用户创建负载均衡器、监听器、主机，就可以在界面里完成负载均衡器的所有操作。</p>

<p>一条转发策略，代表一条从域名到主机和端口的关联规则，所以如果是同一个服务有多个域名，
可以配置在同一个转发策略里。
如果是两个不同的服务，即使是同一IP不同端口，也要配置在不同的转发策略里。</p>

<h1>示例</h1>

<h2>添加第一个服务</h2>

<p>需要将内网中的一台服务器作为beta服务器，
外部用户可以通过域名 beta.nufair.com 从公网访问，实现方法：</p>

<ol>
<li><p>在青云控制台 [计算与网络 -> 公网IP]中购买IP地址 nufairIP: 123.234.34.5</p></li>
<li><p>在域名 (nufair.com) DNS配置中增加一条A记录：beta -> 123.234.34.5</p></li>
<li><p>新建 [路由器] nufairRouter, 绑定nufairIP;</p></li>
<li><p>新建 [私有网络] nufairNet, 绑定nufairRouter;</p></li>
<li><p>新建 [主机] beta-app.nufair.com, IP: 192.168.100.121, 加入 nufairNet;</p></li>
<li><p>在 beta-app.nufair.com 中部署应用，服务监听端口 3000;</p></li>
<li><p>新建 [负载均衡器] nufairLB, IP：192.168.100.4, 绑定nufairNet;</p></li>
<li><p>[nufairRouter -> 端口转发]中添加规则 http-route: tcp 80 -> 192.168.100.4 80</p></li>
<li><p>[nufairRouter -> 基本属性]中点击[防火墙]，在其中增加规则：允许80端口下行；</p></li>
<li><p>[nufairLB -> 转发策略] 中新建转发策略:</p>

<blockquote><p>名称：app-beta
匹配方式：匹配任意规则</p></blockquote>

及其规则：

<blockquote><p>规则类型: 按域名转发
规则内容: beta.nufair.com</p></blockquote></li>
<li><p>nufairLB 中新建一个[监听器] http-listener, 为其[添加后端]，</p>

<blockquote><p>名称：beta
网络：受管私有网络
主机：192.168.100.121
端口：3000</p></blockquote>

<p>创建完成后，在[转发策略]一栏中点击[绑定]，选择[app-beta].</p></li>
</ol>


<h2>添加第二个服务</h2>

<p>需要将内网中另一台服务器作为生产服务器，通过域名nufair.com和www.nufair.com访问。</p>

<ol>
<li><p>青云控制台中购买一台主机，IP: 192.168.100.21, 在上面部署生产应用，服务监听端口3000;</p></li>
<li><p>在域名 (nufair.com) DNS配置中增加两条A记录：
@ -> 123.234.34.5
www -> 123.234.34.5</p></li>
<li><p>[nufairLB -> 转发策略] 中新建转发策略:</p>

<blockquote><p>名称：app-production
匹配方式：匹配任意规则</p></blockquote>

及其规则：

<blockquote><p>规则类型: 按域名转发
规则内容: nufair.com www.nufair.com</p></blockquote></li>
<li><p><a href="">nufairLB -> http-listener -> 添加后端</a>:</p>

<blockquote><p>名称：prod
网络：受管私有网络
主机：192.168.100.21
端口：3000</p></blockquote>

<p>创建完成后，在[转发策略]一栏中点击[绑定]，选择[app-production].</p></li>
</ol>


<p>说明：</p>

<p>转发策略的规则里，如果是按域名转发，注意一级域名，如nufair.com，
它实际上是<code>*.nufair.com</code>，当监听器的某个后端绑定了这样的规则后，
它后面的后端再绑定这个一级域名下的二级域名将无效，
例如将test.nufair.com指向100.21服务器的4500端口，</p>

<p>[nufairLB -> 转发策略] 中新建转发策略:</p>

<blockquote><p>名称：app-test
匹配方式：匹配任意规则</p></blockquote>

<p>  及其规则：</p>

<blockquote><p>规则类型: 按域名转发
规则内容: test.nufair.com</p>

<p>名称：test
网络：受管私有网络
主机：192.168.100.21
端口：4500</p></blockquote>

<p>  创建完成后，在[转发策略]一栏中点击[绑定]，选择[app-test].</p>

<p>应用修改后，test.nufair.com仍然指向3000端口上的服务，
原因是它作为nufair.com的二级域名，被app-production中的一级域名覆盖了，
解决方法是，从app-production中去掉"nufair.com".</p>

<p>修改负载均衡器IP地址后需要注意：
要相应修改路由器中端口转发中目标（也就是负载均衡器）的IP地址。</p>

<p>参考：</p>

<p><a href="http://network.51cto.com/art/201504/472491.htm">青云QingCloud：云上最强负载均衡服务</a></p>

<p><a href="https://docs.qingcloud.com/guide/loadbalancer.html">负载均衡器指南</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Li Chao</span></span>

      




<time class='entry-date' datetime='2015-12-29T13:46:51+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:46 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/load-balancer/'>load balancer</a>, <a class='category' href='/blog/categories/qingcloud/'>qingcloud</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://leetschau.github.io/blog/2015/12/29/134651/" data-via="" data-counturl="http://leetschau.github.io/blog/2015/12/29/134651/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/12/27/185843/" title="Previous Post: Move Some Commit from One Repo to Another">&laquo; Move Some Commit from One Repo to Another</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/12/30/162805/" title="Next Post: Wordpress中文文章详情页无法打开问题">Wordpress中文文章详情页无法打开问题 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/11/11/114228/">Ubuntu 14.04 Apt Update Failure</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/05/083438/">Use Matplotlib in Python 3 on Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/31/171345/">理解IP地址和CIDR</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/25/110137/">保证Docker的输入参数可执行</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/20/113258/">为vim增加undo功能</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leetschau">@leetschau</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leetschau',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Li Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
