<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Schema | Dark Matter in Cyberspace]]></title>
  <link href="http://leetschau.github.io/blog/categories/schema/atom.xml" rel="self"/>
  <link href="http://leetschau.github.io/"/>
  <updated>2016-11-11T15:03:30+08:00</updated>
  <id>http://leetschau.github.io/</id>
  <author>
    <name><![CDATA[Li Chao]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[MongoDB Schema Analysis]]></title>
    <link href="http://leetschau.github.io/blog/2016/03/29/183444/"/>
    <updated>2016-03-29T18:34:44+08:00</updated>
    <id>http://leetschau.github.io/blog/2016/03/29/183444</id>
    <content type="html"><![CDATA[<p>Use <a href="https://github.com/variety/variety-cli">variety/variety-cli</a> to
analysis mongodb schema.</p>

<h1>Install with npm</h1>

<p><code>npm install variety-cli -g</code>
If the command <code>variety</code> is conflict with
<a href="http://peterlevi.com/variety/">Variety the Wallpaper Changer</a>,
add <code>alias variety='/home/leo/apps/node-v5.4.1-linux-x64/bin/variety'</code>
into ~/.bash_aliases.</p>

<p>The production database is connected with
<code>mongo 192.168.10.89:27017/production -u user -p password</code>.
To analyze it, run:</p>

<pre><code class="bash">variety production/Fair --host 192.168.10.89 --port 27017 --username user --password password
</code></pre>

<p>Note you can&rsquo;t use <code>-u</code> instead of <code>--username</code> above.</p>

<h1>Run with mongo</h1>

<p>Download variety.js from it&rsquo;s repo and run:</p>

<pre><code class="bash">mongo 192.168.10.89:27017/production -u user -p password --eval "var collection = 'Fair'" variety.js
+------------------------------------------------------------------------------------------------------------------------------+
| key                                              | types                              | occurrences | percents               |
| ------------------------------------------------ | ---------------------------------- | ----------- | ---------------------- |
| _id                                              | String                             |        9316 | 100.000000000000000000 |
| recurrence.XX._id                                | String                             |        9276 |  99.570631172176902624 |
| recurrence.XX.timeStart                          | String (9180),Date (116)           |        9275 |  99.559896951481320571 |
</code></pre>

<p>Verify it with mongo shell:</p>

<pre><code class="bash">mongo 192.168.10.89:27017/production -u dba -p password
&gt; db.Fair.count()
9316
&gt; db.Fair.find({'recurrence._id': {$exists: true}}).count()
9276
&gt; db.Fair.find({$and: [{'recurrence': {$exists: true}}, {'recurrence._id': {$exists: false}}]}).count()
40      // 9316 - 9276
&gt; db.Fair.find({'recurrence.timeStart': {$exists: true}}).count()
9275    // 
&gt; db.Fair.find({$and: [{'recurrence._id': {$exists: true}}, {'recurrence.timeStart': {$exists: false}}]}).count()
1       // 9276 - 9275
&gt; db.Fair.find({'recurrence.timeStart': {$type: 2 }}).count()
9180
&gt; db.Fair.find({'recurrence.timeStart': {$type: 9}}).count()
116
&gt; db.Fair.find({$and: [{'recurrence.timeStart': {$exists: true}}, {'recurrence.timeStart': {$not: {$type: 2}}}, {'recurrence.timeStart': {$not: {$type: 9}}}]}).count()
0      // there's no other data type, all you need to do is converting String to Date
</code></pre>

<p>For type number, 2 means String, 9 means Date.
See their definitions in <a href="https://docs.mongodb.org/manual/reference/operator/query/type/">$type in MongoDB doc</a>.</p>

<p>Why 9180 + 116 > 9275? Because all the numbers here is the counts of fairs.
While in a single fair there are maybe many recurrences.
So if a fair has 2 recurrences, one&rsquo;s timeStart type is String,
and the other&rsquo;s type is Date,
it will be counted twice, both in 9180 and 116.</p>

<h1>Unify Schema</h1>

<p>We need convert the type of &ldquo;updatedAt&rdquo;, &ldquo;recurrence.$.timeStart&rdquo;
and &ldquo;recurrence.$.timeEnd&rdquo; from String to Date with mongo script below:</p>

<pre><code>db.Fair.find({'recurrence.timeStart': {$type: 2}}).forEach(function(fair) {   
  fair.recurrence.forEach(function(rec) { 
    if (typeof(rec.timeStart) === 'string') {
      rec.timeStart = new Date(rec.timeStart);
    }
  });
  db.Fair.save(fair);
});
db.Fair.find({'recurrence.timeEnd': {$type: 2}}).forEach(function(fair) {   
  fair.recurrence.forEach(function(rec) {
    if (typeof(rec.timeEnd) === 'string') {
      rec.timeEnd = new Date(rec.timeEnd);
    }
  });
  db.Fair.save(fair);
});
db.Fair.find({'updatedAt': {$type: 2}}).forEach(function(fair) {
  fair.updatedAt = new Date(fair.updatedAt);
  db.Fair.save(fair);
});
</code></pre>
]]></content>
  </entry>
  
</feed>
