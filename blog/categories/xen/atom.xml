<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Xen | Dark Matter in Cyberspace]]></title>
  <link href="http://leetschau.github.io/blog/categories/xen/atom.xml" rel="self"/>
  <link href="http://leetschau.github.io/"/>
  <updated>2014-10-01T21:14:19+08:00</updated>
  <id>http://leetschau.github.io/</id>
  <author>
    <name><![CDATA[Li Chao]]></name>
    <email><![CDATA[leetschau@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Xen on CentOS 6]]></title>
    <link href="http://leetschau.github.io/blog/2014/09/24/073009/"/>
    <updated>2014-09-24T07:30:09+08:00</updated>
    <id>http://leetschau.github.io/blog/2014/09/24/073009</id>
    <content type="html"><![CDATA[<p>Ref: <a href="http://wiki.centos.org/HowTos/Xen/Xen4QuickStart">Xen4 CentOS6 QuickStart</a> &amp; <a href="http://wiki.centos.org/HowTos/Xen/Xen4QuickStart/Xen4Libvirt">Xen4 Libvirt for CentOS 6</a>.</p>

<h1>Build Xen Server</h1>

<p>The IP address of the Xen server (a Dell PC) is 10.32.1.112.
First install CentOS 6.4 via Minimal CD (or LiveDVD) and install Xen on the new OS;</p>

<pre><code>yum update
yum groupinstall Virtualization
yum install centos-release-xen   // unnecessary if install OS with LiveDVD
yum install xen bridge-utils
/usr/bin/grub-bootxen.sh
reboot
yum install libvirt python-virtinst libvirt-daemon-xen
yum install rsync wget vim-enhanced openssh-clients   // unnecessary if install OS with LiveDVD
reboot
uname -r  // the kernel should be 3.x
xm info
useradd -m chad
groupadd remote-libvirt
usermod -G remote-libvirt chad
cat &gt; /etc/polkit-1/localauthority/50-local.d/50-libvirt-remote-access.pkla &lt;&lt;EOF
[Remote libvirt SSH access]
Identity=unix-group:remote-libvirt
Action=org.libvirt.unix.manage
ResultAny=yes
ResultInactive=yes
ResultActive=yes
EOF
</code></pre>

<h2>Config network</h2>

<p>Modify dom0 host file /etc/xen/xend-config.sxp:</p>

<p>Comment out &ldquo;(network-script /bin/true)&rdquo; to &ldquo;(network-script &lsquo;network-bridge bridge=virbr0 netdev=eth0&rsquo;)&rdquo;.</p>

<h1>Build Xen Client</h1>

<p>We usually do not work on a Xen dom0 server. So here we install xen client on a Mint OS, and control Xen server with it:</p>

<h2>GUI Client</h2>

<p>First install with <code>sudo aptitude install virt-manager</code>, then run it with <code>virt-manager</code>. The &ldquo;Virtual Machine Manager&rdquo; window appears.</p>

<p>[Edit -> Connect Details -> Storage], Location: /var/lib/libvirt/images. So copy an OS image file (here it&rsquo;s CentOS-6.5-x86_64-minimal.iso) to this folder, and press the refresh button after &ldquo;Volumns&rdquo;, the ISO file appears.</p>

<p>Click &ldquo;New&rdquo; on toolbar, Name: Cloud21, check &ldquo;Local install media&rdquo; -> Use ISO image: /var/lib/libvirt/images/CentOS-6.5-x86_64-minimal.iso, OS type: Linux, Version: Red Hat Enterprise Linux 6 -> Memory: 1024 MB, CPUs: 1 -> Create a disk image &hellip;: 8.0 GB.</p>

<p>Now install CentOS with Minimal ISO file.</p>

<h2>Console Client</h2>

<pre><code>sudo aptitude install libvirt-bin
virsh -c xen+ssh://chad@10.32.1.112
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Xen on ArchLinux]]></title>
    <link href="http://leetschau.github.io/blog/2014/09/17/215227/"/>
    <updated>2014-09-17T21:52:27+08:00</updated>
    <id>http://leetschau.github.io/blog/2014/09/17/215227</id>
    <content type="html"><![CDATA[<p>Today I bought a new hard disk, and tried to install xen on it.</p>

<h1>Install Base ArchLinux</h1>

<ol>
<li><p>Start computer with USB key, choose x86_64, NBD;</p></li>
<li><p>This is not UEFI boot: an error raised when <code>efivar -l</code>;</p></li>
<li><p>Install system:</p>

<p> # rmmod tg3
 # modprobe broadcom
 # modprobe tg3
 # systemctl stop dhcpcd.service
 # dhcpcd enp2s0
 # sgdisk &ndash;zap-all /dev/sda
 # cgdisk /dev/sda
 // choose GPT partitions type, /dev/sda1: 50G, /dev/sda2: 300G, 581G free
 # mkfs.ext4 /dev/sda1
 # mkfs.ext4 /dev/sda2
 # mount /dev/sda1 /mnt
 # mkdir /mnt/home
 # mount /dev/sda2 /mnt/home
 # vi /etc/pacman.d/mirrorlist
 # export http_proxy=<a href="http://10.32.1.154:8888">http://10.32.1.154:8888</a>
 # export https_proxy=<a href="http://10.32.1.154:8888">http://10.32.1.154:8888</a>   // add the ip into &ldquo;allow&rdquo; list tinyproxy.conf
 # pacstrap -i /mnt base base-devel
 # genfstab -U -p /mnt >> /mnt/etc/fstab
 # vi /etc/locale.gen
 # locale-gen
 # echo LANG=en_US.UTF-8 > /etc/locale.conf
 # export LANG=en_US.UTF-8
 # ln -s /usr/share/zoneinfo/Hongkong /etc/localtime
 # hwclock &ndash;systohc &ndash;utc
 # echo xenserver > /etc/hostname
 # vi /etc/hosts
 # systemctl enable <a href="&#x6d;&#x61;&#x69;&#x6c;&#116;&#x6f;&#x3a;&#x64;&#104;&#99;&#112;&#99;&#x64;&#x40;&#101;&#x6e;&#112;&#x32;&#x73;&#48;&#x2e;&#x73;&#x65;&#114;&#118;&#x69;&#99;&#101;">&#x64;&#x68;&#99;&#x70;&#x63;&#x64;&#64;&#x65;&#110;&#x70;&#50;&#x73;&#48;&#46;&#x73;&#x65;&#x72;&#x76;&#x69;&#x63;&#x65;</a>
 # passwd
 # export http_proxy=<a href="http://10.32.1.154:8888">http://10.32.1.154:8888</a>
 # export https_proxy=<a href="http://10.32.1.154:8888">http://10.32.1.154:8888</a>
 # pacman -S openssh
 # systemctl enable sshd.service
 # pacman -S gptfdisk            // use syslinux boot loader for GPT installed previously
 # pacman -S syslinux
 # syslinux-install_update -iam
 # vi /boot/syslinux/syslinux.cfg    // modify sda3 to sda1 in &ldquo;APPEND root=/dev/sda3&rdquo;
 # exit
 # reboot</p></li>
</ol>


<h1>Customize System</h1>

<p>After reboot, login as root and run:</p>

<pre><code># useradd -m chad
# passwd chad
# passwd -l root     // disable root login, use can remove this by `sudo passwd -u root`
# export http_proxy=http://10.32.1.154:8888
# export https_proxy=http://10.32.1.154:8888
# pacman -Syu
# pacman -S xorg-server xorg-server-utils xorg-xinit i3 dmenu xf86-video-intel terminator ttf-dejavu firefox
# su - chad
$ echo exec i3 &gt; ~/.xinitrc
$ startx
</code></pre>

<h1>Install Xen</h1>

<p>First make sure the host can access internet, then enable multilib repository, uncomment following lines in /etc/pacman.conf:</p>

<pre><code>[multilib]
Include = /etc/pacman.d/mirrorlist
</code></pre>

<p>Install yaourt, see note &ldquo;Yaourt Notes&rdquo; for details. Then run <code>yaourt -S xen</code>. If failed, install it manually:</p>

<p>Download xen.tar.gz, and run:</p>

<pre><code>tar xf xen.tar.gz
cd xen
makepkg
sudo pacman -U xen-4.4.1-1-x86_64.pkg.tar.xz
</code></pre>

<p>Config network:</p>

<pre><code># cd /etc/netctl
# cp examples/bridge xenbridge-dhcp
# vi xenbridge-dhcp
# netctl start xenbridge-dhcp
# brctl show
# netctl enable xenbridge-dhcp
</code></pre>

<p>Config services:</p>

<pre><code>sudo systemctl enable xenstored.service
sudo systemctl enable xenconsoled.service
sudo systemctl enable xendomains.service
</code></pre>

<p>Config boot loader. Add following stanza to /boot/syslinux/syslinux.cfg:</p>

<pre><code>LABEL xen
    MENU LABEL Xen
    KERNEL mboot.c32
    APPEND ../xen-4.4.1.gz --- ../vmlinuz-linux console=tty0 root=/dev/sda1 ro --- ../initramfs-linux.img
</code></pre>

<p>And make sure there is a &ldquo;mboot.c32&rdquo; file in folder /boot/syslinux, or you have to copy it:
<code>cp /usr/lib/syslinux/bios/mboot.c32 /boot/syslinux/</code>.</p>

<p>Note: If there is file conflicting errors, use <code>sudo pacman -U --force xen-4.4.1-1-x86_64.pkg.tar.xz</code> to install it.</p>

<p>Reboot, choose &ldquo;Xen&rdquo; at boot screen, then run <code>sudo xl list</code> (list all xen domains), you can see a &ldquo;Domain-0&rdquo; item.
If you boot with ArchLinux, run <code>sudo xl list</code> will report an error.</p>

<h1>Install Guest OS on Xen</h1>

<p>See <a href="http://wiki.xen.org/wiki/Xen_Configuration_File_Options#Disk_Devices">Xen Configuration File Options</a> for full syntax of xen domU config files.</p>

<h2>CentOS 6.5 minimal</h2>

<h3>PV</h3>

<p>Not succeed yet. Maybe we should use CentOS as dom0 system.</p>

<pre><code>$ mkdir ~/docs/cloud60
$ cd ~/docs/cloud60
$ dd if=/dev/zero of=cloud60.img bs=1M count=10240
$ mkfs.ext4 cloud60.img
$ sudo mount -o loop CentOS-6.5-x86_64-minimal.iso /mnt
$ cat cloud60.conf      // ???
$ sudo xl create -c cloud60.conf
</code></pre>

<h3>HVM</h3>

<pre><code>$ sudo pacman -S mesa-libgl bluez-libs tigervnc
$ mkdir ~/docs/cloud60
$ cd ~/docs/cloud60
$ dd if=/dev/zero of=cloud60.img bs=1M count=10240
$ mkfs.ext4 cloud60.img
$ sudo mount -o loop CentOS-6.5-x86_64-minimal.iso /mnt
$ cat cloud60.conf
name = "hvmcentos"
builder = "hvm"
memory = 1024
disk = [ "file:/home/chad/docs/cloud60/cloud60.img,xvda,w", "file:/home/chad/warez/CentOS-6.5-x86_64-minimal.iso,xvdb:cdrom,r" ]
vif = ["bridge=xenbr0"]
vnc = 1
vnclisten = "0.0.0.0"
vncdisplay = 1

$ sudo xl create cloud60.conf
$ sudo xl vncviewer hvmcentos
</code></pre>

<p>Or you can use <code>vncviewer localhost:5901</code> to connect to the guest OS, here the &ldquo;1&rdquo; in &ldquo;5901&rdquo; is determined by the value of &ldquo;vncdisplay&rdquo; in guest OS config file.
After connecting to the guest OS, install system, then reboot and connect it with vncviewer again.
You can use xl&rsquo;s subcommands &ldquo;list&rdquo;, &ldquo;top&rdquo; and &ldquo;info&rdquo; to probe domU systems.</p>

<h1>Using Xen</h1>

<p>Based on <a href="https://wiki.archlinux.org/index.php/Xen">Xen on Arch Wiki</a>.</p>

<p>Use Debian as dom0: <a href="http://wiki.xenproject.org/wiki/Xen_Project_Beginners_Guide#Installing_the_Xen_Project_Software">Xen Project Beginners Guide</a>;</p>

<p>Use CentOS as dom0: <a href="http://wiki.centos.org/HowTos/Xen/Xen4QuickStart">Xen4 CentOS6 QuickStart</a>;</p>

<p>Use Ubuntu as dom0: <a href="https://help.ubuntu.com/community/Xen">Xen in Ubuntu Community</a>;</p>

<p>Other patterns see <a href="http://wiki.xenproject.org/wiki/Category:Guest_Install">Guest Install</a>;</p>
]]></content>
  </entry>
  
</feed>
