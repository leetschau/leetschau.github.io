<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Meteor | Dark Matter in Cyberspace]]></title>
  <link href="http://leetschau.github.io/blog/categories/meteor/atom.xml" rel="self"/>
  <link href="http://leetschau.github.io/"/>
  <updated>2015-02-02T16:10:00+08:00</updated>
  <id>http://leetschau.github.io/</id>
  <author>
    <name><![CDATA[Li Chao]]></name>
    <email><![CDATA[leetschau@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Full Text Search for Meteor App]]></title>
    <link href="http://leetschau.github.io/blog/2015/02/01/134829/"/>
    <updated>2015-02-01T13:48:29+08:00</updated>
    <id>http://leetschau.github.io/blog/2015/02/01/134829</id>
    <content type="html"><![CDATA[<p>For Meteor 1.0.3, the built-in database is mongodb 2.4, which is not support full text search by default.
So we need install a stand-alone MongoDB 2.6, create a &ldquo;meteor&rdquo; database, and let Meteor to use it as backend database:</p>

<p>First start MongoDB server: <code>mongod --dbpath ~/docs/mongodb-repo</code>;</p>

<p>Then create a new database &ldquo;meteor&rdquo; for Meteor app backend:</p>

<pre><code>$ mongo
&gt; show dbs
&gt; use meteor
</code></pre>

<p>Next start Meteor server and connect it with the Mongodb server:</p>

<pre><code>$ MONGO_URL="mongodb://localhost:27017/meteor" meteor
&gt; db.zips.getIndexes()
&gt; db.zips.dropIndex("forsearch_text")
&gt; db.zips.ensureIndex( {city: "text", state: "text"} )
&gt; db.zips.find( {$text: {$search: "lee ma"}} ).count()
488
</code></pre>

<p>Here <code>use meteor</code> create a new database in MongoDB (if it doesn&rsquo;t exists yet)
and use it as the current database.
Use <code>db</code> to get the current database name.</p>

<p>Ref:</p>

<p><a href="http://docs.mongodb.org/manual/tutorial/getting-started/">Getting Started with MongoDB</a></p>

<p><a href="http://docs.mongodb.org/manual/administration/indexes-text/">Text Search Tutorials of MongoDB 2.6.7</a>;</p>

<p><a href="http://docs.mongodb.org/manual/reference/operator/query/text/">$text query operator of MongoDB 2.6.7</a></p>

<p><a href="http://stackoverflow.com/questions/10610131/checking-if-a-field-contains-a-string">Checking if a field contains a string</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[基于Search Source的简单查询实现方法]]></title>
    <link href="http://leetschau.github.io/blog/2015/01/30/183509/"/>
    <updated>2015-01-30T18:35:09+08:00</updated>
    <id>http://leetschau.github.io/blog/2015/01/30/183509</id>
    <content type="html"><![CDATA[<p>这个搜索基于<a href="https://github.com/meteorhacks/search-source/">search-source</a>.
通过<code>meteor add meteorhacks:search-source</code>添加到meteor中，
代码参照了<a href="https://github.com/meteorhacks-samples/meteor-instant-search-demo">meteor-instant-search-demo</a>.</p>

<h1>准备数据源</h1>

<h2>导入数据</h2>

<ol>
<li><p>下载<a href="http://media.mongodb.org/zips.json">zips.json</a>；
参考<a href="http://stackoverflow.com/questions/5723896/is-there-a-sample-mongodb-database-along-the-lines-of-world-for-mysql">Is there a sample MongoDB Database along the lines of world for MySql?</a>.</p></li>
<li><p>导入Meteor数据库中：启动meteor服务，然后在另一个shell里运行：
<code>~/apps/mongodb-linux-x86_64-2.6.5/bin/mongoimport -h localhost:3001 --db meteor --collection zips --type json --file zips.json</code>;</p></li>
<li><p>增加搜索字段：由于简单搜索要求输入可能匹配任意字段，
能达到这个要求的唯一方法就是将被查询的字段连接成一个完整的“搜索”字符串，
输入的各项可以以任何顺序出现在这个搜索字符串（这里这一项名为&#8221;forsearch&#8221;）中，下面增加这一项：</p>

<pre><code> db.zips.find().forEach(function(elem) {
     db.zips.update(
       {_id: elem._id},
       { $set: {forsearch: elem.city + ' ' + elem.state}}
     );
 });
</code></pre>

<p> 参考<a href="http://stackoverflow.com/questions/3974985/update-mongodb-field-using-value-of-another-field">Update MongoDB field using value of another field</a>.</p></li>
</ol>


<h1>搜索逻辑</h1>

<p>下面&#8221;/&ldquo;都指项目根目录。</p>

<h2>数据集定义</h2>

<p>在/collections.js中定义数据集和索引：</p>

<pre><code>Zips = new Mongo.Collection('zips');
if(Meteor.isServer) {
  Zips._ensureIndex({city: 1, state: 1});
}
</code></pre>

<h2>服务端</h2>

<p>在/server/server.js中定义：</p>

<pre><code>SearchSource.defineSource('zips', function(searchText, options) {
  var options = {sort: {isoScore: -1}, limit: 20};

  if(searchText) {
    var regExp = buildRegExp(searchText);
    var selector =  {forsearch: regExp};
    return Zips.find(selector, options).fetch();
  } else {
    return Zips.find({}, options).fetch();
  }
});

function buildRegExp(searchText) {
  var parts = searchText.trim().split(/[ \-\:]+/);
  for (i=0; i&lt;parts.length; ++i) {
    parts[i] = "(?=.*" + parts[i] + ")";
  }
  var res = new RegExp("(" + parts.join("") + ")", "i");
  return res;
}
</code></pre>

<p>buildRegExp函数中的正则表达式<code>(?=.*A)(?=.*B)</code>可以实现对A和B任意顺序的匹配，
即既能匹配A.<em>B，又能匹配B.</em>A，
参考<a href="http://stackoverflow.com/questions/19896324/match-string-in-any-word-order-regex">match string in any word order regex</a>.</p>

<h2>客户端：搜索输入框框即时响应</h2>

<p>搜索框是通用控件，所以定义在了/client/comTemp.js中，定义了对框中keyup事件的响应：</p>

<pre><code>Template.Header.events({
  "keyup #search-input": _.throttle(function(e) {
    var text = $(e.target).val().trim();
    ZipSearch.search(text);
  }, 200)
});
</code></pre>

<h2>客户端：搜索结果展示页面</h2>

<p>定义在/client/results.html中。</p>

<pre><code>&lt;template name="SearchResults"&gt;
  &lt;div id="search-result" class="container content"&gt;
    &lt;div id="search-meta"&gt;
      
        searching ...
      
    &lt;/div&gt;

    
      &lt;div class="package"&gt;
        &lt;h4 class="name"&gt;
          }
        &lt;/h4&gt;
        &lt;div class="description"&gt;
          }, }
        &lt;/div&gt;
      &lt;/div&gt;
    
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>

<h2>客户端：搜索结果的数据控制</h2>

<p>定义在/client/results.js中。</p>

<pre><code>var options = {
  keepHistory: 1000 * 60 * 5,
  localSearch: true
};
var fields = ['forsearch'];     // 这里定义要搜索的字段

ZipSearch = new SearchSource('zips', fields, options);
// 这里的zips要与服务端SearchSource.defineSource中定义的名字一致

Template.SearchResults.helpers({
  getZips: function() {
    return ZipSearch.getData({
      transform: function(matchText, regExp) {
        console.log("matchText: " + matchText);
        console.log("regExp: " + regExp);
        var res = matchText.replace(regExp, "&lt;b&gt;$&amp;&lt;/b&gt;");
        console.log("res is: " + res);
        return res;
      },
      sort: {isoScore: -1}
    });
  },

  isLoading: function() {
    return ZipSearch.getStatus().loading;
  }
});

Template.SearchResults.rendered = function() {
  ZipSearch.search('');
};
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Meteor Development Styles]]></title>
    <link href="http://leetschau.github.io/blog/2015/01/26/174649/"/>
    <updated>2015-01-26T17:46:49+08:00</updated>
    <id>http://leetschau.github.io/blog/2015/01/26/174649</id>
    <content type="html"><![CDATA[<h1>Naming Styles</h1>

<ul>
<li><p>Template, class, enum name use BigCamelCase;</p></li>
<li><p>File, identifier, function name use smallCamelCase;</p></li>
<li><p>CSS class name: css-class-name;</p></li>
<li><p>Constant value name: CONSTANT_VALUES_LIKE_THIS;</p></li>
</ul>


<p>Ref:</p>

<p><a href="https://github.com/meteor/meteor/wiki/Meteor-Style-Guide">Meteor Style Guide</a></p>

<p><a href="https://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml#Naming">Googe JavaScript Naming rules</a>:
use functionNamesLikeThis, variableNamesLikeThis, ClassNamesLikeThis, EnumNamesLikeThis, methodNamesLikeThis, CONSTANT_VALUES_LIKE_THIS, foo.namespaceNamesLikeThis.bar, and filenameslikethis.js.</p>

<p><a href="https://github.com/airbnb/javascript">Airbnb JavaScript Style Guide</a></p>

<h1>Small Project Structure with Iron Router</h1>

<p>The following is the file structure of small meteor app,
which put all files into root folder, to simplify file editing and browsing.</p>

<ul>
<li><p>head.html: contains &ldquo;<head> &hellip; </head>&rdquo;;</p></li>
<li><p>layout.html: defines layouts of the app, each in a &ldquo;<template>&rdquo;, you can put multiple layouts in this file;</p></li>
<li><p>router.js: defines all routes and layouts. Put all javascript codes starting with &ldquo;Router.&rdquo; (such as Router.route, Router.configure) into this file;</p></li>
<li><p>collections.js: define persistent collections, or models of application;</p></li>
<li><p>style.css: defines global css styles here;</p></li>
<li><p>comTemp.html: defines global common templates here;</p></li>
<li><p>page triad: consists of a view (html), a controller (js) and a formatter (css).
  So the home page triad consists of home.html, home.js and home.css;</p></li>
</ul>


<h1>Large Project Structures</h1>

<p><a href="https://github.com/DiscoverMeteor/Microscope">Microscope</a> of <a href="https://www.discovermeteor.com/">Discover Meteor</a> is a good example:</p>

<p>$ git clone <a href="https://github.com/DiscoverMeteor/Microscope.git">https://github.com/DiscoverMeteor/Microscope.git</a>
$ cd Microscope
$ tree -L 3
.
├── client
│   ├── helpers
│   │   ├── config.js
│   │   ├── errors.js
│   │   └── handlebars.js
│   ├── main.html
│   ├── main.js
│   ├── stylesheets
│   │   └── style.css
│   └── templates
│       ├── application
│       ├── comments
│       ├── includes
│       ├── notifications
│       └── posts
├── lib
│   ├── collections
│   │   ├── comments.js
│   │   ├── notifications.js
│   │   └── posts.js
│   ├── permissions.js
│   └── router.js
├── LICENSE.txt
├── README.markdown
├── README.nitrous.md
└── server
    ├── fixtures.js
    └── publications.js</p>

<p>Ref:</p>

<p><a href="http://docs.meteor.com/#/full/structuringyourapp">Structuring your application in Meteor Docs</a></p>

<p><a href="https://github.com/EventedMind/iron-router/blob/devel/Guide.md">iron-router official guide</a></p>

<p>google &ldquo;iron router layout&rdquo;;</p>

<p><a href="http://www.manuel-schoebel.com/blog/iron-router-tutorial">Iron-Router Tutorial</a></p>

<p><a href="http://stackoverflow.com/questions/21824045/meteor-iron-router-layout-template">Meteor Iron Router layout template</a></p>

<p><a href="http://stackoverflow.com/questions/19909945/meteor-iron-router-layout-rendering">Meteor Iron-Router Layout Rendering</a></p>

<p><a href="http://robertdickert.com/blog/2014/05/09/set-up-navigation-with-iron-router-and-bootstrap/">Set Up Navigation With Iron Router and Bootstrap</a></p>

<p><a href="http://meteortips.com/tutorial/iron-router-part-1/">A Beginner’s Guide to Iron Router, Part 1</a> on <a href="http://meteortips.com/">Meteor Tips</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Simple Search Homepage]]></title>
    <link href="http://leetschau.github.io/blog/2015/01/18/142454/"/>
    <updated>2015-01-18T14:24:54+08:00</updated>
    <id>http://leetschau.github.io/blog/2015/01/18/142454</id>
    <content type="html"><![CDATA[<p>The key points in this web page is:</p>

<ul>
<li><p>How to position a <div> absolute centering with CSS;</p></li>
<li><p>How to add a footer sticky to page bottom: add <code>background-image: none;</code> into navbar&rsquo;s CSS definitions;</p></li>
<li><p>How to align text centering in a row: <code>text-align: center;</code>;</p></li>
<li><p>How to specify font properties, including font-family, font-size and font-weight;</p></li>
<li><p>How to add a image;</p></li>
</ul>


<p>Now build this page:</p>

<pre><code>$ meteor create searchHome
$ cd searchHome
$ ln -s ../client
$ tree
.
├── searchHome.css
├── searchHome.html
├── searchHome.js
├── client -&gt; ../client
└── public
    └── logo.png
$ tree client
client
├── css
│   └── bootstrap.min.css
└── lib
    └── bootstrap.min.js

$ cat &lt;&lt; EOF &gt; searchHome.html
&lt;head&gt;
  &lt;title&gt;NewFairs&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div class="container"&gt;
    
    
  &lt;/div&gt;

  &lt;div id="content" class="container"&gt;
    
  &lt;/div&gt;

  &lt;div id="footer"&gt;
    &lt;nav class="navbar navbar-fixed-bottom"&gt;
      &lt;div class="container" &gt;Here is the Footer&lt;/div&gt;
    &lt;/nav&gt;
  &lt;/div&gt;
&lt;/body&gt;

&lt;template name="header"&gt;
  &lt;div class="header" align="right"&gt;
    
    &lt;div class="btn-group"&gt;
      &lt;button type="button" class="btn btn-default"&gt;Action&lt;/button&gt;
      &lt;button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"&gt;
        &lt;span class="caret"&gt;&lt;/span&gt;
        &lt;span class="sr-only"&gt;Toggle Dropdown&lt;/span&gt;
      &lt;/button&gt;
      &lt;ul class="dropdown-menu" role="menu"&gt;
        &lt;li&gt;&lt;a href="#"&gt;汉语&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href="#"&gt;English&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;template name="simpleSearchBox"&gt;
  &lt;div class="fixed-search-form"&gt;
    &lt;div class="row logo"&gt;
      &lt;img src="http://leetschau.github.io/logo.png" alt="logo" /&gt;
      牛展网
    &lt;/div&gt;
    &lt;div class="row"&gt;
      &lt;input type="text"&gt;
      &lt;button&gt;搜索&lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;template name="hello"&gt;
  &lt;button id="addline"&gt;Add a line&lt;/button&gt;
  &lt;button id="rmline"&gt;Remove a line&lt;/button&gt;
  &lt;div&gt;
    
      &lt;li&gt;Item No: &lt;/li&gt;
    
  &lt;/div&gt;
&lt;/template&gt;
EOF

$ cat &lt;&lt; EOF &gt; searchHome.css
html {
  position: relative;
  min-height: 100%;
}

#content { padding-bottom: 70px; }

.fixed-search-form {
  margin: auto;
  position: absolute;
  top:0; left:0; bottom:0; right:0;
  height: 60%;
  width: 60%;
  text-align: center;
  font-size: x-large;
  font-family: Verdana,
               "Microsoft YaHei", "微软雅黑",
               "WenQuanYi Micro Hei";
}

.search-form .logo {
  font-size: 200%;
  font-weight: bold;
}

#footer .navbar {
  position: absolute;
  background-image: none;
}
EOF
</code></pre>

<p>Note1: the website logo image logo.png is created online, and download to local disk.
See note &ldquo;创建简单的网站Logo&rdquo; for details.</p>

<p>Note2: in &ldquo;font-family&rdquo;, &ldquo;Verdana&rdquo; is english font, &ldquo;Microsoft YaHei&rdquo; is Chinese font for Windows platform, &ldquo;WenQuanYi Micro Hei&rdquo; for Linux platform.
search and show this font with <code>aptitude search wqy</code>, <code>aptitude show fonts-wqy-microhei</code>.
See note &ldquo;Build Working Environment with i3 and Mint&rdquo; for details of this font on Linux.</p>

<p>Refs:</p>

<ul>
<li><p><a href="http://stackoverflow.com/questions/396145/how-to-vertically-center-a-div-for-all-browsers">How to vertically center a div for all browsers?</a></p></li>
<li><p><a href="http://www.ruanyifeng.com/blog/2014/07/chinese_fonts.html">中文字体网页开发指南</a></p></li>
<li><p><a href="http://www.ruanyifeng.com/blog/2008/06/typography_notes.html">字体笔记</a></p></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Meteor MongoDB Notes]]></title>
    <link href="http://leetschau.github.io/blog/2014/12/20/230618/"/>
    <updated>2014-12-20T23:06:18+08:00</updated>
    <id>http://leetschau.github.io/blog/2014/12/20/230618</id>
    <content type="html"><![CDATA[<ul>
<li><p>Connect to a mongodb of a Meteor app: run <code>meteor</code> at the project root. Start another shell, go to this folder, and run <code>meteor mongo</code>;</p></li>
<li><p>List all available commands: <code>help</code>;</p></li>
<li><p>List DB operation methods: <code>db.help()</code>;</p></li>
<li><p>List all existing collection names: <code>show collections</code>;</p></li>
<li><p>List all available commands of a collection: <code>db.&lt;collection-name&gt;.help()</code>;</p></li>
<li><p>Show collection information: <code>db.&lt;collection-name&gt;.stats()</code>;</p></li>
<li><p>Print all &ldquo;name&rdquo; field of collection &ldquo;fairs&rdquo;: <code>db.fairs.find({}, {name_chn: 1})</code>;</p></li>
<li><p>Print all fields except &ldquo;name_chn&rdquo; of collection &ldquo;fairs&rdquo;: <code>db.fairs.find({}, {products: 0})</code>;</p></li>
</ul>

]]></content>
  </entry>
  
</feed>
