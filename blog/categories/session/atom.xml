<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Session | Dark Matter in Cyberspace]]></title>
  <link href="http://leetschau.github.io/blog/categories/session/atom.xml" rel="self"/>
  <link href="http://leetschau.github.io/"/>
  <updated>2015-04-02T09:35:25+08:00</updated>
  <id>http://leetschau.github.io/</id>
  <author>
    <name><![CDATA[Li Chao]]></name>
    <email><![CDATA[leetschau@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[超链接中data-toggle属性使用新的Session]]></title>
    <link href="http://leetschau.github.io/blog/2015/02/18/105314/"/>
    <updated>2015-02-18T10:53:14+08:00</updated>
    <id>http://leetschau.github.io/blog/2015/02/18/105314</id>
    <content type="html"><![CDATA[<p>如果在超链接中将&#8221;data-toggle&#8221;属性设为&#8221;modal&#8221;，如下所示，则超链接所指向的窗体将使用新的Seesion。</p>

<pre><code>&lt;a href="http://leetschau.github.io/register" data-toggle="modal"&gt;注册新帐号&lt;/a&gt;
</code></pre>

<p>比如我们想在每次跳转后将当前url记录在Session变量&#8221;currentUrl&#8221;中，
但是在url以&#8221;login&#8221;和&#8221;register&#8221;结尾时不更新&#8221;currentUrl&#8221;：</p>

<pre><code>Router.onAfterAction(function(){
  if (! (Router.current() &amp;&amp; Router.current().url) ) {
    return;
  }
  var currentUrl = Router.current().url;
  if ( (currentUrl.indexOf('login') &lt; 0 ) &amp;&amp;
        currentUrl.indexOf("register") &lt; 0 ) {
    Session.set("currentUrl", currentUrl);
  }
});
</code></pre>

<p>然后在登录或者注册成功后取出这个缓存的变量，利用callback函数跳转回之前的页面：</p>

<pre><code>Accounts.createUser({
  email: t.find("#userEmail").value,
  password: t.find("#userPwd").value,
  profile: {
    nickname: t.find("#userNickname").value,
    role: userRole.value,
    gender: gender.value,
    desc: userDesc
  }
}, function(error) {
  if (error) {
    alert("something wrong, registration failed.");
  } else {
    alert("注册并登录成功！");
    var currentUrl = Session.get("currentUrl");
    var tmp = document.createElement('a');
    tmp.href = currentUrl;
    var currentPath = tmp.pathname + tmp.search;
    Router.go(currentPath);
  }
});
</code></pre>

<p>那么当点击上面的超链接时，所有Session对象都被清空，&#8221;currentUrl&#8221;值变为&#8221;undefined&#8221;，
如果用<code>Session.setDefault("currentUrl", "aabb");</code>设置默认值，
则点击上面的超链接后&#8221;currentUrl&#8221;值变为&#8221;aabb&#8221;，
然后再执行Router.onAfterAction中的callback函数。</p>

<p>这样前面利用缓存变量跳转回原来页面的设计就失效了，页面跳转到&#8221;/undefined&#8221;页面，
解决办法很简单：去掉超链接中的data-toggle属性，变为一个普通超链接：</p>

<pre><code>&lt;a href="http://leetschau.github.io/register"&gt;注册新帐号&lt;/a&gt;
</code></pre>
]]></content>
  </entry>
  
</feed>
